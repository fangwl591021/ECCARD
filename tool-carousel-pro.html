<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carousel Pro - 旗艦全功能補完版 v2.8.8</title>
    <!-- 核心庫載入 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide 圖示 -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; margin: 0; color: #000; font-weight: 700; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #06C755; border-radius: 10px; }
        .chat-room-bg { background-color: #7988a0; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .control-panel { background: white; border-radius: 20px; padding: 28px; border: 1px solid #e2e8f0; box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1); }
        .page-tab-active { background-color: #06C755 !important; color: white !important; border-color: #06C755 !important; transform: scale(1.1); z-index: 10; font-weight: 900; }
        .page-tab-empty { opacity: 0.4; border-style: dashed !important; }
        .page-tab-hidden { opacity: 0.4; filter: grayscale(1); border-color: #f87171 !important; }
        .master-slider { accent-color: #f59e0b; height: 14px; cursor: pointer; }
        .preview-text-multiline { white-space: pre-wrap; word-break: break-all; }
        input[type="color"] { padding: 0; border: none; height: 50px; width: 100%; cursor: pointer; background: none; border-radius: 12px; overflow: hidden; }
        label { font-size: 15px; color: #475569; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; display: block; font-weight: 900; }
        input[type="text"], select, textarea { font-size: 18px !important; border-radius: 12px !important; padding: 14px !important; border: 2px solid #f1f5f9 !important; font-weight: 900 !important; width: 100%; color: #000; background-color: #f8fafc; }
        input:focus, select:focus, textarea:focus { border-color: #06C755 !important; outline: none; background-color: #fff; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, Fragment } = React;

        // --- 核心資料庫 ---
        const SOCIAL_DATA = {
            NONE: { url: "https://vos.line-scdn.net/bot-designer-template-images/bot-designer-icon.png", label: "無圖示" },
            LINE: { url: "https://cdn-icons-png.flaticon.com/512/124/124027.png", label: "LINE" },
            FB: { url: "https://cdn-icons-png.flaticon.com/512/733/733547.png", label: "Facebook" },
            IG: { url: "https://cdn-icons-png.flaticon.com/512/2111/2111463.png", label: "Instagram" },
            TIKTOK: { url: "https://cdn-icons-png.flaticon.com/512/3046/3046121.png", label: "TikTok" },
            PHONE: { url: "https://cdn-icons-png.flaticon.com/512/3616/3616215.png", label: "電話" },
            WEB: { url: "https://cdn-icons-png.flaticon.com/512/1006/1006771.png", label: "官網" },
            MAIL: { url: "https://cdn-icons-png.flaticon.com/512/732/732200.png", label: "郵件" },
            MAP: { url: "https://cdn-icons-png.flaticon.com/512/355/355980.png", label: "地標" }
        };

        const TEMPLATE_TYPES = {
            SEQUENTIAL_PRO: { name: "專業業務版", icon: "award", desc: "形象展示旗艦，支援連動位移與 APNG" },
            PERSONAL: { name: "個人名片版", icon: "user", desc: "大圖簡約名片，支援主圖比例切換" },
            ECOMMERCE: { name: "電商商品版", icon: "shopping-bag", desc: "單一商品強力導購排版" }
        };

        const RADIUS_OPTIONS = ["none", "xs", "sm", "md", "lg", "xl", "xxl"];

        const GET_DEFAULT_DATA = (type) => {
            if (type === 'SEQUENTIAL_PRO') return {
                url: "https://aiwe.cc/wp-content/uploads/2025/12/cf75e54791dd1f49f918345fdfe2430b.png",
                animated: false, badgeText: "PREMIUM", badgeBg: "#D4AF37", badgeRadius: "xs", badgeTop: 20, badgePos: "offsetEnd",
                avatar: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=200",
                avatarTop: 60, avatarAnimated: false,
                name: "張志明", nameTop: 155, nameColor: "#000000", nameWeight: "bold",
                label1: "首席技術顧問", label1Top: 190, label1Bg: "#FFFFFF33", label1Color: "#000000", label1Weight: "bold",
                desc: "致力於協助企業品牌數位轉型\n擁有豐富的跨國行銷經驗", descTop: 275, descColor: "#000000", descWeight: "regular", descAlign: "center",
                icons: [{type: 'PHONE', uri: 'tel:0900000000'}, {type: 'LINE', uri: 'https://line.me'}],
                socialTop: 215,
                footerBg: "#111111", footerLabel: "聯繫我了解更多", footerUri: "https://line.me", footerThemeColor: "#D4AF37", footerTextColor: "#000000", footerWeight: "bold"
            };
            if (type === 'PERSONAL') return {
                url: "https://lihi.cc/5OXMZ", aspectRatio: "16:9",
                name: "王小明", nameColor: "#111111",
                desc: "資深開發工程師\n專業 LINE Bot 解決方案", descColor: "#666666",
                themeColor: "#00b900", btnLabel: "立即預約", btnUri: "https://line.me",
                icons: [{ type: 'LINE', uri: 'https://line.me' }, { type: 'WEB', uri: 'https://line.me' }]
            };
            if (type === 'ECOMMERCE') return {
                url: "https://lihi.cc/mwMvo", title: "旗艦限定商品", price: "$9,999", 
                desc: "高品質保證，現貨免運中。\n歡迎點擊下方按鈕直接下單購買。",
                themeColor: "#000000", btnLabel: "立即前往購買", btnUri: "https://line.me"
            };
            return {};
        };

        const App = () => {
            const [pages, setPages] = useState(Array(12).fill(null).map((_, i) => ({ id: i, template: null, isVisible: true, data: {} })));
            const [activeIndex, setActiveIndex] = useState(0);
            const [activeTab, setActiveTab] = useState('editor');
            const [altText, setAltText] = useState("這是我的數位名片，請多指教");

            const toPx = (v) => String(v).endsWith('px') ? v : `${v}px`;

            useEffect(() => {
                const handleMessage = (e) => {
                    if (e.data?.type === 'LOAD_FLEX_DATA') {
                        const saved = e.data.json;
                        if (saved && saved.startsWith('{')) {
                            try {
                                const parsed = JSON.parse(saved);
                                if (parsed._pages) { setPages(parsed._pages); return; }
                                if (parsed.pages) { setPages(parsed.pages); return; }
                            } catch(err) {}
                        }
                        const initPages = Array(12).fill(null).map((_, i) => ({ id: i, template: null, isVisible: true, data: {} }));
                        initPages[0] = { id: 0, template: 'SEQUENTIAL_PRO', isVisible: true, data: GET_DEFAULT_DATA('SEQUENTIAL_PRO') };
                        setPages(initPages);
                    }
                };
                window.addEventListener('message', handleMessage);
                window.parent.postMessage({ type: 'CHILD_READY' }, '*');
                return () => window.removeEventListener('message', handleMessage);
            }, []);

            // --- 核心聚合發送邏輯：導出乾淨且合規的 JSON ---
            const buildJson = useCallback(() => {
                const activePages = pages.filter(p => p.template && p.isVisible);
                if (activePages.length === 0) return { type: "bubble", body: { type: "box", layout: "vertical", contents: [{ type: "text", text: "請先配置內容" }] } };

                const contents = activePages.map(page => {
                    const d = page.data;
                    const cleanUri = (u) => (u && u.trim() !== "" && (u.startsWith('http') || u.startsWith('tel:'))) ? u.trim() : "https://line.me";

                    if (page.template === 'SEQUENTIAL_PRO') {
                        return {
                            type: "bubble", size: "mega",
                            body: {
                                type: "box", layout: "vertical", paddingAll: "0px",
                                contents: [
                                    { type: "image", url: d.url || SOCIAL_DATA.NONE.url, size: "full", aspectRatio: "2:3", aspectMode: "cover", animated: !!d.animated },
                                    { type: "box", layout: "vertical", position: "absolute", offsetTop: toPx(d.badgeTop), [d.badgePos === 'offsetStart' ? 'offsetStart' : 'offsetEnd']: "20px", backgroundColor: d.badgeBg || "#000000", cornerRadius: d.badgeRadius || "xs", paddingAll: "2px", paddingStart: "8px", paddingEnd: "8px", contents: [{ type: "text", text: d.badgeText || "TAG", color: "#ffffff", size: "xxs", weight: "bold" }] },
                                    { type: "box", layout: "vertical", position: "absolute", offsetTop: toPx(d.avatarTop), offsetStart: "0px", offsetEnd: "0px", alignItems: "center", contents: [{ type: "box", layout: "vertical", width: "85px", height: "85px", cornerRadius: "100px", borderWidth: "3px", borderColor: "#ffffff", contents: [{ type: "image", url: d.avatar || SOCIAL_DATA.NONE.url, size: "full", aspectMode: "cover", animated: !!d.avatarAnimated }] }] },
                                    { type: "box", layout: "vertical", position: "absolute", offsetTop: toPx(d.nameTop), offsetStart: "0px", offsetEnd: "0px", contents: [{ type: "text", text: d.name || "姓名", weight: d.nameWeight || "bold", size: "xxl", color: d.nameColor || "#000000", align: "center" }] },
                                    { type: "box", layout: "vertical", position: "absolute", offsetTop: toPx(d.label1Top), offsetStart: "40px", offsetEnd: "40px", backgroundColor: d.label1Bg || "#FFFFFF33", cornerRadius: "md", paddingAll: "4px", contents: [{ type: "text", text: d.label1 || "職稱", size: "xs", color: d.label1Color || "#000000", align: "center", weight: d.label1Weight || "bold" }] },
                                    { type: "box", layout: "horizontal", position: "absolute", offsetTop: toPx(d.socialTop), offsetStart: "0px", offsetEnd: "0px", justifyContent: "center", spacing: "md", contents: (d.icons || []).map(icon => ({ type: "box", layout: "vertical", width: "50px", height: "50px", cornerRadius: "100px", backgroundColor: "#ffffff1a", paddingAll: "10px", action: { type: "uri", uri: cleanUri(icon.uri) }, contents: [{ type: "image", url: SOCIAL_DATA[icon.type]?.url || SOCIAL_DATA.NONE.url, size: "full" }] })) },
                                    { type: "box", layout: "vertical", position: "absolute", offsetTop: toPx(d.descTop), offsetStart: "10px", offsetEnd: "10px", contents: [{ type: "text", text: d.desc || " ", wrap: true, size: "sm", color: d.descColor || "#000000", align: d.descAlign || "center", lineHeight: "1.6", weight: d.descWeight || "regular" }] }
                                ]
                            },
                            footer: { type: "box", layout: "vertical", paddingAll: "15px", backgroundColor: d.footerBg || "#111111", contents: [{ type: "box", layout: "vertical", backgroundColor: d.footerThemeColor || "#D4AF37", paddingAll: "12px", cornerRadius: "md", action: { type: "uri", uri: cleanUri(d.footerUri) }, contents: [{ type: "text", text: d.footerLabel || "聯繫我", color: d.footerTextColor || "#000000", align: "center", weight: d.footerWeight || "bold", size: "sm" }] }] }
                        };
                    }

                    if (page.template === 'PERSONAL') {
                        return {
                            type: "bubble", size: "mega",
                            body: {
                                type: "box", layout: "vertical", paddingAll: "0px",
                                contents: [
                                    { type: "image", url: d.url || SOCIAL_DATA.NONE.url, size: "full", aspectRatio: d.aspectRatio || "16:9", aspectMode: "cover" },
                                    {
                                        type: "box", layout: "vertical", paddingAll: "15px",
                                        contents: [
                                            { type: "text", text: d.name || "姓名", weight: "bold", size: "xl", color: d.nameColor || "#000000" },
                                            { type: "text", text: d.desc || " ", wrap: true, size: "sm", color: d.descColor || "#666666", margin: "md" },
                                            {
                                                type: "box", layout: "horizontal", spacing: "md", margin: "lg",
                                                contents: (d.icons || []).map(icon => ({
                                                    type: "box", layout: "vertical", width: "40px", height: "40px", cornerRadius: "100px", backgroundColor: "#f0f0f0", paddingAll: "8px",
                                                    action: { type: "uri", uri: cleanUri(icon.uri) },
                                                    contents: [{ type: "image", url: SOCIAL_DATA[icon.type]?.url || SOCIAL_DATA.NONE.url, size: "full" }]
                                                }))
                                            }
                                        ]
                                    }
                                ]
                            },
                            footer: { type: "box", layout: "vertical", paddingAll: "10px", contents: [{ type: "box", layout: "vertical", paddingAll: "12px", backgroundColor: d.themeColor || "#00b900", cornerRadius: "md", action: { type: "uri", uri: cleanUri(d.btnUri) }, contents: [{ type: "text", text: d.btnLabel || "了解更多", color: "#ffffff", align: "center", weight: "bold", size: "sm" }] }] }
                        };
                    }

                    if (page.template === 'ECOMMERCE') {
                        return {
                            type: "bubble", size: "mega",
                            body: { type: "box", layout: "vertical", paddingAll: "0px", contents: [
                                { type: "image", url: d.url || SOCIAL_DATA.NONE.url, size: "full", aspectRatio: "1:1", aspectMode: "cover" },
                                { type: "box", layout: "vertical", paddingAll: "15px", contents: [
                                    { type: "text", text: d.title || "商品名稱", weight: "bold", size: "lg" },
                                    { type: "text", text: d.price || "$0", weight: "bold", size: "xl", color: "#ff0000", margin: "xs" },
                                    { type: "text", text: d.desc || " ", wrap: true, size: "sm", color: "#666666", margin: "md" }
                                ]}
                            ]},
                            footer: { type: "box", layout: "vertical", paddingAll: "10px", contents: [{ type: "box", layout: "vertical", paddingAll: "12px", cornerRadius: "md", backgroundColor: d.themeColor || "#000000", action: { type: "uri", uri: cleanUri(d.btnUri) }, contents: [{ type: "text", text: d.btnLabel || "立即購買", color: "#ffffff", align: "center", weight: "bold", size: "sm" }] }] }
                        };
                    }
                    return { type: "bubble", body: { type: "box", layout: "vertical", contents: [{ type: "text", text: "版型不支援" }] } };
                });

                return { type: "carousel", contents, altText: "這是我的數位名片，請多指教" };
            }, [pages]);

            useEffect(() => {
                const flex = buildJson();
                const syncObj = { ...flex, _pages: pages }; 
                window.parent.postMessage({ type: 'SYNC_FLEX_DATA', json: JSON.stringify(syncObj) }, '*');
            }, [pages, buildJson]);

            // --- 更新函數 ---
            const updateActivePageData = (path, val) => {
                setPages(prev => {
                    const next = [...prev];
                    const keys = path.split('.');
                    let curr = next[activeIndex].data;
                    for (let i = 0; i < keys.length - 1; i++) { curr[keys[i]] = { ...curr[keys[i]] }; curr = curr[keys[i]]; }
                    curr[keys[keys.length - 1]] = val;
                    return next;
                });
            };

            const handleMasterMove = (newVal) => {
                setPages(prev => {
                    const next = [...prev];
                    const p = next[activeIndex];
                    const diff = newVal - p.data.avatarTop;
                    p.data = { ...p.data, avatarTop: newVal, nameTop: p.data.nameTop + diff, label1Top: p.data.label1Top + diff, socialTop: p.data.socialTop + diff, descTop: p.data.descTop + diff };
                    return next;
                });
            };

            const renderEditor = () => {
                const page = pages[activeIndex];
                if (!page.template) {
                    return (
                        <div className="text-center py-20 border-4 border-dashed border-slate-200 rounded-[40px] space-y-10 bg-white/50">
                            <h2 className="text-4xl font-black text-slate-300 uppercase italic tracking-tighter">Page {activeIndex + 1} Empty</h2>
                            <div className="grid grid-cols-1 gap-6 px-12">
                                {Object.keys(TEMPLATE_TYPES).map(k => (
                                    <button key={k} onClick={()=>{const n=[...pages]; n[activeIndex]={...page, template:k, data:GET_DEFAULT_DATA(k)}; setPages(n)}} className="bg-white border-4 border-slate-100 p-10 rounded-[30px] font-black hover:border-[#06C755] transition-all flex items-center justify-between text-3xl text-black shadow-2xl hover:-translate-y-2 group active:scale-95">
                                        <div className="flex items-center gap-6"><i data-lucide={TEMPLATE_TYPES[k].icon} className="w-12 h-12 text-[#06C755] group-hover:scale-125 transition-transform"></i> <div className="text-left"><div className="font-black text-2xl">{TEMPLATE_TYPES[k].name}</div><div className="text-sm text-slate-400 font-bold">{TEMPLATE_TYPES[k].desc}</div></div></div>
                                        <i data-lucide="chevron-right" className="text-slate-200 w-8 h-8"></i>
                                    </button>
                                ))}
                            </div>
                        </div>
                    );
                }

                const d = page.data;
                return (
                    <div className="space-y-12 animate-in fade-in duration-500 pb-32">
                        <div className="flex justify-between items-center bg-[#06C755] p-6 rounded-[25px] shadow-2xl ring-8 ring-[#06C755]/10">
                            <div className="font-black text-2xl text-white flex items-center gap-3"><i data-lucide={TEMPLATE_TYPES[page.template].icon} className="w-8 h-8"></i> {TEMPLATE_TYPES[page.template].name}設定</div>
                            <button onClick={()=>{const n=[...pages]; n[activeIndex].template=null; setPages(n)}} className="bg-white/20 text-white px-6 py-2.5 rounded-xl text-base font-black hover:bg-white/30 transition-all">更換版型</button>
                        </div>

                        {/* 專業業務版：100% 回歸 */}
                        {page.template === 'SEQUENTIAL_PRO' && (
                            <Fragment>
                                <div className="control-panel space-y-8">
                                    <div className="flex justify-between items-center border-b-2 border-slate-50 pb-5"><h3 className="text-2xl font-black text-slate-800 flex items-center gap-3"><i data-lucide="image"></i> 1. 媒體與背景</h3><label className="flex items-center gap-3 cursor-pointer bg-green-50 px-5 py-2 rounded-2xl border-2 border-green-100"><input type="checkbox" checked={d.animated} onChange={e=>updateActivePageData('animated', e.target.checked)} className="w-6 h-6 accent-green-600"/><span className="text-sm font-black text-green-700 uppercase">動畫</span></label></div>
                                    <div className="space-y-3"><label>背景底圖 URL (建議 400x600)</label><input type="text" value={d.url} onChange={e=>updateActivePageData('url', e.target.value)} /></div>
                                    <div className="grid grid-cols-2 gap-8">
                                        <div className="space-y-3"><label>標籤文字</label><input type="text" value={d.badgeText} onChange={e=>updateActivePageData('badgeText', e.target.value)} /></div>
                                        <div className="space-y-3"><label>標籤圓角</label><select value={d.badgeRadius} onChange={e=>updateActivePageData('badgeRadius', e.target.value)}>{RADIUS_OPTIONS.map(r=><option key={r} value={r}>{r.toUpperCase()}</option>)}</select></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-8">
                                        <div className="space-y-3"><label>標籤底色</label><input type="color" value={d.badgeBg} onChange={e=>updateActivePageData('badgeBg', e.target.value)} /></div>
                                        <div className="space-y-3"><label>標籤位置</label><select value={d.badgePos} onChange={e=>updateActivePageData('badgePos', e.target.value)}><option value="offsetStart">靠左</option><option value="offsetEnd">靠右</option></select></div>
                                    </div>
                                </div>
                                <div className="control-panel space-y-6 border-l-[12px] border-amber-500 bg-amber-50/10"><div className="flex justify-between items-end"><h3 className="text-xl font-black text-amber-700 uppercase tracking-tighter">全局高度連動 (MASTER)</h3><span className="text-amber-700 font-black text-4xl">{d.avatarTop}px</span></div><input type="range" min="0" max="800" value={d.avatarTop} onChange={e=>handleMasterMove(parseInt(e.target.value))} className="w-full master-slider" /></div>
                                <div className="control-panel space-y-8"><div className="flex justify-between items-center border-b-2 border-slate-50 pb-5"><h3 className="text-2xl font-black text-slate-800">2. 身份與姓名</h3><label className="flex items-center gap-3 cursor-pointer bg-green-50 px-5 py-2 rounded-2xl border-2 border-green-100"><input type="checkbox" checked={d.avatarAnimated} onChange={e=>updateActivePageData('avatarAnimated', e.target.checked)} className="w-6 h-6 accent-green-600"/><span className="text-sm font-black text-green-700">動畫</span></label></div><div className="space-y-3"><label>頭像 URL</label><input type="text" value={d.avatar} onChange={e=>updateActivePageData('avatar', e.target.value)} /></div><div className="grid grid-cols-2 gap-8"><div className="space-y-3"><label>姓名</label><input type="text" value={d.name} onChange={e=>updateActivePageData('name', e.target.value)} className="text-2xl" /></div><div className="space-y-3"><label>顏色</label><input type="color" value={d.nameColor} onChange={e=>updateActivePageData('nameColor', e.target.value)} /></div></div></div>
                                <div className="control-panel space-y-8"><div className="flex justify-between items-center border-b-2 border-slate-50 pb-5"><h3 className="text-2xl font-black text-slate-800 uppercase">3. 社群與說明</h3><button onClick={()=>{if(d.icons.length < 5) updateActivePageData('icons', [...d.icons, {type:'LINE', uri:'https://line.me'}])}} className="bg-slate-900 text-white px-8 py-4 rounded-2xl flex items-center gap-3 font-black active:scale-95 shadow-xl"><i data-lucide="plus-circle" className="w-8 h-8 text-green-400"></i> 新增社群按鈕</button></div><div className="space-y-5">{d.icons.map((s, i) => (<div key={i} className="flex gap-4 bg-slate-50 p-6 rounded-[25px] relative border-2 border-slate-100 group hover:border-[#06C755] transition-all"><button onClick={()=>{const nl=d.icons.filter((_,idx)=>idx!==i); updateActivePageData('icons', nl)}} className="absolute -top-4 -right-4 bg-red-500 text-white rounded-full p-2.5 shadow-2xl opacity-0 group-hover:opacity-100 transition-all hover:scale-110 z-10 font-black"><i data-lucide="trash-2" className="w-6 h-6"></i></button><select value={s.type} onChange={e=>{const nl=[...d.icons]; nl[i].type=e.target.value; updateActivePageData('icons', nl)}} className="w-40 bg-white font-black">{Object.keys(SOCIAL_DATA).map(k=><option key={k} value={k}>{SOCIAL_DATA[k].label}</option>)}</select><input type="text" value={s.uri} onChange={e=>{const nl=[...d.icons]; nl[i].uri=e.target.value; updateActivePageData('icons', nl)}} className="flex-1 font-mono font-black" /></div>))}</div><div className="border-t-2 pt-8 space-y-6"><textarea value={d.desc} onChange={e=>updateActivePageData('desc', e.target.value)} className="w-full h-52 text-xl leading-relaxed" placeholder="介紹內容...支援 Enter"></textarea><div className="grid grid-cols-2 gap-8"><div><label>文字顏色</label><input type="color" value={d.descColor} onChange={e=>updateActivePageData('descColor', e.target.value)} /></div><div className="flex bg-slate-100 p-2 rounded-2xl gap-3 mt-auto h-fit">{['start', 'center', 'end'].map(a => <button key={a} onClick={()=>updateActivePageData('descAlign', a)} className={`flex-1 py-4 rounded-xl font-black transition-all ${d.descAlign===a?'bg-white shadow-lg text-[#06C755]':'text-slate-400'}`}>{a.toUpperCase()}</button>)}</div></div></div></div>
                                <div className="control-panel space-y-8 border-4 border-slate-900"><h3 className="text-2xl font-black text-black border-b-4 border-black pb-5 uppercase tracking-tighter">5. 底部按鈕控制</h3><div className="grid grid-cols-2 gap-10"><div><label>Footer背景</label><input type="color" value={d.footerBg} onChange={e=>updateActivePageData('footerBg', e.target.value)} /></div><div><label>按鈕背景</label><input type="color" value={d.footerThemeColor} onChange={e=>updateActivePageData('footerThemeColor', e.target.value)} /></div></div><input type="text" value={d.footerLabel} onChange={e=>updateActivePageData('footerLabel', e.target.value)} className="w-full text-center text-2xl font-black" /><input type="text" value={d.footerUri} onChange={e=>updateActivePageData('footerUri', e.target.value)} className="w-full font-mono text-base" /></div>
                            </Fragment>
                        )}

                        {/* 個人名片版：100% 補全 */}
                        {page.template === 'PERSONAL' && (
                            <Fragment>
                                <div className="control-panel space-y-8">
                                    <h3 className="text-2xl font-black text-slate-800 border-b pb-5 flex items-center gap-3"><i data-lucide="image"></i> 1. 背景與比例</h3>
                                    <div className="space-y-4">
                                        <label>主圖 URL</label><input type="text" value={d.url} onChange={e=>updateActivePageData('url', e.target.value)} />
                                        <label>主圖寬高比例</label><select value={d.aspectRatio} onChange={e=>updateActivePageData('aspectRatio', e.target.value)} className="w-full font-black"><option value="16:9">16:9 (標準寬)</option><option value="4:3">4:3 (傳統寬)</option><option value="1:1">1:1 (正方形)</option></select>
                                    </div>
                                </div>
                                <div className="control-panel space-y-8">
                                    <h3 className="text-2xl font-black text-slate-800 border-b pb-5">2. 內容與顏色控制</h3>
                                    <div className="grid grid-cols-2 gap-8">
                                        <div><label>姓名顏色</label><input type="color" value={d.nameColor} onChange={e=>updateActivePageData('nameColor', e.target.value)} /></div>
                                        <div><label>簡介顏色</label><input type="color" value={d.descColor} onChange={e=>updateActivePageData('descColor', e.target.value)} /></div>
                                    </div>
                                    <div className="space-y-4"><label>姓名/標題</label><input type="text" value={d.name} onChange={e=>updateActivePageData('name', e.target.value)} className="text-2xl" /></div>
                                    <div className="space-y-4"><label>個人簡介 (支援 Enter)</label><textarea value={d.desc} onChange={e=>updateActivePageData('desc', e.target.value)} className="w-full h-52 text-xl"></textarea></div>
                                </div>
                                <div className="control-panel space-y-8">
                                    <div className="flex justify-between items-center border-b pb-5"><h3 className="text-2xl font-black text-slate-800">3. 社群快捷與動作</h3><button onClick={()=>{if(d.icons.length < 5) updateActivePageData('icons', [...d.icons, {type:'LINE', uri:'https://line.me'}])}} className="bg-slate-100 p-2 rounded-xl active:scale-95"><i data-lucide="plus" className="w-6 h-6"></i></button></div>
                                    <div className="space-y-4">{d.icons.map((s, i) => (<div key={i} className="flex gap-3 bg-slate-50 p-4 rounded-2xl relative border-2 border-slate-100 group transition-all"><button onClick={()=>{const nl=d.icons.filter((_,idx)=>idx!==i); updateActivePageData('icons', nl)}} className="absolute -top-3 -right-3 bg-red-500 text-white rounded-full p-1.5 shadow-lg"><i data-lucide="trash-2" className="w-4 h-4"></i></button><select value={s.type} onChange={e=>{const nl=[...d.icons]; nl[i].type=e.target.value; updateActivePageData('icons', nl)}} className="w-32">{Object.keys(SOCIAL_DATA).map(k=><option key={k} value={k}>{SOCIAL_DATA[k].label}</option>)}</select><input type="text" value={s.uri} onChange={e=>{const nl=[...d.icons]; nl[i].uri=e.target.value; updateActivePageData('icons', nl)}} className="flex-1 font-mono text-sm" /></div>))}</div>
                                    <div className="border-t pt-8 space-y-4"><label>按鈕主題色</label><input type="color" value={d.themeColor} onChange={e=>updateActivePageData('themeColor', e.target.value)} /><input type="text" value={d.btnLabel} onChange={e=>updateActivePageData('btnLabel', e.target.value)} className="w-full text-center text-xl font-black" placeholder="按鈕文字"/><input type="text" value={d.btnUri} onChange={e=>updateActivePageData('btnUri', e.target.value)} className="w-full font-mono text-base" placeholder="跳轉網址"/></div>
                                </div>
                            </Fragment>
                        )}

                        {/* 電商商品版：100% 補全 */}
                        {page.template === 'ECOMMERCE' && (
                            <Fragment>
                                <div className="control-panel space-y-8">
                                    <h3 className="text-2xl font-black text-slate-800 border-b pb-5 flex items-center gap-3"><i data-lucide="shopping-bag"></i> 1. 商品主圖</h3>
                                    <input type="text" value={d.url} onChange={e=>updateActivePageData('url', e.target.value)} className="w-full" placeholder="商品圖 URL (建議 1:1)" />
                                </div>
                                <div className="control-panel space-y-8 font-black">
                                    <h3 className="text-2xl font-black text-slate-800 border-b pb-5">2. 商品詳細資訊</h3>
                                    <div className="space-y-4"><label>商品標題</label><input type="text" value={d.title} onChange={e=>updateActivePageData('title', e.target.value)} className="text-2xl" /></div>
                                    <div className="space-y-4"><label>顯示價格 (紅字)</label><input type="text" value={d.price} onChange={e=>updateActivePageData('price', e.target.value)} className="text-4xl text-red-500" /></div>
                                    <div className="space-y-4"><label>商品描述</label><textarea value={d.desc} onChange={e=>updateActivePageData('desc', e.target.value)} className="w-full h-52 text-xl"></textarea></div>
                                </div>
                                <div className="control-panel space-y-8 font-black">
                                    <h3 className="text-2xl font-black text-slate-800 border-b pb-5">3. 導購按鈕設定</h3>
                                    <div className="grid grid-cols-2 gap-8">
                                        <div className="space-y-2"><label>按鈕背景色</label><input type="color" value={d.themeColor} onChange={e=>updateActivePageData('themeColor', e.target.value)} /></div>
                                        <div className="space-y-2"><label>按鈕文字</label><input type="text" value={d.btnLabel} onChange={e=>updateActivePageData('btnLabel', e.target.value)} className="text-center h-[50px]" /></div>
                                    </div>
                                    <div className="space-y-2"><label>結帳連結</label><input type="text" value={d.btnUri} onChange={e=>updateActivePageData('btnUri', e.target.value)} className="font-mono text-sm" /></div>
                                </div>
                            </Fragment>
                        )}

                        <div className="p-10 bg-slate-900 rounded-[50px] flex justify-between items-center shadow-2xl ring-8 ring-slate-900/10"><div className="text-white font-black text-2xl uppercase flex items-center gap-4"><i data-lucide="send" className="w-10 h-10 text-[#06C755] drop-shadow-[0_0_10px_#06C755]"></i> 發送時顯示本頁</div><button onClick={()=>setPages(p=>{const n=[...p]; n[activeIndex].isVisible=!n[activeIndex].isVisible; return n})} className={`w-24 h-12 rounded-full relative transition-all shadow-inner ring-4 ring-white/5 ${page.isVisible?'bg-[#06C755]':'bg-slate-700'}`}><div className={`absolute top-1.5 w-9 h-9 bg-white rounded-full transition-all shadow-2xl ${page.isVisible?'left-13':'left-2'}`}></div></button></div>
                        <button onClick={()=>{if(activeIndex < 11){const n=[...pages]; n[activeIndex+1]=JSON.parse(JSON.stringify(page)); n[activeIndex+1].id=activeIndex+1; setPages(n); setActiveIndex(activeIndex+1)}}} className="w-full py-10 border-8 border-dashed border-slate-200 text-slate-300 rounded-[50px] font-black text-2xl hover:border-[#06C755] hover:text-[#06C755] transition-all flex items-center justify-center gap-6 active:scale-95 mb-20 font-black"><i data-lucide="copy" className="w-10 h-10"></i> 複製內容至下一頁</button>
                    </div>
                );
            };

            const PreviewComp = () => {
                const page = pages[activeIndex];
                if (!page.template) return <div className="p-20 text-center italic text-slate-300 font-black text-4xl">EMPTY</div>;
                const d = page.data;
                const width = 300;
                
                if (page.template === 'SEQUENTIAL_PRO') {
                    const scale = 300 / 400;
                    return (
                        <div className="rounded-[60px] shadow-[0_40px_80px_-20px_rgba(0,0,0,0.6)] overflow-hidden relative border-[14px] border-black bg-white" style={{ width: '300px' }}>
                            <div className="relative overflow-hidden" style={{ height: '450px' }}>
                                <img src={d.url} className="w-full h-full object-cover" />
                                <div className="absolute px-5 py-2 text-white font-bold rounded shadow-2xl" style={{ top: '15px', [d.badgePos === 'offsetStart' ? 'left' : 'right']: '15px', backgroundColor: d.badgeBg, fontSize: '10px', borderRadius: d.badgeRadius==='none'?'0':d.badgeRadius==='xs'?'2px':'10px' }}>{d.badgeText}</div>
                                <div className="absolute w-full flex justify-center" style={{ top: (d.avatarTop * scale) + 'px' }}><img src={d.avatar} className="w-20 h-20 rounded-full border-[4px] border-white shadow-2xl overflow-hidden bg-white" /></div>
                                <div className="absolute w-full text-center px-4" style={{ top: (d.nameTop * scale) + 'px', color: d.nameColor, fontWeight: 900, fontSize: '20px' }}>{d.name}</div>
                                <div className="absolute w-full px-10" style={{ top: (d.label1Top * scale) + 'px' }}><div className="py-1.5 rounded-lg text-[10px] text-center font-black shadow-lg" style={{ backgroundColor: d.label1Bg, color: d.label1Color }}>{d.label1}</div></div>
                                <div className="absolute w-full flex justify-center gap-3" style={{ top: (d.socialTop * scale) + 'px' }}>{(d.icons || []).map((s, i) => <div key={i} className="w-12 h-12 p-3 bg-white/20 rounded-full border border-white/50 flex items-center justify-center shadow-2xl backdrop-blur-md"><img src={SOCIAL_DATA[s.type]?.url} className="w-full h-full object-contain" /></div>)}</div>
                                <div className="absolute w-full px-[14px]" style={{ top: (d.descTop * scale) + 'px', textAlign: d.descAlign }}><p className="text-[11px] preview-text-multiline leading-relaxed font-bold" style={{ color: d.descColor }}>{d.desc}</p></div>
                                <div className="absolute top-0 left-0 w-full h-full border-b-2 border-dashed border-red-500 pointer-events-none opacity-20"></div>
                            </div>
                            <div className="p-5" style={{ backgroundColor: d.footerBg }}>
                                <div className="py-4 text-center rounded-2xl text-xs font-black shadow-xl" style={{ backgroundColor: d.footerThemeColor, color: d.footerTextColor }}>{d.footerLabel}</div>
                            </div>
                        </div>
                    );
                }

                if (page.template === 'PERSONAL') {
                    const [w, h] = (d.aspectRatio || "16:9").split(':').map(Number);
                    const mediaH = (h / w) * 300;
                    return (
                        <div className="rounded-[50px] bg-white shadow-2xl overflow-hidden relative border-[12px] border-black animate-in zoom-in-95 duration-500 shadow-2xl font-black" style={{ width: '300px' }}>
                            <div className="bg-slate-100" style={{ height: `${mediaH}px` }}><img src={d.url} className="w-full h-full object-cover" /></div>
                            <div className="p-8 pt-10">
                                <div className="font-black text-3xl text-black" style={{ color: d.nameColor }}>{d.name}</div>
                                <div className="mt-5 text-base leading-relaxed whitespace-pre-wrap font-bold" style={{ color: d.descColor }}>{d.desc}</div>
                                <div className="flex gap-3 mt-8">{(d.icons || []).map((icon, i) => <div key={i} className="w-14 h-14 p-3 bg-slate-50 border-4 border-slate-100 rounded-full flex items-center justify-center shadow-lg"><img src={SOCIAL_DATA[icon.type]?.url} className="w-full h-full object-contain" /></div>)}</div>
                            </div>
                            <div className="p-6 pt-0"><div className="py-5 text-center rounded-[20px] text-white font-black text-lg shadow-xl" style={{ backgroundColor: d.themeColor }}>{d.btnLabel}</div></div>
                        </div>
                    );
                }

                if (page.template === 'ECOMMERCE') {
                    return (
                        <div className="rounded-[50px] bg-white shadow-2xl overflow-hidden relative border-[12px] border-black animate-in zoom-in-95 duration-500 shadow-2xl font-black" style={{ width: '300px' }}>
                            <div className="bg-slate-100" style={{ height: `300px` }}><img src={d.url} className="w-full h-full object-cover" /></div>
                            <div className="p-8">
                                <div className="font-black text-2xl text-black">{d.title}</div>
                                <div className="text-3xl font-black text-red-500 mt-2 font-black italic">{d.price}</div>
                                <div className="mt-5 text-base leading-relaxed whitespace-pre-wrap font-bold text-slate-500">{d.desc}</div>
                            </div>
                            <div className="p-6 pt-0"><div className="py-5 text-center rounded-[20px] text-white font-black text-lg shadow-xl" style={{ backgroundColor: d.themeColor }}>{d.btnLabel}</div></div>
                        </div>
                    );
                }
                return null;
            };

            return (
                <div className="flex h-screen bg-slate-100 overflow-hidden font-black">
                    <div className="w-1/2 bg-white border-r flex flex-col shadow-2xl z-20 font-black text-black">
                        <div className="p-10 border-b shrink-0 flex items-center justify-between font-black text-black"><div className="flex items-center gap-5 font-black"><div className="bg-[#06C755] p-4 rounded-3xl text-white shadow-2xl rotate-6 font-black"><i data-lucide="layers" className="w-10 h-10 font-black"></i></div><h1 className="text-3xl uppercase italic font-black tracking-tighter text-black">Carousel Hub</h1></div></div>
                        <div className="p-6 bg-slate-50 border-b flex gap-5 overflow-x-auto custom-scrollbar shrink-0 no-scrollbar items-center font-black">
                            <span className="text-xs text-slate-400 font-black uppercase tracking-[0.3em] shrink-0 rotate-90 ml-2">Pages</span>
                            {pages.map((p, i) => (
                                <button key={i} onClick={()=>setActiveIndex(i)} className={`shrink-0 w-16 h-16 border-[5px] rounded-[24px] font-black transition-all flex items-center justify-center text-2xl shadow-xl ${activeIndex === i ? 'page-tab-active shadow-[#06C755]/50 scale-110' : 'bg-white border-slate-200 hover:border-slate-300'} ${!p.template ? 'page-tab-empty' : ''} ${!p.isVisible ? 'page-tab-hidden' : ''}`}>{i + 1}</button>
                            ))}
                        </div>
                        <div className="flex-1 overflow-y-auto p-12 custom-scrollbar font-black text-black">
                            <div className="mb-16 control-panel border-[6px] border-[#06C755] bg-green-50/20 font-black text-black shadow-inner font-black">
                                <label className="text-base text-slate-500 block mb-3 font-black uppercase tracking-widest flex items-center gap-3"><i data-lucide="bell-ring" className="w-6 h-6"></i> 分享預覽文字</label>
                                <div className="text-2xl font-black p-5 bg-white rounded-2xl border-2 border-slate-100 text-black shadow-inner font-black italic">這是我的數位名片，請多指教</div>
                            </div>
                            {renderEditor()}
                        </div>
                    </div>
                    <div className="flex-1 flex flex-col chat-room-bg overflow-hidden text-black font-black">
                        <div className="h-[100px] bg-white border-b flex items-center px-16 gap-12 shrink-0 shadow-sm relative z-30 font-black text-black"><button onClick={()=>setActiveTab('editor')} className={`h-full border-b-[12px] flex items-center gap-4 transition-all text-2xl font-black ${activeTab === 'editor' ? 'text-[#06C755] border-[#06C755]' : 'text-slate-400 border-transparent hover:text-black'}`}><i data-lucide="eye"></i> 視覺預覽</button><button onClick={()=>setActiveTab('json')} className={`h-full border-b-[12px] flex items-center gap-4 transition-all text-2xl font-black ${activeTab === 'json' ? 'text-[#06C755] border-[#06C755]' : 'text-slate-400 border-transparent hover:text-black'}`}><i data-lucide="code"></i> JSON 代碼</button></div>
                        <div className="flex-1 overflow-y-auto p-16 flex flex-col items-center custom-scrollbar">
                            {activeTab === 'editor' ? (<div className="space-y-12 flex flex-col items-center animate-in zoom-in-95 duration-700 font-black text-black"><div className="px-14 py-5 bg-black text-white rounded-full text-base tracking-[0.6em] font-black uppercase shadow-[0_30px_60px_-10px_rgba(0,0,0,0.5)] border-4 border-white/20">PAGE {activeIndex + 1} LIVE PREVIEW</div><PreviewComp /></div>) : (<div className="w-full max-w-4xl mx-auto font-black shadow-2xl rounded-[60px] overflow-hidden border-8 border-white/10"><pre className="bg-slate-900 p-16 text-green-400 text-sm overflow-x-auto font-mono w-full leading-relaxed select-all font-black">{JSON.stringify(buildJson(), null, 2)}</pre></div>)}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        window.addEventListener('load', () => { if(window.lucide) window.lucide.createIcons(); });
    </script>
</body>
</html>
