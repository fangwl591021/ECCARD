<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLEX Carousel Pro - 600px 高度鎖定版 v5.2.4</title>
    <!-- 核心庫載入 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide 圖示載入 -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; margin: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #06C755; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .chat-room-bg { background-color: #7988a0; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .control-panel { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; margin-bottom: 1.5rem; }
        .panel-header { background: linear-gradient(135deg, #06C755 0%, #00A648 100%); padding: 12px 16px; color: white; font-weight: 900; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .panel-content { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .sticky-section { position: sticky; top: 0; background: white; z-index: 50; padding: 15px 20px; border-bottom: 1px solid #e2e8f0; }
        .page-tab-active { border-color: #06C755 !important; color: #06C755 !important; background: #f0fdf4 !important; transform: scale(1.05); z-index: 10; }
        /* 預覽容器設定為 600px 比例 (300x600) */
        .preview-bubble { border-radius: 40px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 8px solid #000; background: #fff; width: 300px; height: 600px; position: relative; flex-shrink: 0; }
        input, select, textarea { font-size: 13px !important; border-radius: 8px; border: 1px solid #e2e8f0; padding: 8px; width: 100%; outline: none; transition: border 0.2s; }
        input:focus { border-color: #06C755; }
        input[type="color"] { height: 38px; padding: 2px; cursor: pointer; }
        .preview-text-multiline { white-space: pre-wrap; word-break: break-all; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, memo } = React;

        const SOCIAL_DATA = {
            NONE: { url: "https://vos.line-scdn.net/bot-designer-template-images/bot-designer-icon.png", label: "無圖示", defaultUri: "https://" },
            FB: { url: "https://cdn-icons-png.flaticon.com/512/733/733547.png", label: "Facebook", defaultUri: "https://facebook.com/" },
            IG: { url: "https://cdn-icons-png.flaticon.com/512/2111/2111463.png", label: "Instagram", defaultUri: "https://instagram.com/" },
            LINE: { url: "https://cdn-icons-png.flaticon.com/512/124/124027.png", label: "LINE", defaultUri: "https://line.me" },
            PHONE: { url: "https://cdn-icons-png.flaticon.com/512/3616/3616215.png", label: "電話", defaultUri: "tel:0912345678" },
            WEB: { url: "https://cdn-icons-png.flaticon.com/512/1006/1006771.png", label: "官網", defaultUri: "https://" }
        };

        const Utils = {
            toPx: (v) => {
                const num = Math.round(parseFloat(v));
                return isNaN(num) ? "0px" : `${num}px`;
            },
            deepCopy: (o) => JSON.parse(JSON.stringify(o))
        };

        // --- 核心組件 ---
        const ControlPanel = ({ title, icon, children, headerClass = "" }) => (
            <div className="control-panel shadow-sm font-black text-slate-800">
                <div className={`panel-header ${headerClass}`}><i data-lucide={icon} className="w-4 h-4"></i><span>{title}</span></div>
                <div className="panel-content">{children}</div>
            </div>
        );

        const AlignButtons = ({ value, onChange }) => (
            <div className="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
                {['start', 'center', 'end'].map(id => (
                    <button key={id} onClick={() => onChange(id)} className={`flex-1 flex justify-center py-1.5 rounded-md transition-all ${value === id ? 'bg-white shadow-sm text-emerald-600' : 'text-slate-400'}`}>
                        <i data-lucide={id === 'start' ? 'align-left' : id === 'center' ? 'align-center' : 'align-right'} className="w-4 h-4"></i>
                    </button>
                ))}
            </div>
        );

        // --- 核心初始模板 ---
        const TEMPLATE_P1 = {
            model: "BUSINESS_CORE", url: "https://aiwe.cc/wp-content/uploads/2025/12/cf75e54791dd1f49f918345fdfe2430b.png",
            badgeText: "HOT ITEM", badgeBg: "#FF0000", badgeTop: 10, badgePos: "offsetEnd",
            avatar: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=200", avatarTop: 45,
            name: "張志明", nameTop: 140, nameColor: "#000000", nameWeight: "bold", nameAlign: "center",
            socialTop: 170, // 已調整：靠近姓名
            icons: [{ type: "PHONE", uri: "tel:0912345678" }, { type: "LINE", uri: "https://line.me" }],
            desc: "致力協助企業數位轉型\n提供最專業的品牌顧問服務", descTop: 215, descColor: "#000000", descWeight: "regular", descAlign: "center",
            footerBg: "#111111", footerLabel: "聯繫我了解更多", footerUri: "https://line.me", footerThemeColor: "#06C755", footerTextColor: "#FFFFFF"
        };

        const TEMPLATE_P2 = {
            model: "PERSONAL_CORE", size: "mega", mediaType: "image",
            videoConfig: { url: "https://lihi.cc/YsmAp", previewUrl: "https://lihi.cc/5OXMZ" },
            media: { url: "https://lihi.cc/5OXMZ", aspectRatio: "20:13", badgeText: "精選推薦", badgeBg: "#10b981", badgePos: "left" },
            avatar: { show: true, url: "https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=200", borderColor: "#ffffff", cornerRadius: "100px" },
            content: { name: "陳大文", nameAlign: "start", nameColor: "#0f172a", desc: "專業 LINE Bot 解決方案\n提供最流暢的互動體驗", descAlign: "start", descColor: "#475569" },
            footer: { longBtns: [{ label: "立即預約", uri: "https://line.me", themeColor: "#10b981", textColor: "#ffffff", isSolid: true }], shortBtns: [{ type: "PHONE", label: "電話", uri: "tel:0912345678", themeColor: "#f1f5f9", textColor: "#444444", isSolid: true }, { type: "LINE", label: "LINE", uri: "https://line.me", themeColor: "#f1f5f9", textColor: "#444444", isSolid: true }] }
        };

        const TEMPLATE_P3 = {
            model: "ECOMMERCE_CORE",
            hero: { type: 'image', url: "https://lihi.cc/5OXMZ", aspectRatio: '20:13', videoUrl: "", link: "https://line.me" },
            body: { columns: 3, bgColor: "#F8F8F8", tagBgColor: "#0D0D0D", tagTextColor: "#FFFFFF", items: [{ title: "商品 A", img: "https://lihi.cc/mwMvo", url: "https://line.me" }, { title: "商品 B", img: "https://lihi.cc/2Nu8G", url: "https://line.me" }, { title: "商品 C", img: "https://lihi.cc/yRfpn", url: "https://line.me" }] },
            footer: { bg: "#ffffff", btn1: { label: "品牌故事", color: "#000000", textColor: "#FFFFFF", uri: "https://line.me" }, btn2: { label: "好友分享", color: "#000000", textColor: "#FFFFFF", uri: "line://nv/recommendOA/@754tjssx" } }
        };

        // --- 視覺預覽 ---
        const FlexPreview = memo(({ data }) => {
            const d = data;
            const scale = 300 / 400;

            if (d.model === 'BUSINESS_CORE') {
                return (
                    <div className="preview-bubble flex flex-col font-black">
                        <div className="relative flex-1 overflow-hidden bg-white">
                            {d.url !== 'none' && <img src={d.url} className="w-full h-full object-cover" />}
                            <div className="absolute px-3 text-white font-bold text-[10px] flex items-center justify-center" style={{ top: '10px', [d.badgePos === 'offsetStart' ? 'left' : 'right']: '10px', backgroundColor: d.badgeBg, borderRadius: '15px', height: '25px', minWidth: '50px' }}>{d.badgeText}</div>
                            <div className="absolute w-full flex justify-center" style={{ top: (d.avatarTop * scale) + 'px' }}><img src={d.avatar} className="w-16 h-16 rounded-full border-2 border-white shadow-xl object-cover" /></div>
                            <div className="absolute w-full px-4" style={{ top: (d.nameTop * scale) + 'px', color: d.nameColor, textAlign: d.nameAlign, fontSize: '18px' }}>{d.name}</div>
                            <div className="absolute w-full flex justify-center gap-2" style={{ top: (d.socialTop * scale) + 'px' }}>{(d.icons || []).map((icon, i) => (<div key={i} className="w-9 h-9 p-2 bg-white/25 rounded-full border border-white/40 flex items-center justify-center backdrop-blur-sm"><img src={SOCIAL_DATA[icon.type]?.url} className="w-full h-full object-contain" /></div>))}</div>
                            <div className="absolute w-full px-5" style={{ top: (d.descTop * scale) + 'px', textAlign: d.descAlign, color: d.descColor, fontSize: '12px' }}><p className="preview-text-multiline leading-relaxed">{d.desc}</p></div>
                        </div>
                        <div className="h-[80px] shrink-0 border-t flex items-center justify-center px-4" style={{ backgroundColor: d.footerBg }}><div className="w-full py-3 text-center rounded-xl text-[13px] font-black" style={{ backgroundColor: d.footerThemeColor, color: d.footerTextColor }}>{d.footerLabel}</div></div>
                    </div>
                );
            }

            if (d.model === 'PERSONAL_CORE') {
                const [w, h] = d.media.aspectRatio.split(':').map(Number);
                const mediaH = Math.min((h / w) * 300, 200);
                const avatarOff = d.mediaType === 'video' ? mediaH + 10 : mediaH - 45;
                return (
                    <div className="preview-bubble flex flex-col font-black relative bg-white">
                        <div className="relative bg-black shrink-0" style={{ height: `${mediaH}px` }}>
                            {d.mediaType === 'image' ? <img src={d.media.url} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center bg-slate-900"><i data-lucide="play" className="w-10 h-10 text-white opacity-60"></i></div>}
                        </div>
                        <div className="flex-1 p-4 overflow-hidden relative bg-white" style={{ paddingTop: d.avatar.show ? '55px' : '15px' }}>
                            <div className="font-bold text-lg" style={{ textAlign: d.content.nameAlign, color: d.content.nameColor }}>{d.content.name}</div>
                            <div className="mt-1 text-[13px] leading-snug text-slate-500 overflow-hidden" style={{ textAlign: d.content.descAlign }}>{d.content.desc}</div>
                        </div>
                        {d.avatar.show && <div className="absolute w-full flex justify-center transition-all" style={{ top: `${avatarOff}px`, zIndex: 30 }}><img src={d.avatar.url} className="w-20 h-20 rounded-full border-[3px] border-white shadow-xl object-cover bg-white" style={{ borderRadius: d.avatar.cornerRadius === '100px' ? '50%' : '12px' }} /></div>}
                        <div className="h-[80px] shrink-0 border-t flex flex-col justify-center px-4 bg-white">{(d.footer.longBtns || []).slice(0,1).map((btn, i) => <div key={i} className="py-2.5 text-center rounded-md font-bold text-xs" style={{ backgroundColor: btn.isSolid ? btn.themeColor : 'transparent', border: `1px solid ${btn.themeColor}`, color: btn.textColor }}>{btn.label}</div>)}</div>
                    </div>
                );
            }

            if (d.model === 'ECOMMERCE_CORE') {
                return (
                    <div className="preview-bubble flex flex-col font-black bg-white">
                        <div className="relative w-full bg-black shrink-0 overflow-hidden" style={{ height: '160px' }}><img src={d.hero.url} className="w-full h-full object-cover opacity-80" /></div>
                        <div className="flex-1 p-3 overflow-hidden bg-white" style={{ backgroundColor: d.body.bgColor }}><div className={`grid gap-2 ${d.body.columns === 3 ? 'grid-cols-3' : 'grid-cols-4'}`}>{(d.body.items || []).map((item, i) => (
                            <div key={i} className="bg-white rounded-lg p-1 border border-slate-100 flex flex-col h-fit shadow-sm"><div className="aspect-square rounded-sm overflow-hidden mb-1 bg-slate-100"><img src={item.img} className="w-full h-full object-cover" /></div><div style={{ backgroundColor: d.body.tagBgColor, color: d.body.tagTextColor }} className="text-[8px] font-bold text-center py-1 rounded-sm truncate">{item.title}</div></div>
                        ))}</div></div>
                        <div className="h-[80px] shrink-0 border-t bg-white flex items-center px-3 gap-2" style={{ backgroundColor: d.footer.bg }}>{['btn1', 'btn2'].map(k => <div key={k} className="flex-1 py-3 rounded-xl text-center font-bold text-[11px] text-white shadow-sm" style={{ backgroundColor: d.footer[k].color, color: d.footer[k].textColor }}>{d.footer[k].label}</div>)}</div>
                    </div>
                );
            }
        });

        // --- 主應用 ---
        const App = () => {
            const [pages, setPages] = useState([TEMPLATE_P1, Utils.deepCopy(TEMPLATE_P2), Utils.deepCopy(TEMPLATE_P3)]);
            const [activeIdx, setActiveIdx] = useState(0);
            const [activeTab, setActiveTab] = useState('editor');
            const [copyStatus, setCopyStatus] = useState("複製 JSON");

            const activePage = pages[activeIdx];

            const updateActivePage = (field, value) => {
                setPages(prev => {
                    const next = [...prev];
                    const keys = field.split('.');
                    let curr = { ...next[activeIdx] };
                    next[activeIdx] = curr;
                    for (let i = 0; i < keys.length - 1; i++) { curr[keys[i]] = { ...curr[keys[i]] }; curr = curr[keys[i]]; }
                    curr[keys[keys.length - 1]] = value;
                    return next;
                });
            };

            const buildJson = useCallback(() => {
                const contents = pages.map(d => {
                    const totalH = "600px";  // 開放到 600px
                    const footH = "80px";   // Footer 固定 80
                    const mainH = "520px";  // Body 固定 520

                    if (d.model === 'BUSINESS_CORE') {
                        const base = [];
                        if (d.url !== 'none') base.push({ type: "image", url: d.url, size: "full", aspectRatio: "2:3", aspectMode: "cover" });
                        base.push({ type: "box", layout: "vertical", position: "absolute", offsetTop: "10px", [d.badgePos]: "10px", height: "25px", backgroundColor: d.badgeBg, cornerRadius: "15px", justifyContent: "center", paddingStart: "8px", paddingEnd: "8px", contents: [{ type: "text", text: d.badgeText, color: "#ffffff", size: "xxs", weight: "bold" }] });
                        base.push({ type: "box", layout: "vertical", position: "absolute", offsetTop: Utils.toPx(d.avatarTop), offsetStart: "0px", offsetEnd: "0px", alignItems: "center", contents: [{ type: "box", layout: "vertical", width: "85px", height: "85px", cornerRadius: "100px", borderWidth: "3px", borderColor: "#ffffff", contents: [{ type: "image", url: d.avatar, size: "full", aspectMode: "cover" }] }] });
                        base.push({ type: "box", layout: "vertical", position: "absolute", offsetTop: Utils.toPx(d.nameTop), offsetStart: "0px", offsetEnd: "0px", contents: [{ type: "text", text: d.name, weight: "bold", size: "lg", color: d.nameColor, align: d.nameAlign }] });
                        base.push({ type: "box", layout: "horizontal", position: "absolute", offsetTop: Utils.toPx(d.socialTop), offsetStart: "0px", offsetEnd: "0px", justifyContent: "center", spacing: "md", contents: d.icons.map(icon => ({ type: "box", layout: "vertical", width: "45px", height: "45px", cornerRadius: "100px", backgroundColor: "#ffffff1a", paddingAll: "8px", action: { type: "uri", uri: icon.uri || "https://line.me" }, contents: [{ type: "image", url: SOCIAL_DATA[icon.type]?.url, size: "full", aspectRatio: "1:1" }] })) });
                        base.push({ type: "box", layout: "vertical", position: "absolute", offsetTop: Utils.toPx(d.descTop), offsetStart: "15px", offsetEnd: "15px", contents: [{ type: "text", text: d.desc, wrap: true, size: "xs", color: d.descColor, align: d.descAlign }] });
                        base.push({ type: "box", layout: "vertical", position: "absolute", offsetBottom: "0px", offsetStart: "0px", offsetEnd: "0px", height: footH, backgroundColor: d.footerBg, paddingAll: "15px", justifyContent: "center", contents: [{ type: "box", layout: "vertical", backgroundColor: d.footerThemeColor, paddingAll: "10px", cornerRadius: "md", action: { type: "uri", uri: d.footerUri || "https://line.me" }, contents: [{ type: "text", text: d.footerLabel, color: d.footerTextColor, align: "center", weight: "bold", size: "sm" }] }] });
                        return { type: "bubble", body: { type: "box", layout: "vertical", paddingAll: "0px", height: totalH, contents: base } };
                    }

                    if (d.model === 'PERSONAL_CORE') {
                        const [w, h] = d.media.aspectRatio.split(':').map(Number);
                        const mediaH = Math.round((h/w)*300);
                        const items = [
                            { type: "image", url: d.media.url, size: "full", aspectRatio: d.media.aspectRatio, aspectMode: "cover" },
                            { type: "box", layout: "vertical", paddingAll: "15px", paddingTop: d.avatar.show ? "55px" : "15px", flex: 1, contents: [{ type: "text", text: d.content.name, weight: "bold", size: "lg", color: d.content.nameColor, align: d.content.nameAlign }, { type: "text", text: d.content.desc, wrap: true, color: d.content.descColor, size: "xs", margin: "md", align: d.content.descAlign }] },
                            ...(d.avatar.show ? [{ type: "box", layout: "vertical", position: "absolute", offsetTop: Utils.toPx(mediaH - 45), offsetStart: "0px", offsetEnd: "0px", alignItems: "center", contents: [{ type: "box", layout: "vertical", width: "80px", height: "80px", cornerRadius: d.avatar.cornerRadius, borderWidth: "3px", borderColor: d.avatar.borderColor, contents: [{ type: "image", url: d.avatar.url, size: "full", aspectRatio: "1:1" }] }] }] : []),
                            { type: "box", layout: "vertical", position: "absolute", offsetBottom: "0px", offsetStart: "0px", offsetEnd: "0px", height: footH, paddingAll: "15px", justifyContent: "center", backgroundColor: "#ffffff", contents: [
                                { type: "separator", color: "#f0f0f0" },
                                { type: "box", layout: "vertical", paddingAll: "10px", margin: "md", borderWidth: "1px", borderColor: d.footer.longBtns[0].themeColor, backgroundColor: d.footer.longBtns[0].isSolid ? d.footer.longBtns[0].themeColor : undefined, cornerRadius: "md", action: { type: "uri", uri: d.footer.longBtns[0].uri }, contents: [{ type: "text", text: d.footer.longBtns[0].label, align: "center", color: d.footer.longBtns[0].textColor, size: "sm", weight: "bold" }] }
                            ]}
                        ];
                        return { type: "bubble", body: { type: "box", layout: "vertical", paddingAll: "0px", height: totalH, contents: items } };
                    }

                    if (d.model === 'ECOMMERCE_CORE') {
                        const chunk = (a, s) => Array.from({ length: Math.ceil(a.length / s) }, (v, i) => a.slice(i * s, i * s + s));
                        const productRows = chunk(d.body.items || [], d.body.columns).map((row, idx) => ({ type: "box", layout: "horizontal", margin: idx === 0 ? "none" : "md", contents: row.map((item, cidx) => ({ type: "box", layout: "vertical", width: d.body.columns === 3 ? "32%" : "23%", margin: cidx === 0 ? "none" : "md", backgroundColor: "#FFFFFF", cornerRadius: "10px", action: { type: "uri", uri: item.url }, contents: [ { type: "image", url: item.img, aspectRatio: "1:1", size: "full", aspectMode: "cover" }, { type: "box", layout: "vertical", backgroundColor: d.body.tagBgColor, cornerRadius: "sm", paddingAll: "xs", margin: "xs", contents: [{ type: "text", text: item.title, size: "xxs", color: d.body.tagTextColor, align: "center", weight: "bold", wrap: true }] } ] })) }));
                        const items = [
                            { type: "image", url: d.hero.url, size: "full", aspectRatio: d.hero.aspectRatio, aspectMode: "cover" },
                            { type: "box", layout: "vertical", paddingAll: "md", backgroundColor: d.body.bgColor, flex: 1, contents: productRows },
                            { type: "box", layout: "vertical", position: "absolute", offsetBottom: "0px", offsetStart: "0px", offsetEnd: "0px", height: footH, backgroundColor: d.footer.bg, paddingAll: "md", justifyContent: "center", contents: [
                                { type: "separator", color: "#f0f0f0" },
                                { type: "box", layout: "horizontal", spacing: "md", margin: "md", contents: [{ type: "button", style: "primary", height: "sm", color: d.footer.btn1.color, action: { type: "uri", label: d.footer.btn1.label, uri: d.footer.btn1.uri } }, { type: "button", style: "primary", height: "sm", color: d.footer.btn2.color, action: { type: "uri", label: d.footer.btn2.label, uri: d.footer.btn2.uri } }] }
                            ]}
                        ];
                        return { type: "bubble", body: { type: "box", layout: "vertical", paddingAll: "0px", height: totalH, contents: items } };
                    }
                });
                return { type: "carousel", contents };
            }, [pages]);

            const copyJson = () => {
                const json = JSON.stringify(buildJson(), null, 2);
                const el = document.createElement('textarea'); el.value = json; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
                setCopyStatus("已複製！"); setTimeout(() => setCopyStatus("複製 JSON"), 2000);
            };

            useEffect(() => { window.parent.postMessage({ type: 'SYNC_FLEX_DATA', json: JSON.stringify(buildJson()) }, '*'); }, [pages, buildJson]);
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [activeIdx, activePage, activeTab]);

            return (
                <div className="flex h-screen bg-slate-100 font-black overflow-hidden text-slate-900">
                    <div className="w-2/3 bg-white border-r flex flex-col shadow-2xl z-10">
                        <div className="sticky-section flex flex-col gap-4 bg-white shadow-sm shrink-0">
                            <h1 className="text-xl flex items-center gap-2 text-green-600 uppercase tracking-tighter italic font-black"><i data-lucide="layers"></i> Carousel Pro v5.2.4</h1>
                            <div className="flex gap-2 overflow-x-auto pb-1 custom-scrollbar">
                                {pages.map((p, i) => (
                                    <div key={i} className="relative group shrink-0">
                                        <button onClick={() => setActiveIdx(i)} className={`px-5 py-2.5 rounded-xl border-2 transition-all font-black text-xs ${activeIdx === i ? 'page-tab-active shadow-md' : 'border-slate-100 bg-slate-50 text-slate-400 hover:bg-slate-100'}`}>P{i+1}</button>
                                        <button onClick={() => setPages([...pages, Utils.deepCopy(pages[i])])} className="absolute -top-1 -right-1 bg-green-500 text-white w-4 h-4 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-lg z-10"><i data-lucide="copy" className="w-2.5 h-2.5"></i></button>
                                        {pages.length > 1 && <button onClick={() => {const n=[...pages]; n.splice(i,1); setPages(n); setActiveIdx(0);}} className="absolute -bottom-1 -right-1 bg-red-500 text-white w-4 h-4 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-lg z-10"><i data-lucide="x" className="w-2.5 h-2.5"></i></button>}
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6 custom-scrollbar">
                            {/* P1 面板 */}
                            {activePage.model === 'BUSINESS_CORE' && (
                                <>
                                    <ControlPanel title="1. 背景與標籤" icon="image">
                                        <div className="flex gap-2"><input type="text" value={activePage.url === 'none' ? '' : activePage.url} onChange={e => updateActivePage('url', e.target.value || 'none')} placeholder="背景網址" /><button onClick={() => updateActivePage('url', activePage.url === 'none' ? TEMPLATE_P1.url : 'none')} className={`px-3 rounded-lg border font-black text-[10px] shrink-0 ${activePage.url === 'none' ? 'bg-slate-800 text-white' : 'bg-white'}`}>無背景</button></div>
                                        <div className="grid grid-cols-2 gap-3 mt-2"><input type="text" maxLength={10} value={activePage.badgeText} onChange={e => updateActivePage('badgeText', e.target.value)} placeholder="標籤(限10字)" /><div className="flex gap-1"><input type="color" value={activePage.badgeBg} onChange={e => updateActivePage('badgeBg', e.target.value)} className="flex-1" /><button onClick={() => updateActivePage('badgePos', activePage.badgePos === 'offsetStart' ? 'offsetEnd' : 'offsetStart')} className="p-2 border rounded-lg bg-white"><i data-lucide={activePage.badgePos === 'offsetStart' ? 'align-left' : 'align-right'} className="w-4 h-4"></i></button></div></div>
                                    </ControlPanel>
                                    <ControlPanel title="2. 個人頭像" icon="user-circle"><input type="text" value={activePage.avatar} onChange={e => updateActivePage('avatar', e.target.value)} placeholder="頭像網址" /></ControlPanel>
                                    <ControlPanel title="3. 垂直位置調整" icon="move-vertical" headerClass="amber-header">
                                        <div className="flex justify-between text-xs mb-1 font-bold">連動高度 <span>{activePage.avatarTop}px</span></div>
                                        <input type="range" min="0" max="600" value={activePage.avatarTop} onChange={e => {
                                            const v = parseInt(e.target.value); const diff = v - activePage.avatarTop;
                                            setPages(prev => { const next = [...prev]; next[activeIdx] = { ...next[activeIdx], avatarTop: v, nameTop: (activePage.nameTop || 0) + diff, socialTop: (activePage.socialTop || 0) + diff, descTop: (activePage.descTop || 0) + diff }; return next; });
                                        }} className="w-full accent-amber-500 h-2 cursor-pointer" />
                                    </ControlPanel>
                                    <ControlPanel title="4. 姓名設定" icon="user"><div className="flex gap-2 mb-3"><input type="text" value={activePage.name} onChange={e => updateActivePage('name', e.target.value)} className="flex-1 font-bold" /><input type="color" value={activePage.nameColor} onChange={e => updateActivePage('nameColor', e.target.value)} className="w-12 h-10 shadow-sm" /></div><AlignButtons value={activePage.nameAlign} onChange={v => updateActivePage('nameAlign', v)} /></ControlPanel>
                                    <ControlPanel title="5. 社群按鈕" icon="share-2">
                                        <button onClick={() => updateActivePage('icons', [...activePage.icons, {type:'LINE', uri:'https://line.me'}])} className="w-full bg-[#06C755] text-white py-2 rounded-xl mb-4 font-black text-xs shadow-md">+ 新增按鈕</button>
                                        {(activePage.icons || []).map((icon, idx) => (
                                            <div key={idx} className="bg-slate-50 p-3 border border-slate-200 rounded-xl mb-3 relative group font-black"><button onClick={() => updateActivePage('icons', activePage.icons.filter((_,i)=>i!==idx))} className="absolute -top-1.5 -right-1.5 bg-red-500 text-white w-5 h-5 rounded-full text-[10px] shadow-lg opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center shadow-md">×</button>
                                            <select value={icon.type} onChange={e => {const n=[...activePage.icons]; n[idx].type=e.target.value; n[idx].uri=SOCIAL_DATA[e.target.value].defaultUri; updateActivePage('icons', n);}} className="mb-2 text-xs">{Object.keys(SOCIAL_DATA).map(k => <option key={k} value={k}>{SOCIAL_DATA[k].label}</option>)}</select>
                                            <input type="text" value={icon.uri} onChange={e => {const n=[...activePage.icons]; n[idx].uri=e.target.value; updateActivePage('icons', n);}} className="text-[10px] font-mono border-slate-100" /></div>
                                        ))}
                                    </ControlPanel>
                                    <ControlPanel title="6. 簡介內容" icon="align-left"><textarea value={activePage.desc} onChange={e => updateActivePage('desc', e.target.value)} className="w-full p-3 h-24 text-xs mb-2 leading-relaxed" /><div className="grid grid-cols-2 gap-3"><AlignButtons value={activePage.descAlign} onChange={v => updateActivePage('descAlign', v)} /><input type="color" value={activePage.descColor} onChange={e => updateActivePage('descColor', e.target.value)} /></div></ControlPanel>
                                    <ControlPanel title="7. 底部行為按鈕" icon="external-link"><input type="text" value={activePage.footerLabel} onChange={e => updateActivePage('footerLabel', e.target.value)} className="mb-2 font-bold" /><div className="grid grid-cols-3 gap-3"><div><label className="text-[9px] text-slate-400 block font-bold">區域</label><input type="color" value={activePage.footerBg} onChange={e => updateActivePage('footerBg', e.target.value)} /></div><div><label className="text-[9px] text-slate-400 block font-bold">按鈕</label><input type="color" value={activePage.footerThemeColor} onChange={e => updateActivePage('footerThemeColor', e.target.value)} /></div><div><label className="text-[9px] text-slate-400 block font-bold">文字</label><input type="color" value={activePage.footerTextColor} onChange={e => updateActivePage('footerTextColor', e.target.value)} /></div></div></ControlPanel>
                                </>
                            )}
                            {activePage.model === 'PERSONAL_CORE' && (
                                <>
                                    <ControlPanel title="01. 媒體模式" icon="image">
                                        <div className="flex bg-slate-100 p-1 rounded-lg border mb-3">{['image', 'video'].map(t => <button key={t} onClick={() => updateActivePage('mediaType', t)} className={`flex-1 py-1.5 text-xs font-bold rounded ${activePage.mediaType === t ? 'bg-white shadow text-emerald-600' : ''}`}>{t === 'image' ? '圖片' : '影片'}</button>)}</div>
                                        <input type="text" value={activePage.media.url} onChange={e => updateActivePage('media.url', e.target.value)} className="text-xs font-mono" />
                                        <div className="mt-2"><label className="text-[10px] text-slate-400 block mb-1 font-bold uppercase tracking-widest">顯示比例</label><select value={activePage.media.aspectRatio} onChange={e => updateActivePage('media.aspectRatio', e.target.value)} className="text-xs"><option value="16:9">16:9</option><option value="20:13">20:13</option><option value="1:1">1:1</option><option value="4:3">4:3</option></select></div>
                                    </ControlPanel>
                                    <ControlPanel title="02. 姓名排版" icon="type"><div className="flex gap-2 mb-2"><input type="text" value={activePage.content.name} onChange={e => updateActivePage('content.name', e.target.value)} className="flex-1 p-2 border rounded font-bold" /><input type="color" value={activePage.content.nameColor} onChange={e => updateActivePage('content.nameColor', e.target.value)} className="w-12 h-10" /></div><AlignButtons value={activePage.content.nameAlign} onChange={v => updateActivePage('content.nameAlign', v)} /></ControlPanel>
                                    <ControlPanel title="03. 說明排版" icon="align-left"><textarea value={activePage.content.desc} onChange={e => updateActivePage('content.desc', e.target.value)} className="h-20 text-xs mb-2 leading-relaxed" /><div className="grid grid-cols-2 gap-3"><AlignButtons value={activePage.content.descAlign} onChange={v => updateActivePage('content.descAlign', v)} /><input type="color" value={activePage.content.descColor} onChange={e => updateActivePage('content.descColor', e.target.value)} /></div></ControlPanel>
                                    <ControlPanel title="04. 個人頭像" icon="user">
                                        <div className="flex items-center justify-between mb-3"><label className="text-xs font-bold">顯示頭像</label><input type="checkbox" checked={activePage.avatar.show} onChange={e => updateActivePage('avatar.show', e.target.checked)} className="h-5 w-5 accent-emerald-500" /></div>
                                        {activePage.avatar.show && <div className="space-y-2"><input type="text" value={activePage.avatar.url} onChange={e => updateActivePage('avatar.url', e.target.value)} className="text-xs font-mono" /><div className="grid grid-cols-2 gap-2"><select value={activePage.avatar.cornerRadius} onChange={e => updateActivePage('avatar.cornerRadius', e.target.value)} className="text-xs"><option value="12px">12px</option><option value="100px">100px</option></select><input type="color" value={activePage.avatar.borderColor} onChange={e => updateActivePage('avatar.borderColor', e.target.value)} /></div></div>}
                                    </ControlPanel>
                                    <ControlPanel title="05. 主按鈕區" icon="layers">
                                        <button onClick={() => {const n=[...(activePage.footer.longBtns || []), {label:'新按鈕', uri:'https://line.me', themeColor:'#10b981', textColor:'#ffffff', isSolid:true}]; updateActivePage('footer.longBtns', n);}} className="w-full bg-[#06C755] text-white py-2 rounded mb-3 text-xs shadow-md font-black">+ 新增按鈕</button>
                                        {(activePage.footer.longBtns || []).map((b, idx) => (
                                            <div key={idx} className="bg-slate-50 p-2 border rounded-xl mb-2 relative group font-black"><button onClick={() => {const n=activePage.footer.longBtns.filter((_,i)=>i!==idx); updateActivePage('footer.longBtns', n);}} className="absolute -top-1.5 -right-1.5 bg-red-500 text-white w-5 h-5 rounded-full text-[10px] shadow-md opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">×</button>
                                            <div className="grid grid-cols-2 gap-2 mb-2"><input type="text" value={b.label} onChange={e => {const n=[...activePage.footer.longBtns]; n[idx].label=e.target.value; updateActivePage('footer.longBtns', n);}} className="p-2 font-bold border rounded text-xs" /><button onClick={() => {const n=[...activePage.footer.longBtns]; n[idx].isSolid=!b.isSolid; updateActivePage('footer.longBtns', n);}} className={`text-[10px] font-black rounded border transition-colors ${b.isSolid ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-300 hover:bg-slate-50'}`}>{b.isSolid ? '實心' : '空心'}</button></div>
                                            <div className="grid grid-cols-2 gap-2 mb-2"><div><label className="text-[9px] text-slate-400 block mb-1">背景</label><input type="color" value={b.themeColor} onChange={e => {const n=[...activePage.footer.longBtns]; n[idx].themeColor=e.target.value; updateActivePage('footer.longBtns', n);}} /></div><div><label className="text-[9px] text-slate-400 block mb-1">文字</label><input type="color" value={b.textColor} onChange={e => {const n=[...activePage.footer.longBtns]; n[idx].textColor=e.target.value; updateActivePage('footer.longBtns', n);}} /></div></div>
                                            <input type="text" value={b.uri} onChange={e => {const n=[...activePage.footer.longBtns]; n[idx].uri=e.target.value; updateActivePage('footer.longBtns', n);}} className="text-[10px] font-mono border rounded p-2" placeholder="連結" /></div>
                                        ))}
                                    </ControlPanel>
                                    <ControlPanel title="06. 社群快捷" icon="share-2">
                                        <button onClick={() => {const n=[...(activePage.footer.shortBtns || []), {type:'WEB', label:'官網', uri:'https://line.me', themeColor:'#f1f5f9', textColor:'#444444', isSolid:true}]; updateActivePage('footer.shortBtns', n);}} className="w-full bg-[#06C755] text-white py-2 rounded-xl mb-4 font-black text-xs shadow-md">+ 新增快捷</button>
                                        <div className="grid grid-cols-1 gap-3">{(activePage.footer.shortBtns || []).map((b, idx) => (
                                            <div key={idx} className="bg-slate-50 p-3 border border-slate-200 rounded-xl relative group font-black"><button onClick={() => {const n=activePage.footer.shortBtns.filter((_,i)=>i!==idx); updateActivePage('footer.shortBtns', n);}} className="absolute -top-1 -right-1 bg-red-500 text-white w-5 h-5 rounded-full text-[10px] opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">×</button>
                                            <div className="grid grid-cols-2 gap-2 mb-2"><select value={b.type} onChange={e => {const n=[...activePage.footer.shortBtns]; n[idx].type=e.target.value; n[idx].uri=SOCIAL_DATA[e.target.value]?.defaultUri || 'https://'; updateActivePage('footer.shortBtns', n);}} className="text-xs">{Object.keys(SOCIAL_DATA).map(k=><option key={k} value={k}>{SOCIAL_DATA[k].label}</option>)}</select><input type="text" value={b.label} onChange={e => {const n=[...activePage.footer.shortBtns]; n[idx].label=e.target.value; updateActivePage('footer.shortBtns', n);}} className="p-1 text-[10px] font-bold" /></div>
                                            <input type="text" value={b.uri} onChange={e => {const n=[...activePage.footer.shortBtns]; n[idx].uri=e.target.value; updateActivePage('footer.shortBtns', n);}} className="text-[10px] font-mono p-1 border rounded w-full bg-white" placeholder="連結" /></div>
                                        ))}</div>
                                    </ControlPanel>
                                </>
                            )}
                            {activePage.model === 'ECOMMERCE_CORE' && (
                                <>
                                    <ControlPanel title="1. 頂部 Hero 視覺" icon="image">
                                        <div className="flex gap-2 bg-slate-100 p-1 rounded-lg border mb-3">{['image', 'none'].map(t => <button key={t} onClick={() => updateActivePage('hero.type', t)} className={`flex-1 py-1.5 text-xs font-bold rounded ${activePage.hero.type === t ? 'bg-white shadow text-emerald-600' : ''}`}>{t === 'image' ? '靜態圖片' : '無'}</button>)}</div>
                                        <input type="text" value={activePage.hero.url} onChange={e => updateActivePage('hero.url', e.target.value)} className="text-xs font-mono mb-2" placeholder="圖片/封面網址" />
                                        <div className="flex gap-2"><label className="text-[10px] text-slate-400 block shrink-0 self-center font-bold uppercase tracking-widest">顯示比例</label><select value={activePage.hero.aspectRatio} onChange={e => updateActivePage('hero.aspectRatio', e.target.value)} className="text-xs"><option value="16:9">16:9</option><option value="20:13">20:13</option><option value="1:1">1:1</option><option value="4:3">4:3</option></select></div>
                                    </ControlPanel>
                                    <ControlPanel title="2. Body 內容 (白底 10px)" icon="package" headerClass="blue-header">
                                        <div className="grid grid-cols-2 gap-3 mb-3"><div><label className="text-[10px] text-slate-400 block mb-1 uppercase font-bold">每行欄數</label><select value={activePage.body.columns} onChange={e => updateActivePage('body.columns', parseInt(e.target.value))} className="text-xs"><option value="3">3 欄</option><option value="4">4 欄</option></select></div><div><label className="text-[10px] text-slate-400 block mb-1 uppercase font-bold">Body 底色</label><input type="color" value={activePage.body.bgColor} onChange={e => updateActivePage('body.bgColor', e.target.value)} /></div></div>
                                        <button onClick={() => {const n=[...(activePage.body.items || []), {title:'新商品', img:'https://lihi.cc/mwMvo', url:'https://line.me'}]; updateActivePage('body.items', n);}} className="w-full py-2 bg-blue-50 border-dashed border-2 border-blue-200 rounded-xl mb-4 text-blue-600 font-bold text-xs">+ 新增商品</button>
                                        <div className="space-y-2">{(activePage.body.items || []).map((item, i) => (<div key={i} className="p-3 bg-slate-50 border rounded-xl flex gap-3 relative group font-black"><button onClick={() => {const n=activePage.body.items.filter((_,idx)=>idx!==i); updateActivePage('body.items', n);}} className="absolute -top-1.5 -right-1.5 bg-red-500 text-white w-5 h-5 rounded-full text-[10px] opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">×</button><img src={item.img} className="w-10 h-10 rounded border bg-white" /><div className="flex-1 space-y-1"><input type="text" value={item.title} onChange={e => {const n=[...activePage.body.items]; n[i].title=e.target.value; updateActivePage('body.items', n);}} className="w-full p-1 text-xs border rounded font-bold bg-white" /><input type="text" value={item.url} onChange={e => {const n=[...activePage.body.items]; n[i].url=e.target.value; updateActivePage('body.items', n);}} className="w-full p-1 text-[9px] font-mono border rounded bg-white" /></div></div>))}</div>
                                    </ControlPanel>
                                    <ControlPanel title="3. 底部行為按鈕" icon="external-link">
                                        <div className="flex justify-center mb-3"><div className="w-full text-center"><label className="text-[9px] text-slate-400 uppercase font-bold tracking-widest">區域背景顏色</label><input type="color" value={activePage.footer.bg} onChange={e => updateActivePage('footer.bg', e.target.value)} className="h-8" /></div></div>
                                        {['btn1', 'btn2'].map(k => (
                                            <div key={k} className="p-3 bg-slate-50 rounded-xl border border-slate-100 mb-2 space-y-2 font-black">
                                                <input type="text" value={activePage.footer[k].label} onChange={e => updateActivePage(`footer.${k}.label`, e.target.value)} className="p-2 font-bold text-xs" placeholder="按鈕文字" />
                                                <div className="grid grid-cols-2 gap-2"><div><label className="text-[8px] text-slate-400 uppercase font-bold">背景</label><input type="color" value={activePage.footer[k].color} onChange={e => updateActivePage(`footer.${k}.color`, e.target.value)} className="h-7" /></div><div><label className="text-[8px] text-slate-400 uppercase font-bold">文字</label><input type="color" value={activePage.footer[k].textColor} onChange={e => updateActivePage(`footer.${k}.textColor`, e.target.value)} className="h-7" /></div></div>
                                                <input type="text" value={activePage.footer[k].uri} onChange={e => updateActivePage(`footer.${k}.uri`, e.target.value)} className="p-1.5 text-[9px] font-mono border rounded w-full bg-white" placeholder="連結" />
                                            </div>
                                        ))}
                                    </ControlPanel>
                                </>
                            )}
                        </div>
                    </div>

                    <div className="w-1/3 flex flex-col chat-room-bg overflow-y-auto font-black relative border-l border-slate-300">
                        <div className="h-[70px] bg-white border-b flex items-center px-6 gap-6 shrink-0 z-30 shadow-sm sticky top-0 w-full">
                            <button onClick={() => setActiveTab('editor')} className={`text-sm tracking-widest ${activeTab === 'editor' ? 'text-green-600 border-b-4 border-green-600' : 'text-slate-400'}`}>預覽 (P{activeIdx+1})</button>
                            <button onClick={() => setActiveTab('json')} className={`text-sm tracking-widest ${activeTab === 'json' ? 'text-green-600 border-b-4 border-green-600' : 'text-slate-400'}`}>JSON</button>
                            <div className="flex-1"></div>
                            <button onClick={copyJson} className="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-xl text-xs flex items-center gap-2 shadow-lg active:scale-95 transition-all font-black shrink-0"><i data-lucide="copy" className="w-4 h-4"></i> 複製</button>
                        </div>
                        <div className="flex-1">
                            {activeTab === 'editor' ? (
                                <div className="py-12 flex flex-col items-center min-h-full font-black">
                                    <div className="mb-8 px-6 py-2 bg-slate-900/90 text-white rounded-full text-[10px] tracking-[0.2em] uppercase flex items-center gap-3 shadow-2xl">
                                        <div className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                                        LOCKED 400x600 RATIO
                                    </div>
                                    <FlexPreview data={activePage} />
                                    <div className="mt-8 flex gap-2">{pages.map((_, i) => <div key={i} className={`w-2 h-2 rounded-full transition-all ${activeIdx === i ? 'w-8 bg-white shadow-lg' : 'bg-white/30'}`}></div>)}</div>
                                </div>
                            ) : (
                                <div className="p-6"><pre className="bg-slate-900 text-emerald-400 p-6 rounded-[24px] text-[10px] overflow-x-auto border-4 border-slate-800 shadow-2xl font-mono">{JSON.stringify(buildJson(), null, 2)}</pre></div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>
