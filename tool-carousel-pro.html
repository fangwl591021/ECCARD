<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLEX Carousel Pro - 旗艦模組全移植版 v3.3.6</title>
    <!-- 核心庫載入 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide 圖示載入 -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; margin: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #06C755; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .chat-room-bg { background-color: #7988a0; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .control-panel { background: white; border-radius: 12px; padding: 0; overflow: hidden; border: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .panel-header { background: linear-gradient(135deg, #06C755 0%, #00A648 100%); padding: 14px 18px; }
        .panel-content { padding: 18px; }
        .master-slider { accent-color: #f59e0b; height: 10px; }
        .preview-text-multiline { white-space: pre-wrap; word-break: break-all; }
        input, select, textarea, button { font-size: 14px !important; }
        .section-title { font-size: 14px; font-weight: 900; color: white; }
        .control-label { font-size: 12px; font-weight: 700; color: #475569; }
        .color-preview { width: 36px; height: 36px; border-radius: 6px; border: 2px solid #e2e8f0; cursor: pointer; }
        .sticky-section { position: sticky; top: 0; background: white; z-index: 50; padding: 15px 20px; border-bottom: 1px solid #e2e8f0; }
        .amber-header { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important; }
        .slider-value-display { font-size: 12px; font-weight: 900; background: #f59e0b; color: white; padding: 2px 8px; border-radius: 10px; }
        .page-tab-active { border-color: #06C755; color: #06C755; background: #f0fdf4; transform: scale(1.02); }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 2px solid #e2e8f0; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, memo } = React;

        // --- 全局常數與模組數據 ---
        const SOCIAL_ICONS = {
            NONE: { url: "https://vos.line-scdn.net/bot-designer-template-images/bot-designer-icon.png", label: "無" },
            FB: { url: "https://cdn-icons-png.flaticon.com/512/733/733547.png", label: "Facebook" },
            IG: { url: "https://cdn-icons-png.flaticon.com/512/2111/2111463.png", label: "Instagram" },
            TIKTOK: { url: "https://cdn-icons-png.flaticon.com/512/3046/3046121.png", label: "TikTok" },
            LINE: { url: "https://cdn-icons-png.flaticon.com/512/124/124027.png", label: "LINE" },
            PHONE: { url: "https://cdn-icons-png.flaticon.com/512/3616/3616215.png", label: "電話" },
            MAIL: { url: "https://cdn-icons-png.flaticon.com/512/732/732200.png", label: "Email" },
            MAP: { url: "https://cdn-icons-png.flaticon.com/512/355/355980.png", label: "地圖" },
            WEB: { url: "https://cdn-icons-png.flaticon.com/512/1006/1006771.png", label: "官網" }
        };

        const TEMPLATES = {
            BUSINESS: {
                model: "BUSINESS",
                url: "https://aiwe.cc/wp-content/uploads/2025/12/cf75e54791dd1f49f918345fdfe2430b.png",
                badgeText: "業務精選", badgeBg: "#D4AF37", badgePos: "offsetEnd", badgeTop: 20,
                avatar: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=200",
                avatarTop: 60,
                name: "張志明", nameColor: "#000000", nameWeight: "bold", nameAlign: "center", nameTop: 155,
                label1: "行銷總監 / 品牌顧問", label1Color: "#000000", label1Bg: "#FFFFFF33", label1Top: 190,
                desc: "致力於協助企業品牌數位轉型\n擁有超過 15 年的跨國行銷經驗",
                descColor: "#000000", descAlign: "center", descTop: 275,
                socialTop: 215,
                icons: [{ type: "PHONE", uri: "tel:0912345678" }, { type: "LINE", uri: "https://line.me" }],
                footerBg: "#111111", footerLabel: "聯繫我了解更多", footerUri: "https://line.me",
                footerThemeColor: "#D4AF37", footerTextColor: "#000000"
            },
            PERSONAL: {
                model: "PERSONAL",
                url: "https://lihi.cc/5OXMZ",
                badgeText: "個人名片", badgeBg: "#10b981", badgePos: "offsetStart", badgeTop: 20,
                avatar: "https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=200",
                avatarTop: 80,
                name: "王小明", nameColor: "#111111", nameWeight: "bold", nameAlign: "center", nameTop: 175,
                label1: "生活旅遊家 / 攝影師", label1Color: "#ffffff", label1Bg: "#00000066", label1Top: 210,
                desc: "喜歡探索世界的每個角落\n在這裡記錄我的攝影生活與故事",
                descColor: "#333333", descAlign: "center", descTop: 290,
                socialTop: 235,
                icons: [{ type: "IG", uri: "https://instagram.com" }, { type: "FB", uri: "https://facebook.com" }],
                footerBg: "#ffffff", footerLabel: "追蹤我的生活", footerUri: "https://line.me",
                footerThemeColor: "#10b981", footerTextColor: "#ffffff"
            },
            ECOMMERCE: {
                model: "ECOMMERCE",
                hero: { type: 'image', url: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=400", aspectRatio: '16:9', link: "" },
                body: { bgType: "color", bgColor: "#F8F8F8", bgImage: "", bgMode: "cover", columns: 3, tagBg: "#0D0D0D", tagText: "#FFFFFF", items: [
                    { title: "商品 A", img: "https://lihi.cc/mwMvo", url: "https://line.me" },
                    { title: "商品 B", img: "https://lihi.cc/2Nu8G", url: "https://line.me" },
                    { title: "商品 C", img: "https://lihi.cc/yRfpn", url: "https://line.me" }
                ]},
                footer: { bg: "#FFFFFF", textEnabled: true, text: "※ 限時特惠，售完為止。", textColor: "#666666", textAlign: "center", btn1: { label: "官方商城", color: "#000000", uri: "https://line.me" }, btn2: { label: "好友分享", color: "#000000", uri: "https://line.me" } }
            }
        };

        const Utils = {
            toPx: (val) => String(val).endsWith('px') ? val : `${val}px`,
            deepCopy: (obj) => JSON.parse(JSON.stringify(obj))
        };

        // --- 子元件 ---
        const ControlPanel = ({ title, icon, children, headerClass = "" }) => (
            <div className="control-panel mb-6 font-black text-black">
                <div className={`panel-header flex items-center gap-2 ${headerClass}`}>
                    <i data-lucide={icon} className="w-5 h-5 text-white"></i>
                    <span className="section-title uppercase">{title}</span>
                </div>
                <div className="panel-content space-y-4">{children}</div>
            </div>
        );

        const FlexPreview = memo(({ data }) => {
            const scale = 300 / 400;
            const SOCIAL = SOCIAL_ICONS;
            const d = data;

            if (d.model === 'BUSINESS' || d.model === 'PERSONAL') {
                return (
                    <div className="rounded-[45px] shadow-2xl overflow-hidden relative border-[10px] border-black bg-white w-[300px]">
                        <div className="relative h-[450px] overflow-hidden bg-slate-100">
                            <img src={d.url} className="w-full h-full object-cover" />
                            <div className="absolute px-3 py-1 text-white font-bold rounded text-[10px]" style={{ top: '15px', [d.badgePos === 'offsetStart' ? 'left' : 'right']: '15px', backgroundColor: d.badgeBg }}>{d.badgeText}</div>
                            <div className="absolute w-full flex justify-center" style={{ top: (d.avatarTop * scale) + 'px' }}><img src={d.avatar} className="w-16 h-16 rounded-full border-2 border-white shadow-xl object-cover" /></div>
                            <div className="absolute w-full px-4" style={{ top: (d.nameTop * scale) + 'px', color: d.nameColor, textAlign: d.nameAlign, fontWeight: 900, fontSize: '18px' }}>{d.name}</div>
                            <div className="absolute w-full px-10" style={{ top: (d.label1Top * scale) + 'px' }}><div className="py-1.5 rounded text-[11px] text-center font-black shadow-sm" style={{ backgroundColor: d.label1Bg, color: d.label1Color }}>{d.label1}</div></div>
                            <div className="absolute w-full flex justify-center gap-3" style={{ top: (d.socialTop * scale) + 'px' }}>
                                {d.icons.map((icon, i) => (
                                    <div key={i} className="w-10 h-10 p-2 bg-white/25 rounded-full border border-white/40 flex items-center justify-center backdrop-blur-sm shadow-md"><img src={SOCIAL[icon.type]?.url || SOCIAL.NONE.url} className="w-full h-full object-contain" /></div>
                                ))}
                            </div>
                            <div className="absolute w-full px-5" style={{ top: (d.descTop * scale) + 'px', textAlign: d.descAlign, color: d.descColor, fontSize: '12px' }}><p className="preview-text-multiline leading-relaxed">{d.desc}</p></div>
                        </div>
                        <div className="p-4" style={{ backgroundColor: d.footerBg }}><div className="py-3 text-center rounded-xl text-[13px] font-black shadow-md" style={{ backgroundColor: d.footerThemeColor, color: d.footerTextColor }}>{d.footerLabel}</div></div>
                    </div>
                );
            }

            // 電商版 P3
            const chunk = (arr, size) => Array.from({ length: Math.ceil(arr.length / size) }, (v, i) => arr.slice(i * size, i * size + size));
            return (
                <div className="rounded-[45px] shadow-2xl overflow-hidden relative border-[10px] border-black bg-white w-[300px]">
                    {d.hero.type !== 'none' && (
                        <div className={`relative w-full overflow-hidden bg-black ${d.hero.aspectRatio === '1:1' ? 'aspect-square' : 'aspect-video'}`}>
                            <img src={d.hero.url} className="w-full h-full object-cover" />
                            {d.hero.type === 'video' && <div className="absolute inset-0 flex items-center justify-center"><div className="w-10 h-10 bg-white/80 rounded-full flex items-center justify-center"><i data-lucide="play" className="w-5 h-5 text-black fill-black ml-1"></i></div></div>}
                        </div>
                    )}
                    <div className="relative p-3" style={{ backgroundColor: d.body.bgColor }}>
                        {d.body.bgType === 'image' && <img src={d.body.bgImage} className="absolute inset-0 w-full h-full object-cover z-0" />}
                        <div className={`relative z-10 grid gap-2 ${d.body.columns === 3 ? 'grid-cols-3' : 'grid-cols-4'}`}>
                            {d.body.items.map((item, i) => (
                                <div key={i} className="bg-white rounded-md p-1 shadow-sm flex flex-col">
                                    <div className="aspect-square bg-slate-100 rounded-sm overflow-hidden mb-1"><img src={item.img} className="w-full h-full object-cover" /></div>
                                    <div style={{ backgroundColor: d.body.tagBg, color: d.body.tagText }} className="text-[8px] font-bold text-center py-1 rounded-sm truncate px-1">{item.title}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="p-3 border-t" style={{ backgroundColor: d.footer.bg }}>
                        {d.footer.textEnabled && <div className="text-[10px] mb-2 text-center" style={{ color: d.footer.textColor }}>{d.footer.text}</div>}
                        <div className="flex gap-2">
                            <div className="flex-1 py-2 text-center rounded font-bold text-[10px] text-white" style={{ backgroundColor: d.footer.btn1.color }}>{d.footer.btn1.label}</div>
                            <div className="flex-1 py-2 text-center rounded font-bold text-[10px] text-white" style={{ backgroundColor: d.footer.btn2.color }}>{d.footer.btn2.label}</div>
                        </div>
                    </div>
                </div>
            );
        });

        // --- 主程式 ---
        const App = () => {
            const [pages, setPages] = useState([TEMPLATES.BUSINESS, TEMPLATES.PERSONAL, TEMPLATES.ECOMMERCE]);
            const [activeIdx, setActiveIdx] = useState(0);
            const [activeTab, setActiveTab] = useState('editor');
            const [copyStatus, setCopyStatus] = useState("複製 JSON");

            const activePage = pages[activeIdx];

            // --- 核心：生成 JSON ---
            const buildJson = useCallback(() => {
                const contents = pages.map(d => {
                    if (d.model === 'BUSINESS' || d.model === 'PERSONAL') {
                        return {
                            type: "bubble", size: "mega",
                            body: {
                                type: "box", layout: "vertical", paddingAll: "0px",
                                contents: [
                                    { type: "image", url: d.url, size: "full", aspectRatio: "2:3", aspectMode: "cover", animated: true },
                                    { type: "box", layout: "vertical", position: "absolute", offsetTop: `${d.badgeTop}px`, [d.badgePos]: "20px", backgroundColor: d.badgeBg, cornerRadius: "xs", paddingAll: "2px", paddingStart: "8px", paddingEnd: "8px", contents: [{ type: "text", text: d.badgeText, color: "#ffffff", size: "xxs", weight: "bold" }] },
                                    { type: "box", layout: "vertical", position: "absolute", offsetTop: `${d.avatarTop}px`, offsetStart: "0px", offsetEnd: "0px", alignItems: "center", contents: [{ type: "box", layout: "vertical", width: "85px", height: "85px", cornerRadius: "100px", borderWidth: "3px", borderColor: "#ffffff", contents: [{ type: "image", url: d.avatar, size: "full", aspectMode: "cover", animated: true }] }] },
                                    { type: "box", layout: "vertical", position: "absolute", offsetTop: `${d.nameTop}px`, offsetStart: "0px", offsetEnd: "0px", contents: [{ type: "text", text: d.name, weight: "bold", size: "lg", color: d.nameColor, align: d.nameAlign }] },
                                    { type: "box", layout: "vertical", position: "absolute", offsetTop: `${d.label1Top}px`, offsetStart: "40px", offsetEnd: "40px", backgroundColor: d.label1Bg, cornerRadius: "md", paddingAll: "4px", contents: [{ type: "text", text: d.label1, size: "xs", color: d.label1Color, align: "center", weight: "bold" }] },
                                    { type: "box", layout: "horizontal", position: "absolute", offsetTop: `${d.socialTop}px`, offsetStart: "0px", offsetEnd: "0px", justifyContent: "center", spacing: "md", contents: (d.icons || []).map(icon => ({ type: "box", layout: "vertical", width: "45px", height: "45px", cornerRadius: "100px", backgroundColor: "#ffffff1a", paddingAll: "8px", action: { type: "uri", uri: icon.uri || "https://line.me" }, contents: [{ type: "image", url: SOCIAL_ICONS[icon.type]?.url || SOCIAL_ICONS.NONE.url, size: "full", animated: true }] })) },
                                    { type: "box", layout: "vertical", position: "absolute", offsetTop: `${d.descTop}px`, offsetStart: "15px", offsetEnd: "15px", contents: [{ type: "text", text: d.desc, wrap: true, size: "xs", color: d.descColor, align: d.descAlign }] }
                                ]
                            },
                            footer: { type: "box", layout: "vertical", paddingAll: "15px", backgroundColor: d.footerBg, contents: [{ type: "box", layout: "vertical", backgroundColor: d.footerThemeColor, paddingAll: "12px", cornerRadius: "md", action: { type: "uri", uri: d.footerUri || "https://line.me" }, contents: [{ type: "text", text: d.footerLabel, color: d.footerTextColor, align: "center", weight: "bold", size: "sm" }] }] }
                        };
                    } else {
                        // 電商版 P3
                        const chunk = (arr, size) => Array.from({ length: Math.ceil(arr.length / size) }, (v, i) => arr.slice(i * size, i * size + size));
                        const productGrid = {
                            type: "box", layout: "vertical", paddingAll: "md", contents: chunk(d.body.items, d.body.columns).map((row, rIdx) => ({
                                type: "box", layout: "horizontal", margin: rIdx === 0 ? "none" : "md", spacing: "md", contents: row.map(item => ({
                                    type: "box", layout: "vertical", width: d.body.columns === 3 ? "32%" : "23%", paddingAll: "xs", backgroundColor: "#FFFFFF", cornerRadius: "md", action: { type: "uri", uri: item.url }, contents: [
                                        { type: "image", url: item.img, aspectRatio: "1:1", size: "full", aspectMode: "cover", animated: true },
                                        { type: "box", layout: "vertical", margin: "sm", backgroundColor: d.body.tagBg, cornerRadius: "sm", paddingAll: "xs", contents: [{ type: "text", text: item.title, size: "xxs", color: d.body.tagText, align: "center", weight: "bold", wrap: true }] }
                                    ]
                                }))
                            }))
                        };
                        return {
                            type: "bubble", size: "mega",
                            hero: d.hero.type === 'none' ? undefined : { type: d.hero.type === 'video' ? 'video' : 'image', url: d.hero.url, aspectRatio: d.hero.aspectRatio, aspectMode: "cover", action: { type: "uri", uri: d.hero.link || "https://line.me" } },
                            body: { type: "box", layout: "vertical", paddingAll: "0px", backgroundColor: d.body.bgColor, contents: d.body.bgType === 'image' ? [{ type: "box", layout: "vertical", contents: [{ type: "image", url: d.body.bgImage, position: "absolute", size: "full", aspectMode: "cover", animated: true }, productGrid] }] : [productGrid] },
                            footer: { type: "box", layout: "vertical", paddingAll: "15px", backgroundColor: d.footer.bg, contents: [
                                d.footer.textEnabled ? { type: "text", text: d.footer.text, size: "xs", color: d.footer.textColor, align: d.footer.textAlign, margin: "md" } : null,
                                { type: "box", layout: "horizontal", spacing: "md", contents: [
                                    { type: "button", style: "primary", height: "sm", color: d.footer.btn1.color, action: { type: "uri", label: d.footer.btn1.label, uri: d.footer.btn1.uri } },
                                    { type: "button", style: "primary", height: "sm", color: d.footer.btn2.color, action: { type: "uri", label: d.footer.btn2.label, uri: d.footer.btn2.uri } }
                                ]}
                            ].filter(Boolean)}
                        };
                    }
                });
                return { type: "carousel", contents };
            }, [pages]);

            // --- 重要：解析器 (還原編輯狀態) ---
            const parseJsonToState = useCallback((json) => {
                if (!json) return;
                try {
                    const b = typeof json === 'string' ? JSON.parse(json) : json;
                    const items = b.type === 'carousel' ? b.contents : [b];
                    const restored = items.map(bubble => {
                        const body = bubble.body?.contents || [];
                        const isBusiness = body.some(c => c.contents?.[0]?.size === 'lg'); // 偵測特徵

                        if (isBusiness) {
                            const d = Utils.deepCopy(TEMPLATES.BUSINESS);
                            const bg = body.find(c => c.type === 'image' && c.aspectRatio === '2:3');
                            if (bg) d.url = bg.url;
                            const nameB = body.find(c => c.contents?.[0]?.size === 'lg');
                            if (nameB) { d.name = nameB.contents[0].text; d.nameColor = nameB.contents[0].color; d.nameAlign = nameB.contents[0].align; d.nameTop = parseInt(nameB.offsetTop); }
                            const socB = body.find(c => c.layout === 'horizontal');
                            if (socB) { d.socialTop = parseInt(socB.offsetTop); d.icons = socB.contents.map(c => { let type = "WEB"; Object.keys(SOCIAL_ICONS).forEach(k => { if(SOCIAL_ICONS[k].url === c.contents[0].url) type = k; }); return { type, uri: c.action?.uri }; }); }
                            if (bubble.footer) { const ft = bubble.footer.contents[0]; d.footerBg = bubble.footer.backgroundColor; d.footerLabel = ft.contents[0].text; d.footerThemeColor = ft.backgroundColor; d.footerTextColor = ft.contents[0].color; d.footerUri = ft.action?.uri; }
                            return d;
                        } else {
                            const d = Utils.deepCopy(TEMPLATES.ECOMMERCE);
                            if (bubble.hero) { d.hero.type = bubble.hero.type === 'video' ? 'video' : 'image'; d.hero.url = bubble.hero.url; d.hero.aspectRatio = bubble.hero.aspectRatio; }
                            d.body.bgColor = bubble.body?.backgroundColor || "#F8F8F8";
                            if (bubble.footer) { const ftText = bubble.footer.contents.find(c => c.type === 'text'); d.footer.textEnabled = !!ftText; if(ftText) d.footer.text = ftText.text; }
                            return d;
                        }
                    });
                    setPages(restored);
                    setActiveIdx(0);
                } catch (e) { console.error("Restore Error", e); }
            }, []);

            useEffect(() => {
                const handleMessage = (e) => { if (e.data?.type === 'LOAD_FLEX_DATA') parseJsonToState(e.data.json); };
                window.addEventListener('message', handleMessage);
                window.parent.postMessage({ type: 'CHILD_READY' }, '*');
                return () => window.removeEventListener('message', handleMessage);
            }, [parseJsonToState]);

            useEffect(() => {
                const currentJson = buildJson();
                window.parent.postMessage({ type: 'SYNC_FLEX_DATA', json: JSON.stringify(currentJson, null, 2) }, '*');
            }, [pages, buildJson]);

            const updateActivePage = useCallback((field, value) => {
                setPages(prev => {
                    const next = [...prev];
                    const keys = field.split('.');
                    let curr = { ...next[activeIdx] };
                    next[activeIdx] = curr;
                    for (let i = 0; i < keys.length - 1; i++) {
                        curr[keys[i]] = { ...curr[keys[i]] };
                        curr = curr[keys[i]];
                    }
                    curr[keys[keys.length - 1]] = value;
                    return next;
                });
            }, [activeIdx]);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [pages, activeIdx, activeTab]);

            return (
                <div className="flex h-screen overflow-hidden bg-slate-100 font-black text-black">
                    {/* 控制面板 */}
                    <div className="w-1/2 bg-white border-r flex flex-col shadow-xl z-10">
                        <div className="sticky-section flex flex-col gap-4">
                            <div className="flex items-center justify-between">
                                <h1 className="text-xl uppercase tracking-tighter flex items-center gap-2 text-green-600"><i data-lucide="layers"></i> 旗艦模組移植 v3.3.5</h1>
                                <div className="text-[10px] bg-slate-100 px-3 py-1 rounded-full text-slate-400">MAX 12 PAGES</div>
                            </div>
                            <div className="flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                                {pages.map((_, i) => (
                                    <div key={i} className="relative group shrink-0 flex items-center">
                                        <button onClick={() => setActiveIdx(i)} className={`px-4 py-2 rounded-l-xl border-2 border-r-0 transition-all text-xs font-black ${activeIdx === i ? 'page-tab-active shadow-sm' : 'border-slate-100 bg-slate-50'}`}>P{i+1}</button>
                                        <button onClick={() => { if(pages.length < 12) setPages([...pages, Utils.deepCopy(pages[i])]); setActiveIdx(pages.length); }} className={`px-2 py-2 border-2 border-l-0 rounded-r-xl transition-all hover:bg-green-600 hover:text-white ${activeIdx === i ? 'border-[#06C755]' : 'border-slate-100'}`} title="複刻此頁"><i data-lucide="copy" className="w-3.5 h-3.5"></i></button>
                                        {pages.length > 3 && <button onClick={() => { setPages(pages.filter((_, idx)=>idx!==i)); setActiveIdx(0); }} className="absolute -top-1.5 -right-1.5 bg-red-500 text-white p-0.5 rounded-full"><i data-lucide="x" className="w-2.5 h-2.5"></i></button>}
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6 custom-scrollbar">
                            {activePage.model === 'ECOMMERCE' ? (
                                <>
                                    <ControlPanel title="1. 頂部 Hero 視覺" icon="image">
                                        <div className="flex bg-slate-100 p-1 rounded-lg border mb-3">
                                            {['image', 'video', 'none'].map(t => <button key={t} onClick={() => updateActivePage('hero.type', t)} className={`flex-1 py-1.5 text-xs rounded ${activePage.hero.type === t ? 'bg-white shadow text-green-600' : 'text-slate-400'}`}>{t==='image'?'圖片':t==='video'?'影片':'無'}</button>)}
                                        </div>
                                        <input type="text" value={activePage.hero.url} onChange={e => updateActivePage('hero.url', e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 font-mono text-xs" placeholder="URL..." />
                                    </ControlPanel>
                                    <ControlPanel title="2. Body 背景與欄位" icon="grid">
                                        <div className="grid grid-cols-2 gap-3">
                                            <select value={activePage.body.columns} onChange={e => updateActivePage('body.columns', parseInt(e.target.value))} className="w-full p-2 border rounded-lg bg-white font-bold"><option value="3">3 欄網格</option><option value="4">4 欄網格</option></select>
                                            <input type="color" value={activePage.body.bgColor} onChange={e => updateActivePage('body.bgColor', e.target.value)} className="w-full h-10 p-1 border rounded-lg" />
                                        </div>
                                    </ControlPanel>
                                    <ControlPanel title="3. 商品網格管理" icon="shopping-bag">
                                        <button onClick={() => updateActivePage('body.items', [...activePage.body.items, { title: "新商品", img: "https://lihi.cc/mwMvo", url: "https://line.me" }])} className="w-full py-2 bg-slate-100 border-2 border-dashed border-slate-300 rounded-xl mb-4 hover:bg-slate-200">+ 新增商品</button>
                                        <div className="space-y-3">
                                            {activePage.body.items.map((item, i) => (
                                                <div key={i} className="p-3 bg-slate-50 border rounded-xl relative group">
                                                    <div className="flex gap-2"><img src={item.img} className="w-10 h-10 object-cover rounded" /><input type="text" value={item.title} onChange={e => { const n = [...activePage.body.items]; n[i].title = e.target.value; updateActivePage('body.items', n); }} className="flex-1 p-2 text-xs border rounded-lg" /></div>
                                                    <input type="text" value={item.url} onChange={e => { const n = [...activePage.body.items]; n[i].url = e.target.value; updateActivePage('body.items', n); }} className="w-full p-2 text-[10px] border rounded-lg mt-2 font-mono" />
                                                </div>
                                            ))}
                                        </div>
                                    </ControlPanel>
                                    <ControlPanel title="4. 底部設定" icon="mouse-pointer-2">
                                        <div className="space-y-3">
                                            <input type="text" value={activePage.footer.text} onChange={e => updateActivePage('footer.text', e.target.value)} className="w-full p-2 border rounded-lg" />
                                            <div className="grid grid-cols-2 gap-3">
                                                <input type="text" value={activePage.footer.btn1.label} onChange={e => updateActivePage('footer.btn1.label', e.target.value)} className="w-full p-2 border rounded-lg font-bold" />
                                                <input type="color" value={activePage.footer.btn1.color} onChange={e => updateActivePage('footer.btn1.color', e.target.value)} className="w-full h-10 p-1 border rounded-lg" />
                                            </div>
                                        </div>
                                    </ControlPanel>
                                </>
                            ) : (
                                <>
                                    <ControlPanel title="1. 媒體層設定" icon="image">
                                        <label className="control-label block mb-1">背景底圖網址</label>
                                        <input type="text" value={activePage.url} onChange={e => updateActivePage('url', e.target.value)} className="w-full p-3 border rounded-xl bg-slate-50 font-mono text-xs" />
                                    </ControlPanel>
                                    <ControlPanel title="2. 主控連動位移" icon="move-vertical" headerClass="amber-header">
                                        <div className="flex justify-between items-center mb-1"><label className="control-label">垂直位置</label><span className="slider-value-display">{activePage.avatarTop}px</span></div>
                                        <input type="range" min="0" max="600" value={activePage.avatarTop} onChange={e => {
                                            const newTop = parseInt(e.target.value);
                                            const diff = newTop - activePage.avatarTop;
                                            setPages(prev => { const n = [...prev]; n[activeIdx] = {...n[activeIdx], avatarTop: newTop, nameTop: n[activeIdx].nameTop + diff, label1Top: n[activeIdx].label1Top + diff, socialTop: n[activeIdx].socialTop + diff, descTop: n[activeIdx].descTop + diff }; return n; });
                                        }} className="w-full master-slider" />
                                    </ControlPanel>
                                    <ControlPanel title="3. 姓名設定 (鎖定: LG)" icon="user">
                                        <div className="flex gap-2"><input type="text" value={activePage.name} onChange={e => updateActivePage('name', e.target.value)} className="flex-1 p-2 border rounded-lg font-bold" /><input type="color" value={activePage.nameColor} onChange={e => updateActivePage('nameColor', e.target.value)} className="w-10 h-10 p-1 border rounded-lg bg-white" /></div>
                                    </ControlPanel>
                                    <ControlPanel title="4. 狀態消息 / 職稱" icon="bookmark">
                                        <input type="text" value={activePage.label1} onChange={e => updateActivePage('label1', e.target.value)} className="w-full p-2 border rounded-lg" />
                                        <div className="grid grid-cols-2 gap-3 mt-2">
                                            <input type="color" value={activePage.label1Color} onChange={e => updateActivePage('label1Color', e.target.value)} className="w-full h-8 p-1 border rounded" />
                                            <input type="color" value={activePage.label1Bg} onChange={e => updateActivePage('label1Bg', e.target.value)} className="w-full h-8 p-1 border rounded" />
                                        </div>
                                    </ControlPanel>
                                    <ControlPanel title="5. 社群快捷設定" icon="share-2">
                                        {activePage.icons.map((icon, i) => (
                                            <div key={i} className="bg-slate-50 p-3 border rounded-xl mb-3">
                                                <div className="flex gap-2 overflow-x-auto pb-1 custom-scrollbar">
                                                    {Object.keys(SOCIAL_ICONS).map(k => <button key={k} onClick={() => { const n = [...activePage.icons]; n[i].type = k; updateActivePage('icons', n); }} className={`p-2 rounded border shrink-0 ${icon.type === k ? 'border-green-600 bg-green-50' : 'bg-white opacity-40'}`}><img src={SOCIAL_ICONS[k].url} className="w-5 h-5 object-contain" /></button>)}
                                                </div>
                                                <input type="text" value={icon.uri} onChange={e => { const n = [...activePage.icons]; n[i].uri = e.target.value; updateActivePage('icons', n); }} className="w-full p-2 text-xs border rounded bg-white mt-2 font-mono" />
                                            </div>
                                        ))}
                                    </ControlPanel>
                                    <ControlPanel title="6. 說明排版 (鎖定: XS)" icon="align-left">
                                        <textarea value={activePage.desc} onChange={e => updateActivePage('desc', e.target.value)} className="w-full p-2 border rounded-lg h-24" />
                                    </ControlPanel>
                                    <ControlPanel title="7. Footer 按鈕與背景" icon="mouse-pointer">
                                        <div className="grid grid-cols-2 gap-3">
                                            <input type="color" value={activePage.footerBg} onChange={e => updateActivePage('footerBg', e.target.value)} className="w-full h-10 p-1 border rounded-lg bg-white" />
                                            <input type="color" value={activePage.footerThemeColor} onChange={e => updateActivePage('footerThemeColor', e.target.value)} className="w-full h-10 p-1 border rounded-lg bg-white" />
                                        </div>
                                    </ControlPanel>
                                </>
                            )}
                        </div>
                    </div>

                    {/* 預覽區 */}
                    <div className="flex-1 flex flex-col chat-room-bg overflow-hidden relative font-black">
                        <div className="h-[70px] bg-white border-b flex items-center px-10 gap-10 shrink-0 z-30 shadow-sm">
                            <button onClick={() => setActiveTab('editor')} className={`text-sm ${activeTab === 'editor' ? 'text-green-600 border-b-4 border-green-600' : 'text-slate-400'}`}>視覺預覽 (P{activeIdx+1})</button>
                            <button onClick={() => setActiveTab('json')} className={`text-sm ${activeTab === 'json' ? 'text-green-600 border-b-4 border-green-600' : 'text-slate-400'}`}>JSON 代碼</button>
                            <div className="flex-1"></div>
                            <button onClick={() => { navigator.clipboard.writeText(JSON.stringify(buildJson(), null, 2)); setCopyStatus("已複製！"); setTimeout(()=>setCopyStatus("複製 JSON"), 2000); }} className="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-2 rounded-xl text-xs flex items-center gap-2 transition-all shadow-lg active:scale-95"><i data-lucide="copy" className="w-4 h-4"></i> {copyStatus}</button>
                        </div>
                        <div className="flex-1 overflow-y-auto">
                            <div className="py-12 flex flex-col items-center min-h-full">
                                <div className="mb-8 px-6 py-2 bg-slate-900/90 text-white rounded-full text-[10px] tracking-[0.2em] font-black uppercase flex items-center gap-3 shadow-2xl border border-white/10">
                                    <div className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                                    CAROUSEL LIVE PREVIEW ({activePage.model})
                                </div>
                                <FlexPreview data={activePage} />
                                <div className="mt-8 flex gap-2">
                                    {pages.map((_, i) => <div key={i} className={`w-2 h-2 rounded-full transition-all ${activeIdx === i ? 'w-8 bg-white shadow-lg' : 'bg-white/30'}`}></div>)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>
