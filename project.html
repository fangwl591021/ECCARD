<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專案查詢管理 - LINEOA CMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; overflow: hidden; }
        .sidebar-container { background-color: #1e2124; height: 100vh; width: 256px; display: flex; flex-direction: column; flex-shrink: 0; z-index: 50; }
        .sidebar-item-active { background-color: #374151; color: white; border-left: 4px solid #00B900; }
        .line-green { color: #00B900; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

<div id="app" class="flex h-screen overflow-hidden text-gray-800">
    <!-- 側邊欄 -->
    <aside class="sidebar-container text-gray-400 shadow-2xl">
        <div class="h-16 flex items-center px-6 border-b border-gray-700 shrink-0">
            <i class="fab fa-line text-3xl line-green"></i>
            <span class="ml-4 text-white font-bold whitespace-nowrap tracking-tighter uppercase font-mono">CMS Project</span>
        </div>
        <nav class="mt-6 flex-grow overflow-y-auto no-scrollbar whitespace-nowrap">
            <a href="index.html" class="flex items-center py-4 px-6 hover:bg-gray-700 transition-colors">
                <i class="fas fa-home w-8 text-center"></i>
                <span class="ml-2 font-medium">返回主儀表板</span>
            </a>
            <div class="sidebar-item-active flex items-center py-4 px-6 mt-4">
                <i class="fas fa-folder-open w-8 text-center"></i>
                <span class="ml-2 font-medium">專案查詢管理</span>
            </div>
        </nav>
    </aside>

    <main class="flex-grow flex flex-col h-full bg-[#f8fafc] overflow-hidden">
        <header class="h-16 bg-white border-b flex items-center justify-between px-8 shrink-0 shadow-sm">
            <div class="flex items-center gap-4">
                <h2 class="text-xl font-bold text-gray-800 tracking-tighter">已儲存專案查詢</h2>
                <div class="flex items-center gap-2 px-3 py-1 bg-green-50 rounded-full border border-green-100">
                    <div class="w-2 h-2 rounded-full bg-green-500"></div>
                    <span class="text-[10px] text-green-700 font-bold uppercase tracking-widest">Live Connect</span>
                </div>
            </div>
            <button @click="fetchProjects" class="px-5 py-2 border border-gray-200 rounded-xl text-sm font-bold hover:bg-gray-50 transition-all flex items-center gap-2">
                <i class="fas fa-sync-alt" :class="{'animate-spin': loading}"></i> 重新整理
            </button>
        </header>

        <div class="flex-grow flex overflow-hidden">
            <!-- 專案清單 -->
            <div class="w-1/3 border-r bg-white flex flex-col overflow-hidden shadow-xl z-10">
                <div class="p-4 border-b bg-gray-50 flex items-center gap-2">
                    <i class="fas fa-search text-gray-300"></i>
                    <input type="text" v-model="searchQuery" class="bg-transparent text-sm outline-none w-full" placeholder="關鍵字查詢...">
                </div>
                
                <div class="flex-grow overflow-y-auto no-scrollbar">
                    <div v-if="loading" class="p-20 text-center text-gray-400">
                        <i class="fas fa-circle-notch animate-spin text-3xl mb-4"></i>
                        <p class="text-xs font-bold uppercase tracking-widest">正在從雲端抓取...</p>
                    </div>
                    <!-- 初始為空狀態 -->
                    <div v-else-if="filteredProjects.length === 0" class="p-20 text-center text-gray-400">
                        <i class="fas fa-folder-open text-4xl mb-4 opacity-10"></i>
                        <p class="text-sm">目前試算表中無資料</p>
                    </div>
                    <!-- 真實資料呈現 -->
                    <div v-else v-for="p in filteredProjects" :key="p.cardId" 
                        @click="selectProject(p)"
                        :class="selectedProject?.cardId === p.cardId ? 'bg-blue-50 border-l-4 border-blue-500' : 'hover:bg-gray-50 border-l-4 border-transparent'"
                        class="p-5 border-b cursor-pointer transition-all">
                        <div class="flex justify-between items-start mb-1">
                            <h4 class="font-bold text-gray-800">{{ p.cardTitle || '無標題專案' }}</h4>
                            <span :class="getTypeBadgeClass(p.cardType)" class="text-[9px] px-2 py-0.5 rounded font-bold uppercase">{{ p.cardType || 'unknown' }}</span>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-[9px] text-gray-400 font-mono tracking-tighter">{{ p.updatedAt || p.createdAt || '時間未知' }}</span>
                            <button @click.stop="deleteProject(p)" class="text-gray-300 hover:text-red-500 transition-colors px-2"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 專案細節：JSON 代碼 -->
            <div class="flex-grow flex flex-col bg-[#f8fafc] overflow-hidden">
                <div v-if="selectedProject" class="flex-grow flex flex-col p-8 overflow-hidden animate-in fade-in duration-500">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800 tracking-tighter">{{ selectedProject.cardTitle }}</h3>
                            <p class="text-[10px] text-gray-500 mt-1 uppercase font-mono tracking-widest">Card ID: {{ selectedProject.cardId }}</p>
                        </div>
                        <div class="flex gap-2">
                            <button @click="copyJson" class="px-5 py-2 bg-slate-800 text-white rounded-xl text-sm font-bold shadow-lg hover:bg-black transition-all flex items-center gap-2">
                                <i class="fas fa-copy"></i> 複製參數 (cardJson)
                            </button>
                        </div>
                    </div>

                    <div class="flex-grow flex flex-col bg-[#1e2124] rounded-2xl border border-gray-800 shadow-2xl overflow-hidden relative">
                        <div class="px-5 py-3 border-b border-gray-700 flex justify-between items-center bg-[#25282c]">
                            <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">JSON Configuration</span>
                        </div>
                        <pre class="flex-grow p-6 text-green-400 text-xs font-mono overflow-y-auto no-scrollbar select-all">{{ formattedJson }}</pre>
                    </div>
                </div>

                <div v-else class="flex-grow flex flex-col items-center justify-center text-gray-300">
                    <i class="fas fa-search-location text-8xl mb-6 opacity-10"></i>
                    <h3 class="text-xl font-bold uppercase tracking-widest">Select Project</h3>
                    <p class="text-xs mt-2 tracking-widest">請從左側列表點選專案以檢視儲存內容</p>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

// --- 請務必確認 Worker 網址正確 ---
const workerUrl = "https://lineoa.fangwl591021.workers.dev";

createApp({
    setup() {
        const loading = ref(false);
        const searchQuery = ref('');
        const projects = ref([]);
        const selectedProject = ref(null);

        const fetchProjects = async () => {
            loading.value = true;
            try {
                // 改用 POST 請求並帶入 action: 'getProjects'
                const res = await fetch(workerUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'getProjects' })
                });
                
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                
                const result = await res.json();
                
                // 修正：增加對 result.data 的檢查，防止 undefined 引發 reverse() 錯誤
                if (result.status === 'success' && result.data) {
                    // 確保資料是陣列後再反轉，若不是則設為空陣列
                    projects.value = Array.isArray(result.data) ? [...result.data].reverse() : [];
                } else {
                    console.error("GAS 錯誤或資料格式不正確:", result.message || "未知原因");
                    projects.value = [];
                }
            } catch (e) {
                console.error("網路或 Worker 錯誤:", e.message);
                projects.value = [];
            } finally {
                loading.value = false;
            }
        };

        const filteredProjects = computed(() => {
            return projects.value.filter(p => {
                const title = p.cardTitle || '';
                return title.toLowerCase().includes(searchQuery.value.toLowerCase());
            });
        });

        const formattedJson = computed(() => {
            if (!selectedProject.value) return '';
            try {
                // 如果 cardJson 是字串則解析，如果是物件則直接排版
                const json = typeof selectedProject.value.cardJson === 'string' 
                    ? JSON.parse(selectedProject.value.cardJson) 
                    : selectedProject.value.cardJson;
                return JSON.stringify(json, null, 2);
            } catch (e) {
                return selectedProject.value.cardJson || '無有效資料';
            }
        });

        const selectProject = (p) => { selectedProject.value = p; };

        const deleteProject = async (p) => {
            if (confirm(`確定要刪除專案「${p.cardTitle}」嗎？`)) {
                try {
                    const res = await fetch(workerUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'delete', cardId: p.cardId })
                    });
                    const result = await res.json();
                    if (result.status === 'success') {
                        projects.value = projects.value.filter(proj => proj.cardId !== p.cardId);
                        if (selectedProject.value?.cardId === p.cardId) selectedProject.value = null;
                        alert("刪除成功");
                    } else {
                        alert("刪除失敗: " + result.message);
                    }
                } catch (e) { alert("刪除時發生網路連線失敗"); }
            }
        };

        const copyJson = () => {
            if (!formattedJson.value) return;
            navigator.clipboard.writeText(formattedJson.value);
            alert("參數 JSON 已複製！");
        };

        onMounted(fetchProjects);

        return {
            loading, searchQuery, projects, selectedProject,
            filteredProjects, fetchProjects, selectProject, deleteProject, formattedJson, copyJson,
            getTypeBadgeClass: (t) => ({ 
                'article': 'bg-blue-100 text-blue-600', 
                'ecommerce': 'bg-orange-100 text-orange-600' 
            }[t] || 'bg-gray-100 text-gray-600'),
            getTypeIcon: (t) => ({ 
                'article': 'fas fa-file-alt', 
                'ecommerce': 'fas fa-shopping-cart' 
            }[t] || 'fas fa-id-card')
        };
    }
}).mount('#app');
</script>
</body>
</html>
