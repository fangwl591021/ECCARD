<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專案管理中心 - LINEOA CMS</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; overflow: hidden; }
        .sidebar-container { background-color: #1e2124; height: 100vh; width: 280px; display: flex; flex-direction: column; flex-shrink: 0; z-index: 50; }
        .sidebar-item-active { background-color: #374151; color: white; border-left: 4px solid #00B900; }
        .line-green { color: #00B900; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 預覽區塊 */
        .chat-room-bg { background-color: #8c9bad; height: 100%; overflow-y: auto; padding: 40px 20px; display: flex; flex-direction: column; align-items: center; }
        .flex-bubble-container { width: 100%; max-width: 300px; position: relative; }
        .flex-bubble { background: #FFFFFF; border-radius: 14px; overflow: hidden; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); }
        .flex-badge-preview { position: absolute; top: 10px; right: 10px; color: white; padding: 5px 20px 3px 20px; border-radius: 30px; font-size: 11px; font-weight: bold; z-index: 20; box-shadow: 0 2px 8px rgba(0,0,0,0.2); white-space: nowrap; width: auto; }
        
        .input-label { @apply block text-[11px] font-bold text-gray-500 uppercase mb-1 ml-1 tracking-wider; }
        input[type="color"] { -webkit-appearance: none; border: none; width: 24px; height: 24px; cursor: pointer; background: none; }
    </style>
</head>
<body>

<div id="app" class="flex h-screen overflow-hidden text-gray-800">
    <!-- 左側選單：專案清單 -->
    <aside class="sidebar-container text-gray-400 shadow-2xl">
        <div class="h-16 flex items-center px-6 border-b border-gray-700 shrink-0">
            <i class="fab fa-line text-3xl line-green"></i>
            <span class="ml-4 text-white font-bold uppercase font-mono tracking-tighter">Project Manager</span>
        </div>
        
        <!-- 搜尋與過濾 -->
        <div class="p-4 border-b border-gray-700">
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-2.5 text-gray-600 text-xs"></i>
                <input type="text" v-model="searchQuery" class="w-full bg-gray-800 border-none rounded-lg py-2 pl-9 pr-4 text-xs text-white focus:ring-1 focus:ring-line-green" placeholder="搜尋專案名稱...">
            </div>
        </div>

        <nav class="flex-grow overflow-y-auto no-scrollbar">
            <div v-if="loading" class="p-10 text-center text-xs uppercase tracking-widest opacity-50">載入中...</div>
            <div v-else-if="projects.length === 0" class="p-10 text-center text-xs opacity-30">無資料</div>
            <div v-for="p in filteredProjects" :key="p.cardId" 
                @click="loadProject(p)"
                :class="selectedProject?.cardId === p.cardId ? 'bg-gray-700 text-white border-l-4 border-line-green' : 'hover:bg-gray-800'"
                class="px-6 py-4 border-b border-gray-800/50 cursor-pointer transition-all group">
                <div class="flex justify-between items-start mb-1">
                    <h4 class="text-sm font-bold truncate pr-2">{{ p.cardTitle }}</h4>
                    <span class="text-[8px] px-1.5 py-0.5 rounded bg-gray-600 text-gray-300 font-bold uppercase">{{ p.cardType }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-[9px] opacity-40 font-mono">{{ p.updatedAt?.split('T')[0] || '---' }}</span>
                    <button @click.stop="deleteProject(p)" class="opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-500 p-1 transition-all"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>
        </nav>
        
        <a href="index.html" class="p-4 text-center border-t border-gray-700 text-xs font-bold hover:text-white transition-colors">
            <i class="fas fa-arrow-left mr-2"></i> 返回主儀表板
        </a>
    </aside>

    <!-- 主要區域 -->
    <main class="flex-grow flex overflow-hidden bg-white">
        <!-- 如果沒選專案 -->
        <div v-if="!selectedProject" class="flex-grow flex flex-col items-center justify-center text-gray-300 bg-[#f8fafc]">
            <i class="fas fa-folder-open text-8xl mb-6 opacity-10"></i>
            <h3 class="text-xl font-bold uppercase tracking-widest">Select a Project</h3>
            <p class="text-xs mt-2">請點擊左側列表專案開始編輯</p>
        </div>

        <!-- 編輯中心 -->
        <div v-else class="flex-grow flex h-full overflow-hidden">
            <!-- 編輯表單 (中) -->
            <div class="flex-grow flex flex-col border-r overflow-hidden">
                <header class="h-16 border-b flex items-center justify-between px-8 shrink-0 bg-white shadow-sm z-10">
                    <div class="flex flex-col">
                        <input type="text" v-model="editState.cardTitle" class="text-xl font-bold text-gray-800 border-none p-0 focus:ring-0 w-64" placeholder="專案標題">
                        <span class="text-[10px] text-gray-400 uppercase font-mono tracking-widest">ID: {{ editState.cardId }}</span>
                    </div>
                    <div class="flex gap-3">
                        <button @click="updateProject" :disabled="isSaving" class="px-5 py-2 bg-line-green text-white rounded-xl text-sm font-bold shadow-lg hover:brightness-110 flex items-center gap-2 transition-all">
                            <i v-if="isSaving" class="fas fa-circle-notch animate-spin"></i>
                            <i v-else class="fas fa-cloud-upload-alt"></i> 更新雲端
                        </button>
                        <button @click="pushProject" class="px-6 py-2 bg-blue-500 text-white rounded-xl text-sm font-bold shadow-lg hover:bg-blue-600 flex items-center gap-2 transition-all">
                            <i class="fas fa-paper-plane"></i> 執行推播
                        </button>
                    </div>
                </header>

                <div class="flex-grow overflow-y-auto p-8 no-scrollbar bg-[#f8fafc]">
                    <!-- 動態表單：根據 cardType 切換 -->
                    <div class="max-w-3xl mx-auto space-y-8">
                        
                        <!-- 1. 文章型編輯表單 -->
                        <div v-if="editState.cardType === 'article'" class="space-y-6">
                            <div class="bg-white p-6 rounded-2xl border shadow-sm space-y-4">
                                <div><label class="input-label">主視覺圖片</label><input type="text" v-model="editState.params.imageUrl" class="w-full border rounded-lg p-2 text-sm shadow-sm"></div>
                                <div class="bg-slate-50 p-4 rounded-xl border border-dashed space-y-3">
                                    <label class="text-xs font-bold text-gray-600 flex items-center gap-2 cursor-pointer"><input type="checkbox" v-model="editState.params.showBadge" class="accent-line-green"> 顯示右上標籤</label>
                                    <div v-if="editState.params.showBadge" class="grid grid-cols-2 gap-3 pl-6">
                                        <input type="text" v-model="editState.params.badgeText" class="border rounded p-1.5 text-xs" placeholder="標籤文字">
                                        <input type="color" v-model="editState.params.badgeColor" class="w-full">
                                    </div>
                                </div>
                                <div><label class="input-label">標題 (30字)</label><input type="text" v-model="editState.params.title" maxlength="30" class="w-full border rounded-lg p-2 text-sm font-bold shadow-sm"></div>
                                <div><label class="input-label">描述內容 (xs)</label><textarea v-model="editState.params.subtitle" rows="5" class="w-full border rounded-lg p-2 text-sm shadow-sm"></textarea></div>
                            </div>
                        </div>

                        <!-- 2. 電商型編輯表單 (簡化版) -->
                        <div v-if="editState.cardType === 'ecommerce'" class="space-y-6">
                            <div class="bg-white p-6 rounded-2xl border shadow-sm space-y-4">
                                <h4 class="text-sm font-bold">電商視覺配置</h4>
                                <div class="flex bg-slate-100 p-1 rounded-lg border mb-2">
                                    <button v-for="t in ['image', 'video']" @click="editState.params.heroType = t" :class="editState.params.heroType===t?'bg-white shadow-sm text-line-green':'text-gray-400'" class="flex-1 py-1.5 text-xs font-bold rounded transition-all capitalize">{{t}}</button>
                                </div>
                                <input type="text" v-model="editState.params.heroUrl" class="w-full border rounded p-2 text-xs" placeholder="圖片網址">
                                <input v-if="editState.params.heroType==='video'" type="text" v-model="editState.params.heroVideoUrl" class="w-full border rounded p-2 text-xs" placeholder="影片網址">
                            </div>
                        </div>

                        <!-- 共同欄位：底部按鈕 -->
                        <div class="bg-white p-6 rounded-2xl border shadow-sm">
                            <h4 class="text-sm font-bold mb-4 flex justify-between items-center"><span>底部按鈕設定</span><button @click="addButton" class="text-xs text-line-green font-bold">+ 新增</button></h4>
                            <div class="space-y-3">
                                <div v-for="(btn, idx) in editState.params.buttons" :key="idx" class="flex gap-3 items-center bg-slate-50 p-3 rounded-xl border group transition-all">
                                    <input type="color" v-model="btn.color"><input type="text" v-model="btn.label" class="w-32 border rounded p-1 text-sm font-bold"><input type="text" v-model="btn.uri" class="flex-1 border rounded p-1 text-sm">
                                    <button @click="editState.params.buttons.splice(idx,1)" class="text-gray-300 hover:text-red-500 transition-colors"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 即時預覽 (右) -->
            <div class="w-[420px] shrink-0 chat-room-bg no-scrollbar shadow-inner border-l">
                <div class="mb-6 text-[10px] font-bold text-white/40 uppercase tracking-[0.3em] text-center">Live Preview Mode</div>
                <div class="flex-bubble-container">
                    <!-- 文章型預覽 -->
                    <div v-if="editState.cardType === 'article'" class="flex-bubble animate-in zoom-in duration-300">
                        <div class="relative w-full overflow-hidden">
                            <img :src="editState.params.imageUrl" class="w-full aspect-[20/13] object-cover">
                            <div v-if="editState.params.showBadge" class="flex-badge-preview" :style="{ backgroundColor: editState.params.badgeColor }">{{ editState.params.badgeText }}</div>
                        </div>
                        <div class="p-[5px] text-center">
                            <div class="text-base font-bold truncate mt-1">{{ editState.params.title || '標題內容' }}</div>
                            <div class="text-[9px] text-gray-500 mt-2 whitespace-pre-wrap leading-relaxed px-1">{{ editState.params.subtitle || '描述內容...' }}</div>
                        </div>
                        <div class="p-1.5 space-y-1" style="padding: 5px !important;"><button v-for="btn in editState.params.buttons" class="w-full py-1.5 text-white text-[10px] font-bold rounded shadow-sm" :style="{ backgroundColor: btn.color }">{{ btn.label }}</button></div>
                    </div>
                    
                    <!-- 電商型預覽略 (同理可證) -->
                    <div v-if="editState.cardType === 'ecommerce'" class="text-white text-center p-20 opacity-20">電商型預覽加載中...</div>
                </div>
                <div class="mt-auto bg-black/10 text-white/30 text-[9px] py-4 text-center w-full uppercase tracking-tighter">Syncing with Google Sheet ID: 1qQjIMf8...</div>
            </div>
        </div>
    </main>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

const workerUrl = "https://lineoa.fangwl591021.workers.dev";

const forceHttps = (u) => { 
    if (!u || u.trim() === "" || u === "#") return "https://line.me"; 
    let url = u.trim(); 
    if (url.startsWith("http://")) return url.replace("http://", "https://"); 
    return url.startsWith("https://") ? url : "https://" + url; 
};

createApp({
    setup() {
        const loading = ref(false);
        const isSaving = ref(false);
        const searchQuery = ref('');
        const projects = ref([]);
        const selectedProject = ref(null);
        
        // 編輯器的內部狀態
        const editState = ref({ cardId: '', cardTitle: '', cardType: '', params: {} });

        // 撈取專案
        const fetchProjects = async () => {
            loading.value = true;
            try {
                const res = await fetch(workerUrl, { method: 'POST', body: JSON.stringify({ action: 'getProjects' }) });
                const result = await res.json();
                if (result.status === 'success') projects.value = result.data.reverse();
            } catch (e) { console.error(e); }
            finally { loading.value = false; }
        };

        const filteredProjects = computed(() => projects.value.filter(p => (p.cardTitle||'').toLowerCase().includes(searchQuery.value.toLowerCase())));

        // 加載專案至編輯器
        const loadProject = (p) => {
            selectedProject.value = p;
            let params = {};
            try {
                // 嘗試從 cardJson 解析參數，或者從標題列映射
                const fullJson = typeof p.cardJson === 'string' ? JSON.parse(p.cardJson) : p.cardJson;
                
                // 簡易映射邏輯：從 Flex 結構還原回編輯器參數
                if (p.cardType === 'article') {
                    params = {
                        imageUrl: p['hero.image.url'] || '',
                        title: p['header.subtitle'] || p.cardTitle,
                        subtitle: p['header.description'] || '',
                        showBadge: true,
                        badgeText: 'HOT',
                        badgeColor: '#FF0000',
                        buttons: fullJson.footer?.contents?.map(c => ({ label: c.action.label, uri: c.action.uri, color: c.color })) || []
                    };
                } else {
                    params = { heroType: 'image', heroUrl: p['hero.image.url'], buttons: [] };
                }
            } catch (e) { params = { error: '解析失敗', buttons: [] }; }
            
            editState.value = { cardId: p.cardId, cardTitle: p.cardTitle, cardType: p.cardType, params };
        };

        // 更新至雲端 (覆蓋)
        const updateProject = async () => {
            isSaving.value = true;
            // 重新構造 Flex JSON
            const newFlex = generateFlex(editState.value);
            const payload = {
                action: 'update',
                cardId: editState.value.cardId,
                cardTitle: editState.value.cardTitle,
                'header.subtitle': editState.value.params.title,
                'header.description': editState.value.params.subtitle,
                'hero.image.url': editState.value.params.imageUrl,
                cardJson: JSON.stringify(newFlex),
                updatedAt: new Date().toISOString()
            };

            try {
                const res = await fetch(workerUrl, { method: 'POST', body: JSON.stringify(payload) });
                const result = await res.json();
                if (result.status === 'success') {
                    alert("專案已成功更新至試算表！");
                    fetchProjects();
                }
            } catch (e) { alert("更新失敗"); }
            finally { isSaving.value = false; }
        };

        // 執行推播
        const pushProject = async () => {
            const flex = generateFlex(editState.value);
            if (!liff.isLoggedIn()) { liff.login(); return; }
            liff.shareTargetPicker([{ type: "flex", altText: editState.value.cardTitle, contents: flex }])
            .then(res => { if (res) alert("推播成功！"); });
        };

        const addButton = () => {
            if(!editState.value.params.buttons) editState.value.params.buttons = [];
            editState.value.params.buttons.push({ label: '了解更多', uri: 'https://line.me', color: '#00B900' });
        };

        // 輔助：根據目前編輯狀態生成 Flex JSON
        const generateFlex = (s) => {
            if (s.cardType === 'article') {
                return {
                    type: "bubble", body: { type: "box", layout: "vertical", paddingAll: "0px", contents: [
                        { type: "image", url: forceHttps(s.params.imageUrl), size: "full", aspectRatio: "20:13", aspectMode: "cover" },
                        { type: "box", layout: "vertical", paddingAll: "5px", contents: [
                            { type: "text", text: s.params.title || "標題", weight: "bold", size: "xl", align: "center", wrap: true },
                            { type: "text", text: s.params.subtitle || "描述", size: "xs", margin: "sm", color: "#666666", wrap: true }
                        ]}
                    ]},
                    footer: { type: "box", layout: "vertical", spacing: "sm", paddingAll: "5px", contents: s.params.buttons.map(b => ({ type: "button", style: "primary", color: b.color, height: "sm", action: { type: "uri", label: b.label, uri: forceHttps(b.uri) } })) }
                };
            }
            return { type: "bubble", body: { type: "text", text: "Unsupported Type" } };
        };

        const deleteProject = async (p) => {
            if (!confirm(`確定刪除「${p.cardTitle}」？`)) return;
            await fetch(workerUrl, { method: 'POST', body: JSON.stringify({ action: 'delete', cardId: p.cardId }) });
            fetchProjects();
            selectedProject.value = null;
        };

        onMounted(() => { 
            liff.init({ liffId: "2008541971-Wgvz6gD8" });
            fetchProjects(); 
        });

        return { 
            loading, projects, filteredProjects, searchQuery, selectedProject, editState, 
            loadProject, updateProject, pushProject, addButton, isSaving, deleteProject,
            getTypeBadgeClass: (t) => t === 'article' ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600'
        };
    }
}).mount('#app');
</script>
</body>
</html>
