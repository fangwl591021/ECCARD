<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¡ˆç®¡ç†ä¸­å¿ƒ - LINEOA CMS</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; overflow: hidden; }
        .sidebar-container { background-color: #1e2124; height: 100vh; width: 280px; display: flex; flex-direction: column; flex-shrink: 0; z-index: 50; }
        .sidebar-item-active { background-color: #374151; color: white; border-left: 4px solid #00B900; }
        .line-green { color: #00B900; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .chat-room-bg { background-color: #8c9bad; height: 100%; overflow-y: auto; padding: 40px 20px; display: flex; flex-direction: column; align-items: center; }
        .flex-bubble-container { width: 100%; max-width: 300px; position: relative; }
        .flex-bubble { background: #FFFFFF; border-radius: 14px; overflow: hidden; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); }
        
        .flex-badge-preview { position: absolute; top: 10px; right: 10px; color: white; padding: 5px 20px 3px 20px; border-radius: 30px; font-size: 11px; font-weight: bold; z-index: 20; box-shadow: 0 2px 8px rgba(0,0,0,0.2); white-space: nowrap; width: auto; }
        
        .header-box { padding: 10px; display: flex; align-items: center; gap: 10px; }
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; }
        .grid-item { padding: 8px; border-radius: 10px; text-align: center; }

        .input-label { @apply block text-[11px] font-bold text-gray-500 uppercase mb-1 ml-1 tracking-wider; }
        input[type="color"] { -webkit-appearance: none; border: none; width: 24px; height: 24px; cursor: pointer; background: none; }
        input[type="color"]::-webkit-color-swatch { border-radius: 4px; border: 1px solid #ddd; }
        
        .btn-update { background-color: #059669; color: #ffffff !important; font-weight: 900; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .btn-update:hover { background-color: #047857; }
        .btn-update:disabled { background-color: #6ee7b7; cursor: not-allowed; }
    </style>
</head>
<body>

<div id="app" class="flex h-screen overflow-hidden text-gray-800">
    <!-- å·¦å´é¸å–® -->
    <aside class="sidebar-container text-gray-400 shadow-2xl">
        <div class="h-16 flex items-center px-6 border-b border-gray-700 shrink-0">
            <i class="fab fa-line text-3xl line-green"></i>
            <span class="ml-4 text-white font-bold uppercase font-mono tracking-tighter">Project Manager</span>
        </div>
        
        <div class="p-4 border-b border-gray-700">
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-2.5 text-gray-600 text-xs"></i>
                <input type="text" v-model="searchQuery" class="w-full bg-gray-800 border-none rounded-lg py-2 pl-9 pr-4 text-xs text-white focus:ring-1 focus:ring-line-green shadow-inner" placeholder="æœå°‹å°ˆæ¡ˆåç¨±...">
            </div>
        </div>

        <nav class="flex-grow overflow-y-auto no-scrollbar">
            <div v-if="loading" class="p-10 text-center text-xs uppercase tracking-widest opacity-50">è¼‰å…¥é›²ç«¯åˆ—è¡¨ä¸­...</div>
            <div v-else-if="projects.length === 0" class="p-10 text-center text-xs opacity-30">ç›®å‰å°šç„¡å°ˆæ¡ˆ</div>
            <div v-for="p in filteredProjects" :key="p.cardId" 
                @click="loadProject(p)"
                :class="selectedProject?.cardId === p.cardId ? 'bg-gray-700 text-white border-l-4 border-line-green shadow-xl' : 'hover:bg-gray-800'"
                class="px-6 py-4 border-b border-gray-800/50 cursor-pointer transition-all group">
                <div class="flex justify-between items-start mb-1">
                    <h4 class="text-sm font-bold truncate pr-2">{{ p.cardTitle }}</h4>
                    <span class="text-[8px] px-1.5 py-0.5 rounded bg-gray-600 text-gray-300 font-bold uppercase shrink-0">{{ p.cardType }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-[9px] opacity-40 font-mono">{{ formatDate(p.updatedAt || p.createdAt) }}</span>
                    <button @click.stop="deleteProject(p)" class="opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-500 p-1 transition-all"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>
        </nav>
        
        <a href="index.html" class="p-4 text-center border-t border-gray-700 text-xs font-bold hover:text-white transition-colors">
            <i class="fas fa-arrow-left mr-2"></i> è¿”å›ä¸»å„€è¡¨æ¿
        </a>
    </aside>

    <!-- ä¸»è¦ç·¨è¼¯å€åŸŸ -->
    <main class="flex-grow flex overflow-hidden bg-white">
        <div v-if="!selectedProject" class="flex-grow flex flex-col items-center justify-center text-gray-300 bg-[#f8fafc]">
            <i class="fas fa-folder-open text-8xl mb-6 opacity-10"></i>
            <h3 class="text-xl font-bold uppercase tracking-widest">Select a Project</h3>
            <p class="text-xs mt-2">è«‹å¾å·¦å´åˆ—è¡¨é¸æ“‡å°ˆæ¡ˆé–‹å§‹é€²è¡Œé›²ç«¯ç·¨è¼¯</p>
        </div>

        <div v-else class="flex-grow flex h-full overflow-hidden">
            <!-- ç·¨è¼¯è¡¨å–® -->
            <div class="flex-grow flex flex-col border-r overflow-hidden shadow-sm">
                <header class="h-16 border-b flex items-center justify-between px-8 shrink-0 bg-white shadow-sm z-10">
                    <div class="flex flex-col overflow-hidden">
                        <input type="text" v-model="editState.cardTitle" class="text-xl font-bold text-gray-800 border-none p-0 focus:ring-0 w-64 truncate" placeholder="å°ˆæ¡ˆæ¨™é¡Œ">
                        <span class="text-[10px] text-gray-400 uppercase font-mono tracking-widest">ID: {{ editState.cardId }}</span>
                    </div>
                    <div class="flex gap-3">
                        <button @click="updateProject" :disabled="isSaving" class="px-6 py-2 btn-update rounded-xl text-sm shadow-md flex items-center gap-2 transition-all">
                            <i v-if="isSaving" class="fas fa-circle-notch animate-spin"></i>
                            <i v-else class="fas fa-cloud-upload-alt"></i> æ›´æ–°é›²ç«¯è³‡æ–™
                        </button>
                        <button @click="pushProject" class="px-6 py-2 bg-blue-600 text-white rounded-xl text-sm font-bold shadow-md hover:bg-blue-700 flex items-center gap-2 transition-all">
                            <i class="fas fa-paper-plane"></i> åŸ·è¡Œæ¨æ’­
                        </button>
                    </div>
                </header>

                <div class="flex-grow overflow-y-auto p-8 no-scrollbar bg-[#f8fafc]">
                    <div class="max-w-3xl mx-auto space-y-8 pb-10">
                        
                        <!-- 1. æ–‡ç« å‹ç·¨è¼¯ (Article) -->
                        <div v-if="editState.cardType === 'article'" class="space-y-6 animate-in fade-in">
                            <div class="bg-white p-6 rounded-2xl border shadow-sm space-y-4">
                                <label class="input-label">ä¸»è¦–è¦ºåœ–ç‰‡ç¶²å€</label><input type="text" v-model="editState.params.imageUrl" class="w-full border rounded-lg p-2 text-sm shadow-sm focus:border-line-green">
                                <div class="bg-slate-50 p-4 rounded-xl border border-dashed space-y-3 shadow-inner">
                                    <label class="text-xs font-bold text-gray-600 flex items-center gap-2 cursor-pointer"><input type="checkbox" v-model="editState.params.showBadge" class="accent-line-green"> é¡¯ç¤ºå³ä¸Šæ¨™ç±¤</label>
                                    <div v-if="editState.params.showBadge" class="grid grid-cols-2 gap-3 pl-6">
                                        <input type="text" v-model="editState.params.badgeText" class="border rounded p-1.5 text-xs shadow-sm" placeholder="æ¨™ç±¤æ–‡å­—">
                                        <input type="color" v-model="editState.params.badgeColor" class="w-full">
                                    </div>
                                </div>
                                <label class="input-label">æ¨™é¡Œå…§å®¹ (30å­—)</label><input type="text" v-model="editState.params.title" maxlength="30" class="w-full border rounded-lg p-2 text-sm font-bold focus:border-line-green">
                                <label class="input-label">æè¿°å…§å®¹ (xs å­—ç´š)</label><textarea v-model="editState.params.subtitle" rows="5" class="w-full border rounded-lg p-2 text-sm focus:border-line-green"></textarea>
                            </div>
                        </div>

                        <!-- 2. å½±ç‰‡åç‰‡ç·¨è¼¯ (Card) -->
                        <div v-if="editState.cardType === 'card'" class="space-y-6 animate-in fade-in">
                            <div class="bg-white p-6 rounded-2xl border shadow-sm space-y-6">
                                <h4 class="text-sm font-bold text-gray-700 flex items-center gap-2"><i class="fas fa-id-card text-line-green"></i> Header èˆ‡ å“ç‰Œé…è‰²</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="col-span-2"><label class="input-label">å§“å/ä¸»æ¨™é¡Œ</label><input type="text" v-model="editState.params.headerName" class="w-full border rounded-lg p-2 text-sm font-bold"></div>
                                    <div class="col-span-2"><label class="input-label">è·ç¨±/æ•˜è¿° (20å­—)</label><input type="text" v-model="editState.params.headerDescription" maxlength="20" class="w-full border rounded-lg p-2 text-sm"></div>
                                    <div class="col-span-2"><label class="input-label">é ­åƒç¶²å€</label><input type="text" v-model="editState.params.headerImg" class="w-full border rounded-lg p-2 text-sm"></div>
                                    <div><label class="input-label">èƒŒæ™¯é¡è‰²</label><div class="flex items-center gap-2 bg-slate-50 p-2 rounded border"><input type="color" v-model="editState.params.headerBgColor"><span class="text-[10px] font-mono">{{editState.params.headerBgColor}}</span></div></div>
                                    <div><label class="input-label">æ–‡å­—é¡è‰²</label><div class="flex items-center gap-2 bg-slate-50 p-2 rounded border"><input type="color" v-model="editState.params.headerTextColor"><span class="text-[10px] font-mono">{{editState.params.headerTextColor}}</span></div></div>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl border shadow-sm space-y-4">
                                <h4 class="text-sm font-bold text-gray-700 flex items-center gap-2"><i class="fas fa-video text-line-green"></i> è¦–è¦º Hero å…§å®¹</h4>
                                <div class="flex bg-slate-100 p-1 rounded-lg border mb-2">
                                    <button @click="editState.params.visualMode = 'video'" :class="editState.params.visualMode==='video'?'bg-white shadow-sm text-line-green font-bold':'text-gray-400'" class="flex-1 py-1.5 text-xs rounded transition-all">VIDEO</button>
                                    <button @click="editState.params.visualMode = 'image'" :class="editState.params.visualMode==='image'?'bg-white shadow-sm text-line-green font-bold':'text-gray-400'" class="flex-1 py-1.5 text-xs rounded transition-all">IMAGE</button>
                                </div>
                                <div><label class="input-label">ä¸»åœ–/å°é¢ç¶²å€</label><input type="text" v-model="editState.params.previewUrl" class="w-full border rounded-lg p-2 text-xs" placeholder="å°é¢åœ–/åœ–ç‰‡ç¶²å€"></div>
                                <div v-if="editState.params.visualMode==='video'"><label class="input-label text-blue-500">å½±ç‰‡æª”æ¡ˆ (.mp4) é€£çµ</label><input type="text" v-model="editState.params.videoUrl" class="w-full border-2 border-blue-50 rounded-lg p-2 text-xs focus:border-blue-300" placeholder="å½±ç‰‡ç¶²å€"></div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl border shadow-sm space-y-4">
                                <div class="flex justify-between items-center"><h4 class="text-sm font-bold text-gray-700">åŠŸèƒ½ç¶²æ ¼ (Grid) é…ç½®</h4><div class="flex items-center gap-2"><span class="text-[9px] text-gray-400 font-bold uppercase">ç¶²æ ¼åº•è‰²</span><input type="color" v-model="editState.params.gridBgColor"></div></div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div v-for="(g, idx) in editState.params.gridButtons" :key="idx" class="p-3 border rounded-xl bg-slate-50 space-y-2 shadow-sm group hover:border-line-green transition-all">
                                        <div class="flex gap-2"><input type="text" v-model="g.emoji" class="w-8 border rounded text-center text-xs shadow-inner"><input type="text" v-model="g.label" class="flex-1 border rounded p-1 text-xs shadow-inner"></div>
                                        <input type="text" v-model="g.uri" class="w-full border rounded p-1 text-[10px] shadow-inner" placeholder="https://">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. é›»å•†å‹ç·¨è¼¯ (Ecommerce) -->
                        <div v-if="editState.cardType === 'ecommerce'" class="space-y-6 animate-in fade-in">
                            <div class="bg-white p-6 rounded-2xl border shadow-sm space-y-4">
                                <h4 class="text-sm font-bold text-gray-700">é›»å•†é ‚éƒ¨è¦–è¦º Hero</h4>
                                <input type="text" v-model="editState.params.imageUrl" class="w-full border rounded-lg p-2 text-sm" placeholder="é ‚éƒ¨ Hero åœ–ç‰‡ç¶²å€">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="input-label">å•†å“èƒŒæ™¯åº•è‰²</label><input type="color" v-model="editState.params.bodyBgColor" class="w-full h-8 border rounded shadow-sm"></div>
                                    <div><label class="input-label">æ¯æ¬„é¡¯ç¤ºæ•¸é‡</label><select v-model="editState.params.columns" class="w-full border rounded p-1 text-sm"><option :value="3">3 æ¬„</option><option :value="4">4 æ¬„</option></select></div>
                                </div>
                            </div>
                            <!-- å•†å“ç®¡ç†å€ -->
                            <div class="bg-white p-6 rounded-2xl border shadow-sm space-y-4">
                                <div class="flex justify-between items-center"><h4 class="text-sm font-bold text-gray-700">å•†å“åˆ—è¡¨ç®¡ç†</h4><button @click="addEcomItem" class="text-xs text-line-green font-bold hover:underline">+ æ–°å¢å•†å“</button></div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div v-for="(item, idx) in editState.params.items" :key="idx" class="p-3 bg-slate-50 border rounded-xl flex items-center gap-3 relative group">
                                        <img :src="item.img" class="w-10 h-10 rounded border object-cover shadow-sm">
                                        <div class="flex-1">
                                            <input v-model="item.title" class="w-full text-xs font-bold border-b bg-transparent mb-1" placeholder="å•†å“åç¨±">
                                            <input v-model="item.url" class="w-full text-[9px] text-gray-400 bg-transparent" placeholder="é»æ“Šé€£çµ">
                                        </div>
                                        <button @click="editState.params.items.splice(idx,1)" class="text-red-300 absolute top-1 right-1 opacity-0 group-hover:opacity-100"><i class="fas fa-times-circle"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å…±åŒæ¬„ä½ï¼šåº•éƒ¨æŒ‰éˆ• -->
                        <div class="bg-white p-6 rounded-2xl border shadow-sm">
                            <h4 class="text-sm font-bold mb-4 flex justify-between items-center text-gray-700"><span>åº•éƒ¨åŠŸèƒ½æŒ‰éˆ• (Footer)</span><button @click="addButton" class="text-xs text-line-green font-bold hover:underline">+ æ–°å¢</button></h4>
                            <div class="space-y-3">
                                <div v-for="(btn, idx) in editState.params.buttons" :key="idx" class="flex gap-3 items-center bg-slate-50 p-3 rounded-xl border group transition-all hover:border-line-green shadow-sm">
                                    <input type="color" v-model="btn.color"><input type="text" v-model="btn.label" class="w-32 border rounded p-1 text-sm font-bold shadow-inner"><input type="text" v-model="btn.uri" class="flex-1 border rounded p-1 text-sm shadow-inner">
                                    <button @click="editState.params.buttons.splice(idx,1)" class="text-gray-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´å³æ™‚é è¦½å€ -->
            <div class="w-[420px] shrink-0 chat-room-bg no-scrollbar shadow-inner border-l">
                <div class="mb-6 text-[10px] font-bold text-white/40 uppercase tracking-[0.3em] text-center">Live Synchronized Preview</div>
                
                <div class="flex-bubble-container">
                    <!-- é è¦½ï¼šæ–‡ç« å‹ -->
                    <div v-if="editState.cardType === 'article'" class="flex-bubble animate-in zoom-in duration-300">
                        <div class="relative w-full overflow-hidden">
                            <img :src="editState.params.imageUrl" class="w-full aspect-[20/13] object-cover" onerror="this.src='https://via.placeholder.com/800x520?text=Image+Error'">
                            <div v-if="editState.params.showBadge" class="flex-badge-preview" :style="{ backgroundColor: editState.params.badgeColor }">{{ editState.params.badgeText }}</div>
                        </div>
                        <div class="p-[5px] text-center">
                            <div class="text-base font-bold truncate mt-1 text-gray-800">{{ editState.params.title || 'æ¨™é¡Œå…§å®¹' }}</div>
                            <div class="text-[9px] text-gray-500 mt-2 whitespace-pre-wrap leading-relaxed px-1">{{ editState.params.subtitle }}</div>
                        </div>
                        <div class="p-[5px] space-y-1.5"><button v-for="btn in editState.params.buttons" class="w-full py-1.5 text-white text-[10px] font-bold rounded shadow-sm" :style="{ backgroundColor: btn.color }">{{ btn.label }}</button></div>
                    </div>
                    
                    <!-- é è¦½ï¼šå½±ç‰‡åç‰‡å‹ -->
                    <div v-if="editState.cardType === 'card'" class="flex-bubble animate-in zoom-in duration-300">
                        <div class="header-box shadow-sm" :style="{ backgroundColor: editState.params.headerBgColor }">
                            <img :src="editState.params.headerImg" class="w-10 h-10 rounded-full object-cover border border-white/20 shadow-sm">
                            <div class="flex flex-col overflow-hidden">
                                <span class="text-[11px] font-bold uppercase truncate" :style="{ color: editState.params.headerTextColor }">{{ editState.params.headerName || 'å§“å' }}</span>
                                <span class="text-[8px] leading-tight truncate" :style="{ color: editState.params.headerTextColor, opacity: 0.8 }">{{ editState.params.headerDescription }}</span>
                            </div>
                        </div>
                        <div class="w-full aspect-video bg-black relative flex items-center justify-center overflow-hidden shrink-0">
                            <img :src="editState.params.previewUrl" class="w-full h-full object-cover opacity-60">
                            <i v-if="editState.params.visualMode==='video'" class="fas fa-play-circle text-white text-4xl absolute drop-shadow-2xl"></i>
                        </div>
                        <div class="grid-box" :style="{ backgroundColor: editState.params.headerBgColor }">
                            <div v-for="grid in editState.params.gridButtons" class="grid-item shadow-md" :style="{ backgroundColor: editState.params.gridBgColor }">
                                <div class="text-xl mb-1">{{grid.emoji}}</div>
                                <div class="text-[8px] text-gray-300 font-bold truncate uppercase">{{grid.label || 'é¸å–®'}}</div>
                            </div>
                        </div>
                        <div class="p-3 pt-0 space-y-1.5 mt-auto" :style="{ backgroundColor: editState.params.headerBgColor }">
                            <div style="padding: 5px !important;">
                                <button v-for="btn in editState.params.buttons" class="w-full py-2 text-white text-[10px] font-bold rounded shadow-md mb-1.5" :style="{ backgroundColor: btn.color }">{{ btn.label }}</button>
                            </div>
                        </div>
                    </div>

                    <!-- é è¦½ï¼šé›»å•†å‹ -->
                    <div v-if="editState.cardType === 'ecommerce'" class="flex-bubble animate-in zoom-in duration-300">
                        <img :src="editState.params.imageUrl" class="w-full aspect-video object-cover shrink-0 shadow-sm">
                        <div class="p-[5px] flex-grow" :style="{ backgroundColor: editState.params.bodyBgColor }">
                            <div class="flex flex-col gap-[5px]">
                                <div v-for="(row, rIdx) in chunkedItems" :key="rIdx" class="flex gap-[5px]">
                                    <div v-for="(item, iIdx) in row" :key="iIdx" class="flex-1 bg-white rounded-sm overflow-hidden flex flex-col shadow-sm">
                                        <img :src="item.img" class="w-full aspect-square object-cover">
                                        <div class="bg-black py-1 px-1 text-center truncate text-[6px] text-white font-bold">{{item.title}}</div>
                                    </div>
                                    <div v-for="n in (editState.params.columns - row.length)" :key="n" class="flex-1 opacity-0"></div>
                                </div>
                            </div>
                        </div>
                        <div class="p-1.5 bg-white border-t flex gap-2" style="padding: 5px !important;">
                            <button v-for="btn in editState.params.buttons" class="flex-1 py-1.5 text-white text-[10px] font-bold rounded shadow-sm" :style="{ backgroundColor: btn.color }">{{ btn.label }}</button>
                        </div>
                    </div>
                </div>

                <div class="mt-auto bg-black/10 text-white/30 text-[9px] py-4 text-center w-full uppercase tracking-tighter">Synchronized with GAS & Sheet API</div>
            </div>
        </div>
    </main>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

const workerUrl = "https://lineoa.fangwl591021.workers.dev";

const forceHttps = (u) => { 
    if (!u || String(u).trim() === "" || u === "#") return "https://line.me"; 
    let url = String(u).trim(); 
    if (url.startsWith("http://")) return url.replace("http://", "https://"); 
    return url.startsWith("https://") ? url : "https://" + url; 
};

createApp({
    setup() {
        const loading = ref(false);
        const isSaving = ref(false);
        const searchQuery = ref('');
        const projects = ref([]);
        const selectedProject = ref(null);
        
        const editState = ref({ cardId: '', cardTitle: '', cardType: '', params: { items: [], buttons: [] } });

        const chunkedItems = computed(() => {
            if (!editState.value.params.items) return [];
            const size = editState.value.params.columns || 3;
            const res = [];
            for (let i = 0; i < editState.value.params.items.length; i += size) {
                res.push(editState.value.params.items.slice(i, i + size));
            }
            return res;
        });

        const fetchProjects = async () => {
            loading.value = true;
            try {
                const res = await fetch(workerUrl, { method: 'POST', body: JSON.stringify({ action: 'getProjects' }) });
                const result = await res.json();
                if (result.status === 'success') {
                    projects.value = Array.isArray(result.data) ? [...result.data].reverse() : [];
                }
            } catch (e) { console.error("Fetch Error:", e); }
            finally { loading.value = false; }
        };

        const filteredProjects = computed(() => {
            const query = String(searchQuery.value).toLowerCase();
            return projects.value.filter(p => String(p.cardTitle || "").toLowerCase().includes(query));
        });

        const formatDate = (d) => {
            if (!d) return '---';
            try { return String(d).split('T')[0]; } catch(e) { return '---'; }
        }

        const loadProject = (p) => {
            selectedProject.value = p;
            let params = { items: [], buttons: [] };
            const rawJson = typeof p.cardJson === 'string' ? JSON.parse(p.cardJson) : p.cardJson;
            
            const projectTitle = String(p.cardTitle || "");

            if (p.cardType === 'article') {
                params = {
                    imageUrl: p['hero.image.url'] || '',
                    title: p['header.subtitle'] || projectTitle,
                    subtitle: p['header.description'] || '',
                    showBadge: true, badgeText: 'HOT', badgeColor: '#FF0000',
                    buttons: rawJson.footer?.contents?.map(c => ({ label: String(c.action.label || ""), uri: c.action.uri, color: c.color })) || []
                };
            } else if (p.cardType === 'card') {
                const bodyBox = rawJson.body?.contents?.[0];
                const gridRow1 = bodyBox?.contents?.[0]?.contents || [];
                const gridRow2 = bodyBox?.contents?.[1]?.contents || [];
                const grids = [...gridRow1, ...gridRow2].map(g => ({
                    emoji: g.contents?.[0]?.text || 'ğŸ”˜',
                    label: g.contents?.[1]?.text || 'é¸å–®',
                    uri: g.action?.uri || 'https://line.me'
                }));

                params = {
                    headerName: String(p['header.name'] || ""),
                    headerDescription: String(p['header.subtitle'] || ""),
                    headerImg: p['header.avatarUrl'] || '',
                    headerBgColor: p['header.bgColor'] || '#1A1B1E',
                    headerTextColor: p['header.textColor'] || '#D4AF37',
                    visualMode: p['hero.mode'] || 'video',
                    previewUrl: p['hero.image.url'] || '',
                    videoUrl: p['hero.video.url'] || '',
                    gridBgColor: '#2A2C31',
                    gridButtons: grids.length >= 4 ? grids : [{emoji:'ğŸ¤–',label:'AI',uri:'https://line.me'},{emoji:'ğŸ¥',label:'å½±',uri:'https://line.me'},{emoji:'ğŸ§¾',label:'å–®',uri:'https://line.me'},{emoji:'ğŸ“',label:'åœ–',uri:'https://line.me'}],
                    buttons: (rawJson.footer?.contents || []).map(c => ({ label: String(c.action.label || ""), uri: c.action.uri, color: c.color }))
                };
            } else if (p.cardType === 'ecommerce') {
                // ä¿®æ­£ï¼šå¾ Flex JSON ä¸­é‚„åŸå•†å“é …ç›®
                const items = [];
                const bodyContents = rawJson.body?.contents || [];
                bodyContents.forEach(row => {
                    if (row.type === 'box' && row.layout === 'horizontal') {
                        row.contents.forEach(itemBox => {
                            if (itemBox.contents && itemBox.contents.length > 0) {
                                items.push({
                                    img: itemBox.contents[0].url,
                                    title: itemBox.contents[1].contents[0].text,
                                    url: itemBox.action.uri
                                });
                            }
                        });
                    }
                });

                params = {
                    imageUrl: p['hero.image.url'] || '',
                    bodyBgColor: rawJson.body?.backgroundColor || '#F8F8F8',
                    columns: bodyContents[0]?.contents?.length || 3,
                    items: items,
                    buttons: rawJson.footer?.contents?.[0]?.contents?.map(c => ({ label: c.action.label, uri: c.action.uri, color: c.color })) || []
                };
            }
            
            editState.value = { cardId: p.cardId, cardTitle: projectTitle, cardType: p.cardType, params: JSON.parse(JSON.stringify(params)) };
        };

        const updateProject = async () => {
            if (isSaving.value) return;
            isSaving.value = true;
            
            const newFlex = generateFlex(editState.value);
            const s = editState.value;
            
            const payload = {
                action: 'update',
                cardId: s.cardId,
                cardTitle: s.cardTitle,
                cardType: s.cardType,
                cardJson: JSON.stringify(newFlex),
                updatedAt: new Date().toISOString()
            };

            if (s.cardType === 'card') {
                payload['header.name'] = s.params.headerName;
                payload['header.subtitle'] = s.params.headerDescription;
                payload['header.avatarUrl'] = s.params.headerImg;
                payload['header.bgColor'] = s.params.headerBgColor;
                payload['header.textColor'] = s.params.headerTextColor;
                payload['hero.mode'] = s.params.visualMode;
                payload['hero.video.url'] = s.params.videoUrl;
                payload['hero.image.url'] = s.params.previewUrl;
            } else if (s.cardType === 'ecommerce') {
                payload['hero.image.url'] = s.params.imageUrl;
            } else {
                payload['header.subtitle'] = s.params.title;
                payload['header.description'] = s.params.subtitle;
                payload['hero.image.url'] = s.params.imageUrl;
            }

            try {
                const res = await fetch(workerUrl, { method: 'POST', body: JSON.stringify(payload) });
                const result = await res.json();
                if (result.status === 'success') {
                    alert("é›²ç«¯æ›´æ–°æˆåŠŸï¼");
                    await fetchProjects();
                } else { throw new Error(result.message); }
            } catch (e) { alert("æ›´æ–°å¤±æ•—ï¼š" + e.message); }
            finally { isSaving.value = false; }
        };

        const pushProject = async () => {
            const flex = generateFlex(editState.value);
            if (!liff.isLoggedIn()) { liff.login(); return; }
            liff.shareTargetPicker([{ type: "flex", altText: editState.value.cardTitle, contents: flex }])
            .then(res => { if (res) alert("æ¨æ’­æˆåŠŸï¼"); });
        };

        const addButton = () => {
            if(!editState.value.params.buttons) editState.value.params.buttons = [];
            editState.value.params.buttons.push({ label: 'äº†è§£æ›´å¤š', uri: 'https://line.me', color: '#00B900' });
        };

        const addEcomItem = () => {
            if(!editState.value.params.items) editState.value.params.items = [];
            editState.value.params.items.push({ title: 'æ–°å•†å“', img: 'https://lihi.cc/mwMvo', url: 'https://line.me' });
        };

        const generateFlex = (s) => {
            const cur = s.params;
            if (s.cardType === 'article') {
                const visual = [{ type: "image", url: forceHttps(cur.imageUrl), size: "full", aspectRatio: "20:13", aspectMode: "cover" }];
                if (cur.showBadge) visual.push({ type: "box", layout: "vertical", position: "absolute", backgroundColor: cur.badgeColor, cornerRadius: "xl", paddingTop: "5px", paddingBottom: "3px", paddingStart: "20px", paddingEnd: "20px", offsetTop: "10px", offsetEnd: "10px", action: { type: "uri", label: "badge", uri: "https://line.me" }, contents: [{ type: "text", text: cur.badgeText || "HOT", color: "#ffffff", size: "10px", weight: "bold" }] });
                return {
                    type: "bubble", body: { type: "box", layout: "vertical", paddingAll: "0px", contents: [
                        { type: "box", layout: "vertical", contents: visual },
                        { type: "box", layout: "vertical", paddingAll: "5px", contents: [
                            { type: "text", text: cur.title || "æ¨™é¡Œ", weight: "bold", size: "xl", align: "center", wrap: true },
                            { type: "text", text: cur.subtitle || "æè¿°", size: "xs", margin: "sm", color: "#666666", wrap: true }
                        ]}
                    ]},
                    footer: { type: "box", layout: "vertical", spacing: "sm", paddingAll: "5px", contents: cur.buttons.map(b => ({ type: "button", style: "primary", color: b.color, height: "sm", action: { type: "uri", label: b.label, uri: forceHttps(b.uri) } })) }
                };
            } else if (s.cardType === 'card') {
                return {
                    type: "bubble", size: "mega",
                    header: { type: "box", layout: "horizontal", paddingAll: "8px", backgroundColor: cur.headerBgColor, contents: [{ type: "image", url: forceHttps(cur.headerImg), size: "xs", aspectRatio: "1:1", aspectMode: "cover" }, { type: "box", layout: "vertical", margin: "md", flex: 3, contents: [{ type: "text", text: cur.headerName || "å§“å", weight: "bold", color: cur.headerTextColor }, { type: "text", text: cur.headerDescription || "æè¿°", size: "xs", color: cur.headerTextColor, wrap: true }] }] },
                    hero: cur.visualMode === 'video' ? { type: "video", url: forceHttps(cur.videoUrl), previewUrl: forceHttps(cur.previewUrl), aspectRatio: "16:9", altContent: { type: "image", url: forceHttps(cur.previewUrl), size: "full", aspectMode: "cover" } } : { type: "image", url: forceHttps(cur.previewUrl), size: "full", aspectRatio: "16:9", aspectMode: "cover" },
                    body: { type: "box", layout: "vertical", paddingAll: "8px", backgroundColor: cur.headerBgColor, contents: [{ type: "box", layout: "vertical", spacing: "sm", contents: [{ type: "box", layout: "horizontal", spacing: "sm", contents: cur.gridButtons.slice(0, 2).map(g => ({ type: "box", layout: "vertical", paddingAll: "10px", backgroundColor: cur.gridBgColor, cornerRadius: "12px", action: { type: "uri", label: g.label, uri: forceHttps(g.uri) }, contents: [{ type: "text", text: g.emoji, align: "center", size: "xl" }, { type: "text", text: g.label, size: "sm", align: "center", color: "#E6E6E6" }] })) }, { type: "box", layout: "horizontal", spacing: "sm", contents: cur.gridButtons.slice(2, 4).map(g => ({ type: "box", layout: "vertical", paddingAll: "10px", backgroundColor: cur.gridBgColor, cornerRadius: "12px", action: { type: "uri", label: g.label, uri: forceHttps(g.uri) }, contents: [{ type: "text", text: g.emoji, align: "center", size: "xl" }, { type: "text", text: g.label, size: "sm", align: "center", color: "#E6E6E6" }] })) }] }] },
                    footer: { type: "box", layout: "vertical", spacing: "sm", paddingAll: "8px", backgroundColor: cur.headerBgColor, contents: (cur.buttons||[]).map(b => ({ type: "button", style: "primary", height: "sm", color: b.color, action: { type: "uri", label: b.label, uri: forceHttps(b.uri) } })) }
                };
            } else if (s.cardType === 'ecommerce') {
                const rows = []; const cols = cur.columns || 3;
                for (let i = 0; i < cur.items.length; i += cols) {
                    const chunk = cur.items.slice(i, i + cols);
                    const rowBox = { type: "box", layout: "horizontal", spacing: "sm", margin: i === 0 ? "none" : "sm", contents: [] };
                    chunk.forEach(item => {
                        rowBox.contents.push({
                            type: "box", layout: "vertical", flex: 1, contents: [
                                { type: "image", url: forceHttps(item.img), aspectRatio: "1:1", aspectMode: "cover", size: "full" },
                                { type: "box", layout: "vertical", backgroundColor: "#000000", paddingAll: "xs", contents: [{ type: "text", text: item.title, color: "#FFFFFF", size: "xxs", align: "center", weight: "bold", wrap: true }] }
                            ],
                            action: { type: "uri", label: item.title, uri: forceHttps(item.url) }
                        });
                    });
                    while (rowBox.contents.length < cols) { rowBox.contents.push({ type: "box", layout: "vertical", flex: 1, contents: [] }); }
                    rows.push(rowBox);
                }
                return {
                    type: "bubble", size: "mega",
                    hero: { type: "image", url: forceHttps(cur.imageUrl), size: "full", aspectRatio: "16:9", aspectMode: "cover" },
                    body: { type: "box", layout: "vertical", paddingAll: "5px", backgroundColor: cur.bodyBgColor, contents: rows },
                    footer: { type: "box", layout: "vertical", paddingAll: "5px", contents: [{ type: "box", layout: "horizontal", spacing: "md", contents: cur.buttons.map(b => ({ type: "button", style: "primary", height: "sm", color: b.color, action: { type: "uri", label: b.label, uri: forceHttps(b.uri) } })) }] }
                };
            }
            return { type: "bubble", body: { type: "text", text: "æš«ä¸æ”¯æ´é è¦½" } };
        };

        const deleteProject = async (p) => {
            if (!confirm(`ç¢ºå®šå¾¹åº•åˆªé™¤ã€Œ${p.cardTitle}ã€ï¼Ÿ`)) return;
            try {
                const res = await fetch(workerUrl, { method: 'POST', body: JSON.stringify({ action: 'delete', cardId: p.cardId }) });
                const result = await res.json();
                if (result.status === 'success') { fetchProjects(); selectedProject.value = null; }
            } catch (e) { alert("åˆªé™¤å¤±æ•—"); }
        };

        onMounted(() => { liff.init({ liffId: "2008541971-Wgvz6gD8" }); fetchProjects(); });

        return { loading, projects, filteredProjects, searchQuery, selectedProject, editState, formatDate, loadProject, updateProject, pushProject, addButton, addEcomItem, isSaving, deleteProject, chunkedItems, getTypeBadgeClass: (t) => ({ 'article':'bg-blue-100 text-blue-600', 'card':'bg-purple-100 text-purple-600', 'ecommerce':'bg-orange-100 text-orange-600' }[t]) };
    }
}).mount('#app');
</script>
</body>
</html>
