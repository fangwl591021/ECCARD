/**
 * LINEOA 插件平台後台 - 支援覆蓋更新版本
 * 核心功能：
 * 1. action: 'getProjects' -> 讀取清單
 * 2. action: 'update' -> 搜尋 cardId 並覆蓋該列
 * 3. action: 'delete' -> 刪除該列
 * 4. 預設 (action 為空) -> 新增一列 (用於 index.html 第一次儲存)
 */

const SPREADSHEET_ID = '1qQjIMf8WDAuklmqz_sqfQoDysttMETJqcy69mdkqXyM';

function doPost(e) {
  const res = { status: 'error', message: '初始化失敗' };
  
  try {
    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName('cards') || ss.insertSheet('cards');
    const rows = sheet.getDataRange().getValues();
    const headers = rows[0];

    // --- 動作 A: 讀取專案清單 ---
    if (data.action === 'getProjects') {
      if (rows.length <= 1) return createJsonResponse({ status: 'success', data: [] });
      const jsonData = rows.slice(1).map(row => {
        const obj = {};
        headers.forEach((h, i) => { obj[h] = row[i]; });
        return obj;
      });
      return createJsonResponse({ status: 'success', data: jsonData });
    }

    // --- 動作 B: 刪除專案 ---
    if (data.action === 'delete') {
      const idIdx = headers.indexOf('cardId');
      for (let i = 1; i < rows.length; i++) {
        if (rows[i][idIdx] === data.cardId) {
          sheet.deleteRow(i + 1);
          return createJsonResponse({ status: 'success', message: '專案已刪除' });
        }
      }
      throw new Error('找不到專案 ID');
    }

    // --- 動作 C: 更新 (覆蓋) 或 新增 ---
    const cardId = data.cardId;
    const idIdx = headers.indexOf('cardId');
    let targetRowIndex = -1;

    // 如果有提供 cardId，嘗試尋找是否已存在
    if (cardId && idIdx !== -1) {
      for (let i = 1; i < rows.length; i++) {
        if (rows[i][idIdx] === cardId) {
          targetRowIndex = i + 1; // 找到列號
          break;
        }
      }
    }

    // 準備要寫入的一列資料
    const newRowData = headers.map(h => data[h] !== undefined ? data[h] : "");

    if (targetRowIndex !== -1 && data.action === 'update') {
      // 執行「覆蓋」
      sheet.getRange(targetRowIndex, 1, 1, headers.length).setValues([newRowData]);
      res.status = 'success';
      res.message = '專案已成功更新（覆蓋舊紀錄）';
    } else {
      // 執行「新增」
      sheet.appendRow(newRowData);
      res.status = 'success';
      res.message = '新專案已儲存';
    }

    // 如果有 accessToken 則執行 LINE 推播
    if (data.userId && data.flexPayload && data.accessToken) {
      sendPush(data.userId, data.flexPayload, data.accessToken);
    }

    return createJsonResponse(res);

  } catch (err) {
    return createJsonResponse({ status: 'error', message: err.toString() });
  }
}

function createJsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}

function sendPush(userId, flexPayload, token) {
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/push', {
    'method': 'post',
    'headers': { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
    'payload': JSON.stringify({ 'to': userId, 'messages': [flexPayload] }),
    'muteHttpExceptions': true
  });
}
