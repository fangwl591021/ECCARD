<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINEOA å¤šé æ··åˆé–‹ç™¼å¹³å°</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f7f6; overflow: hidden; }
        .line-green { color: #00B900; }
        .bg-line-green { background-color: #00B900; }
        
        /* å´é‚Šæ¬„ */
        .sidebar-container { background-color: #1e2124; height: 100vh; width: 256px; display: flex; flex-direction: column; flex-shrink: 0; z-index: 50; }
        .sidebar-item-active { background-color: #374151; color: white; border-left: 4px solid #00B900; }

        /* å¤šé é è¦½æ»¾å‹•å€ */
        .carousel-preview-container {
            display: flex;
            gap: 15px;
            padding: 20px;
            overflow-x: auto;
            width: 100%;
            scroll-snap-type: x mandatory;
        }
        .carousel-preview-container::-webkit-scrollbar { height: 6px; }
        .carousel-preview-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .preview-bubble {
            flex: 0 0 280px;
            scroll-snap-align: center;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        /* æ¨¡çµ„å°ˆç”¨æ¨£å¼ */
        .header-box { background: #1A1B1E; padding: 10px; display: flex; align-items: center; gap: 8px; }
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; padding: 10px; background: #0F0F10; }
        .grid-item { background: #2A2C31; padding: 8px; border-radius: 8px; text-align: center; }
        .chat-room-bg { background-color: #7988a0; width: 100%; height: 100%; overflow-y: auto; padding: 40px 20px; }

        .input-label { @apply block text-[11px] font-bold text-gray-500 uppercase mb-1 ml-1; }
        input[type="color"] { -webkit-appearance: none; border: none; width: 24px; height: 24px; cursor: pointer; background: none; }
        input[type="color"]::-webkit-color-swatch { border-radius: 4px; border: 1px solid #ddd; }
        
        .tab-btn { @apply px-4 py-2 text-sm font-bold border-b-2 transition-all cursor-pointer; }
        .tab-btn-active { @apply border-line-green text-line-green; }
        .tab-btn-inactive { @apply border-transparent text-gray-400 hover:text-gray-600; }
    </style>
</head>
<body>

<div id="app" class="flex h-screen overflow-hidden text-gray-800">
    <!-- å´é‚Šæ¬„ -->
    <aside class="sidebar-container text-gray-400 shadow-2xl">
        <div class="h-16 flex items-center px-6 border-b border-gray-700 shrink-0">
            <i class="fab fa-line text-3xl line-green"></i>
            <span class="ml-4 text-white font-bold whitespace-nowrap uppercase tracking-tighter">Multi-Plug</span>
        </div>
        <nav class="mt-6 flex-grow overflow-y-auto no-scrollbar">
            <a href="index.html" class="flex items-center py-4 px-6 hover:bg-gray-700 transition-colors">
                <i class="fas fa-arrow-left w-8 text-center"></i>
                <span class="ml-2 font-medium">è¿”å›ä¸»å„€è¡¨æ¿</span>
            </a>
            <div class="sidebar-item-active flex items-center py-4 px-6">
                <i class="fas fa-layer-group w-8 text-center"></i>
                <span class="ml-2 font-medium">å¤šé æ··åˆé–‹ç™¼</span>
            </div>
        </nav>
        <div class="p-6 text-[10px] text-gray-500 border-t border-gray-700">
            LIFF ID: 2008541971-Wgvz6gD8
        </div>
    </aside>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="flex-grow flex flex-col h-full relative overflow-hidden bg-[#f8fafc]">
        <header class="h-16 bg-white border-b flex items-center justify-between px-8 shrink-0 shadow-sm z-10">
            <div class="flex items-center gap-4">
                <h2 class="text-xl font-bold text-gray-800">å¤šé æ··åˆè¨Šæ¯é–‹ç™¼</h2>
                <div class="px-3 py-1 bg-orange-100 text-orange-700 text-[10px] font-bold rounded-full">BETA</div>
            </div>
            <div class="flex items-center gap-4">
                <button @click="saveCarousel" class="px-6 py-2 bg-purple-500 text-white rounded-xl text-sm font-bold shadow-lg hover:bg-purple-600 flex items-center gap-2">
                    <i class="fas fa-save"></i> å„²å­˜å¤šé å°ˆæ¡ˆ
                </button>
                <button @click="pushCarousel" class="px-6 py-2 bg-blue-500 text-white rounded-xl text-sm font-bold shadow-lg hover:bg-blue-600 flex items-center gap-2">
                    <i class="fas fa-paper-plane"></i> ğŸš€ æ¨æ’­ç™¼é€
                </button>
            </div>
        </header>

        <div class="flex-grow flex overflow-hidden">
            <!-- å·¦å´ç·¨è¼¯å€ -->
            <div class="flex-grow overflow-y-auto p-8 bg-white border-r no-scrollbar">
                <div class="max-w-4xl mx-auto">
                    <!-- å…¨åŸŸè¨­å®š -->
                    <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100 mb-8 shadow-sm">
                        <label class="input-label text-blue-800">æ¨æ’­æ–‡å­— (Carousel AltText)</label>
                        <input type="text" v-model="carouselData.altText" class="w-full px-4 py-2 border rounded-xl text-sm focus:ring-2 focus:ring-blue-300 outline-none" placeholder="é¡¯ç¤ºåœ¨æ‰‹æ©Ÿé€šçŸ¥åˆ—çš„æ–‡å­—">
                    </div>

                    <!-- åˆ†é å°è¦½ -->
                    <div class="flex items-center gap-2 mb-6 overflow-x-auto pb-2 no-scrollbar">
                        <div v-for="(bubble, index) in carouselData.bubbles" :key="index" class="relative group shrink-0">
                            <button @click="activeBubbleIndex = index" 
                                :class="activeBubbleIndex === index ? 'bg-line-green text-white shadow-md' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'"
                                class="w-24 py-2 rounded-xl text-xs font-bold transition-all truncate px-2">
                                é é¢ {{ index + 1 }}
                            </button>
                            <button @click.stop="removeBubble(index)" v-if="carouselData.bubbles.length > 1" class="absolute -top-1 -right-1 bg-red-500 text-white w-4 h-4 rounded-full flex items-center justify-center text-[8px] opacity-0 group-hover:opacity-100 transition-opacity shadow-sm">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <button @click="showAddModal = true" v-if="carouselData.bubbles.length < 12" class="w-10 h-10 border-2 border-dashed border-gray-300 text-gray-400 rounded-xl hover:border-line-green hover:text-line-green transition-all shrink-0">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <!-- é é¢ç·¨è¼¯å…§å®¹ -->
                    <div v-if="activeBubble" class="animate-in fade-in slide-in-from-bottom-2 duration-300">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-gray-800 flex items-center gap-2">
                                <i :class="getTypeIcon(activeBubble.type)" class="text-line-green"></i>
                                æ­£åœ¨ç·¨è¼¯ï¼š{{ getTypeName(activeBubble.type) }}
                            </h3>
                            <span class="text-[10px] text-gray-400 font-mono">BUBBLE_UUID: {{ activeBubble.id }}</span>
                        </div>

                        <!-- æ ¹æ“šé¡å‹é¡¯ç¤ºä¸åŒç·¨è¼¯å™¨ -->
                        <div class="space-y-6">
                            <!-- å…±ç”¨è¦–è¦ºå€ -->
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border shadow-sm">
                                <label class="input-label">ä¸»è¦–è¦ºåœ–ç‰‡ç¶²å€ (HTTPS)</label>
                                <input type="text" v-model="activeBubble.imageUrl" class="w-full px-4 py-2 border rounded-xl text-sm focus:border-line-green shadow-sm" placeholder="https://...">
                                
                                <div v-if="activeBubble.type === 'article'" class="mt-4 flex items-center gap-3">
                                    <label class="input-label mb-0 mr-2">æ¯”ä¾‹ï¼š</label>
                                    <button v-for="ratio in ['1:1', '20:13', '4:6']" @click="activeBubble.aspectRatio = ratio" :class="activeBubble.aspectRatio === ratio ? 'ratio-btn-active' : ''" class="ratio-btn">{{ ratio }}</button>
                                </div>
                            </div>

                            <!-- å–®é æ–‡ç« æ¬„ä½ -->
                            <template v-if="activeBubble.type === 'article'">
                                <div class="bg-[#f8fafc] p-6 rounded-2xl border shadow-sm">
                                    <label class="input-label">æ¨™é¡Œæ–‡å­—</label>
                                    <input type="text" v-model="activeBubble.title" class="w-full px-4 py-2 border rounded-xl text-sm font-bold mb-4">
                                    <label class="input-label">å…§å®¹æè¿°</label>
                                    <textarea v-model="activeBubble.subtitle" rows="4" class="w-full px-4 py-2 border rounded-xl text-sm outline-none"></textarea>
                                </div>
                            </template>

                            <!-- åç‰‡å‹æ¬„ä½ -->
                            <template v-if="activeBubble.type === 'card'">
                                <div class="bg-[#f8fafc] p-6 rounded-2xl border shadow-sm">
                                    <h4 class="text-sm font-bold text-gray-700 mb-4">å“ç‰Œ Header è¨­å®š</h4>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="input-label">å§“å</label><input type="text" v-model="activeBubble.headerName" class="w-full px-4 py-2 border rounded-lg text-sm"></div>
                                        <div><label class="input-label">ç¨±è™Ÿ</label><input type="text" v-model="activeBubble.headerTitle" class="w-full px-4 py-2 border rounded-lg text-sm"></div>
                                        <div class="col-span-2"><label class="input-label">é ­åƒç¶²å€</label><input type="text" v-model="activeBubble.headerImg" class="w-full px-4 py-2 border rounded-lg text-sm"></div>
                                    </div>
                                </div>
                            </template>

                            <!-- é›»å•†å‹æ¬„ä½ -->
                            <template v-if="activeBubble.type === 'ecommerce'">
                                <div class="bg-[#f8fafc] p-6 rounded-2xl border shadow-sm">
                                    <h4 class="text-sm font-bold text-gray-700 mb-4 flex justify-between items-center">
                                        <span>å•†å“ç¶²æ ¼ ({{ activeBubble.items.length }})</span>
                                        <button @click="activeBubble.items.push({title:'æ–°å•†å“',img:'https://lihi.cc/mwMvo',url:''})" class="text-xs text-line-green font-bold">+ æ–°å¢</button>
                                    </h4>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div v-for="(item, idx) in activeBubble.items" :key="idx" class="p-3 bg-white border rounded-xl relative shadow-sm">
                                            <input v-model="item.title" class="w-full text-xs font-bold border-b mb-1" placeholder="å“å">
                                            <input v-model="item.img" class="w-full text-[9px] text-gray-400 truncate mb-1" placeholder="åœ–ç‰‡ HTTPS">
                                            <input v-model="item.url" class="w-full text-[9px] text-blue-400 truncate" placeholder="é€£çµ">
                                            <button @click="activeBubble.items.splice(idx,1)" class="absolute -top-1 -right-1 text-red-400 bg-white rounded-full w-5 h-5 shadow-sm border flex items-center justify-center text-[10px]"><i class="fas fa-times"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <!-- æŒ‰éˆ•è¨­å®š (å¤šæ¨¡çµ„å…±ç”¨) -->
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border shadow-sm">
                                <h4 class="text-sm font-bold text-gray-700 mb-4 flex justify-between items-center">
                                    <span>åˆ†é åº•éƒ¨æŒ‰éˆ•</span>
                                    <button v-if="activeBubble.buttons.length < 3" @click="activeBubble.buttons.push({label:'æ–°æŒ‰éˆ•',uri:'',color:'#00B900'})" class="text-xs text-line-green font-bold">+ æ–°å¢</button>
                                </h4>
                                <div class="space-y-3">
                                    <div v-for="(btn, idx) in activeBubble.buttons" :key="idx" class="flex gap-3 items-center bg-white p-3 rounded-xl border shadow-sm">
                                        <input type="color" v-model="btn.color">
                                        <input type="text" v-model="btn.label" class="w-32 px-3 py-2 border rounded-lg text-sm" placeholder="æ–‡å­—">
                                        <input type="text" v-model="btn.uri" class="flex-grow px-3 py-2 border rounded-lg text-sm" placeholder="HTTPS é€£çµ">
                                        <button @click="activeBubble.buttons.splice(idx,1)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- JSON è¼¸å‡ºå€ -->
                    <div class="mt-12 mb-20">
                        <div class="flex items-center justify-between mb-3 px-2">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest"><i class="fas fa-code mr-2"></i>Multi-Page Flex JSON</span>
                            <button @click="copyJson" class="text-[10px] text-line-green font-bold uppercase hover:underline">Copy Full JSON</button>
                        </div>
                        <div class="bg-[#1e2124] rounded-2xl p-6 border border-gray-700 shadow-xl overflow-hidden">
                            <pre class="text-[11px] text-green-400 font-mono h-48 overflow-y-auto no-scrollbar">{{ JSON.stringify(fullFlexJson, null, 2) }}</pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´é è¦½å€ (Carousel æ»¾å‹•å¼) -->
            <div class="w-[380px] shrink-0 relative overflow-hidden flex flex-col shadow-inner">
                <div class="chat-room-bg no-scrollbar flex flex-col items-center">
                    <div class="text-center mb-6"><span class="bg-black/20 text-white text-[10px] px-3 py-1 rounded-full backdrop-blur-sm">Mixed Carousel Preview</span></div>
                    
                    <div class="carousel-preview-container no-scrollbar">
                        <div v-for="(bubble, bIdx) in carouselData.bubbles" :key="bIdx" class="preview-bubble">
                            <!-- Article Module -->
                            <template v-if="bubble.type === 'article'">
                                <img :src="bubble.imageUrl" :style="{ aspectRatio: bubble.aspectRatio.replace(':','/') }" class="w-full object-cover">
                                <div class="p-4 text-center">
                                    <div class="text-sm font-bold truncate">{{ bubble.title }}</div>
                                    <div class="text-[9px] text-gray-500 mt-1 h-12 overflow-hidden text-ellipsis">{{ bubble.subtitle }}</div>
                                </div>
                            </template>

                            <!-- Card Module -->
                            <template v-else-if="bubble.type === 'card'">
                                <div class="header-box">
                                    <img :src="bubble.headerImg" class="w-8 h-8 rounded-full object-cover border border-gray-700">
                                    <div class="flex flex-col"><span class="text-[10px] font-bold" style="color:#D4AF37">{{ bubble.headerName }}</span><span class="text-[7px] text-gray-400">{{ bubble.headerTitle }}</span></div>
                                </div>
                                <div class="w-full aspect-[16/9] bg-black">
                                    <img :src="bubble.imageUrl" class="w-full h-full object-cover opacity-80">
                                </div>
                                <div class="grid-box">
                                    <div v-for="i in 4" class="grid-item"><div class="text-xs mb-1">ğŸ”˜</div><div class="text-[7px] text-gray-400">Grid</div></div>
                                </div>
                            </template>

                            <!-- Ecom Module -->
                            <template v-else-if="bubble.type === 'ecommerce'">
                                <div class="w-full aspect-[16/9] bg-black shrink-0"><img :src="bubble.imageUrl" class="w-full h-full object-cover"></div>
                                <div class="p-3 bg-gray-50 grid grid-cols-3 gap-2">
                                    <div v-for="item in bubble.items.slice(0,6)" class="bg-white rounded p-1 shadow-sm flex flex-col border border-slate-100">
                                        <img :src="item.img" class="w-full aspect-square object-cover rounded-sm mb-1">
                                        <div class="text-[6px] text-center truncate bg-black text-white py-0.5 rounded-sm">{{ item.title }}</div>
                                    </div>
                                </div>
                            </template>

                            <!-- Common Footer Buttons -->
                            <div class="p-3 border-t bg-white space-y-1.5">
                                <button v-for="btn in bubble.buttons" :style="{ backgroundColor: btn.color }" class="w-full py-1.5 text-white text-[9px] font-bold rounded shadow-sm">{{ btn.label }}</button>
                                <div v-if="bubble.buttons.length === 0" class="h-6 border-2 border-dashed border-gray-100 rounded"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- æ–°å¢é é¢æ¨¡çµ„é¸æ“‡å½ˆçª— -->
    <div v-if="showAddModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl">
            <h3 class="text-xl font-bold mb-6 text-center">é¸æ“‡åˆ†é æ¨¡çµ„é¡å‹</h3>
            <div class="grid grid-cols-1 gap-4">
                <button @click="addNewBubble('article')" class="flex items-center gap-4 p-4 border rounded-2xl hover:border-line-green hover:bg-green-50 transition-all text-left">
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-line-green text-xl"><i class="fas fa-file-alt"></i></div>
                    <div><div class="font-bold">å–®é æ–‡ç« æ¨¡çµ„</div><div class="text-xs text-gray-400">ä¸»åœ–ç‰‡ã€æ¨™é¡Œã€å¤§æ®µæ–‡å­—æè¿°</div></div>
                </button>
                <button @click="addNewBubble('card')" class="flex items-center gap-4 p-4 border rounded-2xl hover:border-line-green hover:bg-green-50 transition-all text-left">
                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-purple-600 text-xl"><i class="fas fa-id-card"></i></div>
                    <div><div class="font-bold">åç‰‡åœ–ç‰‡æ¨¡çµ„</div><div class="text-xs text-gray-400">å“ç‰Œ Headerã€ä¸»å±•ç¤ºåœ–ã€åŠŸèƒ½ç¶²æ ¼</div></div>
                </button>
                <button @click="addNewBubble('ecommerce')" class="flex items-center gap-4 p-4 border rounded-2xl hover:border-line-green hover:bg-green-50 transition-all text-left">
                    <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center text-orange-600 text-xl"><i class="fas fa-shopping-cart"></i></div>
                    <div><div class="font-bold">é›»å•†å•†åŸæ¨¡çµ„</div><div class="text-xs text-gray-400">Hero åœ–ã€å•†å“ç¶²æ ¼æ¸…å–®</div></div>
                </button>
            </div>
            <button @click="showAddModal = false" class="w-full mt-6 py-3 text-gray-400 font-bold hover:text-gray-600 transition-colors">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

const forceHttps = (u) => {
    if (!u || u.trim() === "" || u === "#") return "https://line.me";
    let url = u.trim();
    if (url.startsWith("http://")) return url.replace("http://", "https://");
    if (!url.startsWith("https://") && !url.startsWith("line://")) return "https://" + url;
    return url;
};

const EditorHeader = {
    props: ['title'],
    template: `
        <div class="flex items-center justify-between">
            <div><h3 class="text-2xl font-bold text-gray-800">{{ title }}</h3><p class="text-[10px] text-red-500 font-bold mt-1 uppercase">â€» å¤šé è¨Šæ¯å¼·åˆ¶ç‚ºåœ–ç‰‡æ¨¡å¼</p></div>
        </div>`
};

createApp({
    setup() {
        const isLoggedIn = ref(false);
        const user = ref(null);
        const activeBubbleIndex = ref(0);
        const showAddModal = ref(false);

        const carouselData = ref({
            altText: 'æ‚¨æ”¶åˆ°äº†ä¸€å‰‡å¤šé æ··åˆè¨Šæ¯',
            bubbles: [
                {
                    id: crypto.randomUUID(),
                    type: 'article',
                    imageUrl: 'https://aiwe.cc/wp-content/uploads/2026/01/a635f6d04823512343614d4ddc692545.jpg',
                    aspectRatio: '20:13',
                    title: 'é¦–é æ­¡è¿é é¢',
                    subtitle: 'é€™æ˜¯æ‚¨çš„å¤šé æ··åˆè¨Šæ¯ç¬¬ä¸€é ã€‚æ‚¨å¯ä»¥è‡ªç”±æ–°å¢ä¸åŒé¡å‹çš„é é¢ã€‚',
                    buttons: [{ label: 'äº†è§£æ›´å¤š', uri: '', color: '#00B900' }]
                }
            ]
        });

        const activeBubble = computed(() => carouselData.value.bubbles[activeBubbleIndex.value]);

        const addNewBubble = (type) => {
            const newObj = { id: crypto.randomUUID(), type, imageUrl: 'https://aiwe.cc/wp-content/uploads/2026/01/a635f6d04823512343614d4ddc692545.jpg', buttons: [{ label: 'ç¢ºèª', uri: '', color: '#00B900' }] };
            
            if (type === 'article') {
                newObj.title = 'æ–°æ–‡ç« åˆ†é '; newObj.subtitle = 'å…§å®¹æè¿°...'; newObj.aspectRatio = '20:13';
            } else if (type === 'card') {
                newObj.headerName = 'å“ç‰Œå§“å'; newObj.headerTitle = 'ç¨±è™Ÿ'; newObj.headerImg = 'https://aiwe.cc/wp-content/uploads/2025/04/f9ebd0672d3b0ac370272909a493d4db.png';
                newObj.gridButtons = [ { emoji: 'ğŸ¤–', label: 'AI', uri: '' }, { emoji: 'ğŸ¥', label: 'å½±ç‰‡', uri: '' }, { emoji: 'ğŸ§¾', label: 'å•†å“', uri: '' }, { emoji: 'ğŸ“', label: 'åœ°å€', uri: '' } ];
            } else if (type === 'ecommerce') {
                newObj.items = [ { title: "å•†å“ A", img: "https://lihi.cc/mwMvo", url: "" }, { title: "å•†å“ B", img: "https://lihi.cc/2Nu8G", url: "" }, { title: "å•†å“ C", img: "https://lihi.cc/yRfpn", url: "" } ];
                newObj.tagBgColor = "#000000"; newObj.tagTextColor = "#FFFFFF"; newObj.bgColor = "#f8f8f8";
            }
            
            carouselData.value.bubbles.push(newObj);
            activeBubbleIndex.value = carouselData.value.bubbles.length - 1;
            showAddModal.value = false;
        };

        const removeBubble = (index) => {
            carouselData.value.bubbles.splice(index, 1);
            if (activeBubbleIndex.value >= carouselData.value.bubbles.length) {
                activeBubbleIndex.value = carouselData.value.bubbles.length - 1;
            }
        };

        const fullFlexJson = computed(() => {
            const contents = carouselData.value.bubbles.map(b => {
                const bubble = { type: "bubble", size: "mega" };
                
                if (b.type === 'article') {
                    bubble.body = { type: "box", layout: "vertical", paddingAll: "0px", contents: [
                        { type: "image", url: forceHttps(b.imageUrl), size: "full", aspectRatio: b.aspectRatio, aspectMode: "cover" },
                        { type: "box", layout: "vertical", paddingAll: "20px", contents: [
                            { type: "text", text: b.title || "æ¨™é¡Œ", weight: "bold", size: "xl", wrap: true },
                            { type: "text", text: b.subtitle || "å…§å®¹æè¿°", size: "sm", margin: "md", color: "#666666", wrap: true }
                        ]}
                    ]};
                } else if (b.type === 'card') {
                    bubble.header = { type: "box", layout: "horizontal", paddingAll: "8px", backgroundColor: "#1A1B1E", contents: [
                        { type: "image", url: forceHttps(b.headerImg), size: "xs", aspectRatio: "1:1", aspectMode: "cover" },
                        { type: "box", layout: "vertical", flex: 3, margin: "md", contents: [{ type: "text", text: b.headerName, weight: "bold", color: "#D4AF37" }, { type: "text", text: b.headerTitle, size: "xs", color: "#E6E6E6" }] }
                    ]};
                    bubble.hero = { type: "image", url: forceHttps(b.imageUrl), size: "full", aspectRatio: "800:500", aspectMode: "cover" };
                    bubble.body = { type: "box", layout: "vertical", backgroundColor: "#0F0F10", paddingAll: "8px", contents: [{ type: "box", layout: "horizontal", spacing: "sm", contents: (b.gridButtons || []).slice(0,2).map(g => ({ type: "box", layout: "vertical", paddingAll: "8px", backgroundColor: "#2A2C31", cornerRadius: "md", action: { type: "uri", label: g.label, uri: forceHttps(g.uri) }, contents: [{ type: "text", text: g.emoji, align: "center" },{ type: "text", text: g.label, size: "xxs", align: "center", color: "#E6E6E6" }] })) }] };
                } else if (b.type === 'ecommerce') {
                    const chunk = (arr, size) => Array.from({ length: Math.ceil(arr.length / size) }, (v, i) => arr.slice(i * size, i * size + size));
                    bubble.hero = { type: "image", url: forceHttps(b.imageUrl), size: "full", aspectRatio: "16:9", aspectMode: "cover" };
                    bubble.body = { type: "box", layout: "vertical", paddingAll: "md", backgroundColor: b.bgColor || "#ffffff", contents: chunk(b.items || [], 3).map(row => ({
                        type: "box", layout: "horizontal", spacing: "sm", margin: "sm", contents: row.map(item => ({
                            type: "box", layout: "vertical", width: "32%", contents: [
                                { type: "image", url: forceHttps(item.img), aspectRatio: "1:1", aspectMode: "cover" },
                                { type: "box", layout: "vertical", backgroundColor: b.tagBgColor, paddingAll: "xs", contents: [{ type: "text", text: item.title, size: "xxxs", color: b.tagTextColor, align: "center" }] }
                            ], action: { type: "uri", uri: forceHttps(item.url) }
                        }))
                    }))};
                }

                bubble.footer = { type: "box", layout: "vertical", spacing: "sm", paddingAll: "15px", contents: b.buttons.map(btn => ({
                    type: "button", style: "primary", height: "sm", color: btn.color, action: { type: "uri", label: btn.label || "äº†è§£æ›´å¤š", uri: forceHttps(btn.uri) }
                }))};

                return bubble;
            });

            return { type: "carousel", contents: contents };
        });

        const getTypeIcon = (type) => ({'article':'fa-file-alt', 'card':'fa-id-card', 'ecommerce':'fa-shopping-cart'}[type]);
        const getTypeName = (type) => ({'article':'æ–‡ç« æ¨¡çµ„', 'card':'åç‰‡åœ–ç‰‡æ¨¡çµ„', 'ecommerce':'é›»å•†å•†åŸæ¨¡çµ„'}[type]);
        const getAspectClass = (a) => ({'1:1':'aspect-1-1','16:9':'aspect-16-9','20:13':'aspect-20-13'}[a] || 'aspect-16-9');

        const pushCarousel = () => {
            if (!liff.isLoggedIn()) { liff.login(); return; }
            liff.shareTargetPicker([{ 
                type: "flex", 
                altText: carouselData.value.altText || "æ‚¨æ”¶åˆ°äº†ä¸€å‰‡å¤šé æ··åˆè¨Šæ¯", 
                contents: fullFlexJson.value 
            }])
            .then(res => { if (res) alert("æ¨æ’­ç™¼é€æˆåŠŸï¼"); })
            .catch(err => { console.error(err); alert("ç™¼é€å¤±æ•—ï¼šè«‹æª¢æŸ¥æ‰€æœ‰é€£çµç¶²å€ã€‚"); });
        };

        const copyJson = () => {
            const el = document.createElement('textarea'); el.value = JSON.stringify(fullFlexJson.value, null, 2);
            document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
            alert('Carousel JSON å·²è¤‡è£½ï¼');
        };

        onMounted(async () => {
            try { 
                await liff.init({ liffId: "2008541971-Wgvz6gD8" });
                isLoggedIn.value = liff.isLoggedIn(); 
                if (isLoggedIn.value) user.value = await liff.getProfile();
                if (window.lucide) window.lucide.createIcons();
            } catch (e) {}
        });

        return { carouselData, activeBubbleIndex, activeBubble, showAddModal, addNewBubble, removeBubble, getTypeIcon, getTypeName, getAspectClass, fullFlexJson, pushCarousel, copyJson, saveCarousel: () => alert("å·²æ¨¡æ“¬å„²å­˜å‹•ä½œ") };
    }
}).component('editor-header', EditorHeader).component('json-viewer', {
    props: ['json'],
    template: `
        <div class="mt-8 mb-4">
            <div class="flex items-center justify-between mb-2">
                <span class="text-[10px] font-bold text-gray-400 uppercase">Page Flex JSON</span>
            </div>
            <div class="bg-gray-50 rounded-xl p-4 border overflow-hidden"><pre class="text-[10px] text-gray-600 h-24 overflow-y-auto no-scrollbar">{{ JSON.stringify(json, null, 2) }}</pre></div>
        </div>`
}).mount('#app');
</script>
</body>
</html>
