<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mix.html</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f7f6; overflow: hidden; }
        .line-green { color: #00B900; }
        .bg-line-green { background-color: #00B900; }
        .sidebar-container { background-color: #1e2124; height: 100vh; width: 256px; display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; z-index: 50; }
        .sidebar-item-active { background-color: #374151; color: white; border-left: 4px solid #00B900; }
        .carousel-preview-container { display: flex; gap: 15px; padding: 20px; overflow-x: auto; width: 100%; scroll-snap-type: x mandatory; }
        .preview-bubble { flex: 0 0 280px; scroll-snap-align: center; background: white; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; flex-direction: column; position: relative; }
        
        /* æ¨™ç±¤æ¨£å¼ï¼šOffset 10px æ‡¸æµ®ï¼Œå…¨åœ“è§’ */
        .flex-badge { 
            position: absolute; top: 10px; right: 10px; color: white; 
            padding: 5px 20px 2px 20px; border-radius: 20px; 
            font-size: 10px; font-weight: bold; z-index: 20; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
            width: auto; white-space: nowrap;
        }

        .header-box { padding: 10px; display: flex; align-items: center; gap: 8px; }
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; padding: 10px; }
        .grid-item { padding: 8px; border-radius: 8px; text-align: center; }
        .chat-room-bg { background-color: #7988a0; width: 100%; height: 100%; overflow-y: auto; padding: 40px 10px; }
        .input-label { @apply block text-[11px] font-bold text-gray-500 uppercase mb-1 ml-1 tracking-wider; }
        input[type="color"] { -webkit-appearance: none; border: none; width: 24px; height: 24px; cursor: pointer; background: none; }
        input[type="color"]::-webkit-color-swatch { border-radius: 4px; border: 1px solid #ddd; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

<div id="app" class="flex h-screen overflow-hidden text-gray-800">
    <!-- å´é‚Šæ¬„ -->
    <aside class="sidebar-container text-gray-400 shadow-2xl">
        <div class="h-16 flex items-center px-6 border-b border-gray-700 shrink-0">
            <i class="fab fa-line text-3xl line-green"></i>
            <span class="ml-4 text-white font-bold whitespace-nowrap tracking-tighter uppercase font-mono">Mixer Pro</span>
        </div>
        <nav class="mt-6 flex-grow overflow-y-auto no-scrollbar whitespace-nowrap">
            <a href="index.html" class="flex items-center py-4 px-6 hover:bg-gray-700 transition-colors"><i class="fas fa-home w-8 text-center"></i><span class="ml-2 font-medium">è¿”å›å–®é é–‹ç™¼</span></a>
            <a href="video.html" class="flex items-center py-4 px-6 hover:bg-gray-700 transition-colors"><i class="fas fa-video w-8 text-center"></i><span class="ml-2 font-medium">å½±ç‰‡åç‰‡é–‹ç™¼</span></a>
            <div class="sidebar-item-active flex items-center py-4 px-6"><i class="fas fa-clone w-8 text-center"></i><span class="ml-2 font-medium">æ··åˆå¤šé é–‹ç™¼</span></div>
        </nav>
    </aside>

    <main class="flex-grow flex flex-col h-full relative overflow-hidden bg-[#f8fafc]">
        <header class="h-16 bg-white border-b flex items-center justify-between px-8 shrink-0 shadow-sm z-10">
            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">æ··åˆå¤šé ç®¡ç† <span class="px-2 py-0.5 bg-green-100 text-green-600 text-[10px] rounded uppercase font-bold">Stable 2.0</span></h2>
            <div class="flex items-center gap-4">
                <button @click="copyJson" class="px-5 py-2 bg-slate-700 text-white rounded-xl text-sm font-bold shadow-lg hover:bg-slate-800 flex items-center gap-2 transition-all"><i class="fas fa-copy"></i> è¤‡è£½ JSON</button>
                <button @click="pushMix" class="px-6 py-2 bg-blue-500 text-white rounded-xl text-sm font-bold shadow-lg hover:bg-blue-600 flex items-center gap-2 transition-all"><i class="fas fa-paper-plane"></i> ğŸš€ æ¨æ’­</button>
            </div>
        </header>

        <div class="flex-grow flex overflow-hidden">
            <div class="flex-grow overflow-y-auto p-8 bg-white border-r no-scrollbar">
                <div class="max-w-4xl mx-auto space-y-8 pb-20">
                    <!-- å…¨åŸŸé€šçŸ¥è¨­å®š -->
                    <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100 mb-8 shadow-sm">
                        <label class="input-label text-blue-800">èŠå¤©å®¤é€šçŸ¥æ–‡å­— (altText)</label>
                        <input type="text" v-model="carousel.altText" class="w-full px-4 py-2 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-200">
                    </div>

                    <!-- åˆ†é æ¨™ç±¤å°èˆª -->
                    <div class="flex items-center gap-2 mb-8 overflow-x-auto pb-4 no-scrollbar border-b">
                        <div v-for="(bubble, index) in carousel.bubbles" :key="bubble.id" class="relative group shrink-0 flex flex-col items-center gap-1">
                            <button @click="activeIndex = index" :class="activeIndex === index ? 'bg-line-green text-white shadow-md' : 'bg-gray-100 text-gray-500'" class="w-28 py-2 rounded-xl text-xs font-bold truncate px-3 transition-all">{{ index + 1 }}. {{ getTypeName(bubble.type) }}</button>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button @click.stop="moveLeft(index)" v-if="index > 0" class="w-5 h-5 bg-white border rounded text-[8px] shadow-sm"><i class="fas fa-chevron-left"></i></button>
                                <button @click.stop="removeBubble(index)" v-if="carousel.bubbles.length > 1" class="w-5 h-5 bg-red-100 text-red-500 border border-red-200 rounded text-[8px] shadow-sm"><i class="fas fa-trash"></i></button>
                                <button @click.stop="moveRight(index)" v-if="index < carousel.bubbles.length - 1" class="w-5 h-5 bg-white border rounded text-[8px] shadow-sm"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <button @click="showAddModal = true" class="w-10 h-10 border-2 border-dashed border-gray-300 rounded-xl hover:border-line-green hover:text-line-green transition-all shrink-0 self-start shadow-sm"><i class="fas fa-plus"></i></button>
                    </div>

                    <!-- åˆ†é ç·¨è¼¯å€åŸŸ -->
                    <div v-if="activeBubble" class="space-y-8 animate-in fade-in duration-300">
                        <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2"><i :class="getTypeIcon(activeBubble.type)" class="text-line-green"></i> æ­£åœ¨ç·¨è¼¯ï¼š{{ getTypeName(activeBubble.type) }}</h3>

                        <!-- ç·¨è¼¯ï¼šæ–‡ç« å‹ -->
                        <div v-if="activeBubble.type === 'article'" class="space-y-6">
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border shadow-sm space-y-4">
                                <div><label class="input-label">åœ–ç‰‡ç¶²å€ (HTTPS)</label><input type="text" v-model="activeBubble.imageUrl" class="w-full px-4 py-2 border rounded-xl text-sm shadow-sm"></div>
                                <div class="bg-white/50 p-4 rounded-lg border space-y-3">
                                    <label class="text-xs font-bold text-gray-600 flex items-center gap-2 cursor-pointer"><input type="checkbox" v-model="activeBubble.showBadge" class="accent-line-green"> é¡¯ç¤ºæ¨™ç±¤ (é•·åº¦éš¨æ–‡å­—ä¼¸ç¸®)</label>
                                    <div v-if="activeBubble.showBadge" class="grid grid-cols-2 gap-3 pl-6">
                                        <input type="text" v-model="activeBubble.badgeText" maxlength="10" class="border rounded p-1.5 text-xs" placeholder="æ¨™ç±¤æ–‡å­—">
                                        <input type="color" v-model="activeBubble.badgeColor" class="w-full">
                                    </div>
                                </div>
                                <label class="input-label">æ¨™é¡Œå…§å®¹</label><input type="text" v-model="activeBubble.title" class="w-full px-4 py-2 border rounded-xl text-sm font-bold">
                                <label class="input-label">æè¿°å…§å®¹ (5px é‚Šè·å„ªåŒ–)</label><textarea v-model="activeBubble.subtitle" rows="4" class="w-full px-4 py-2 border rounded-xl text-sm outline-none"></textarea>
                            </div>
                        </div>

                        <!-- ç·¨è¼¯ï¼šåç‰‡å‹ -->
                        <div v-if="activeBubble.type === 'card'" class="space-y-6">
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border shadow-sm space-y-6">
                                <h4 class="text-sm font-bold text-gray-700 flex items-center"><i class="fas fa-id-card mr-2 text-line-green"></i> å“ç‰Œé…è‰²èˆ‡ Header</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="input-label">å§“å</label><input type="text" v-model="activeBubble.headerName" class="w-full border rounded p-2 text-sm shadow-sm"></div>
                                    <div><label class="input-label">æ•˜è¿° (20å­—)</label><input type="text" v-model="activeBubble.headerDescription" maxlength="20" class="w-full border rounded p-2 text-sm shadow-sm"></div>
                                    <div class="col-span-2"><label class="input-label">é ­åƒé€£çµ</label><input type="text" v-model="activeBubble.headerImg" class="w-full border rounded p-2 text-sm shadow-sm"></div>
                                    <div><label class="input-label">Header èƒŒæ™¯</label><input type="color" v-model="activeBubble.headerBgColor" class="w-full"></div>
                                    <div><label class="input-label">Header æ–‡å­—</label><input type="color" v-model="activeBubble.headerTextColor" class="w-full"></div>
                                    <div><label class="input-label">Body èƒŒæ™¯</label><input type="color" v-model="activeBubble.bodyBgColor" class="w-full"></div>
                                    <div><label class="input-label">ç¶²æ ¼æŒ‰éˆ•è‰²</label><input type="color" v-model="activeBubble.gridBgColor" class="w-full"></div>
                                </div>
                            </div>
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border shadow-sm space-y-4">
                                <label class="input-label">Hero è¦–è¦ºæ¨¡å¼</label>
                                <div class="flex bg-slate-100 p-1 rounded-lg border">
                                    <button @click="activeBubble.visualMode = 'image'" :class="activeBubble.visualMode==='image'?'bg-white shadow-sm text-line-green':'text-gray-400'" class="flex-1 py-1.5 text-[10px] font-bold rounded">IMAGE</button>
                                    <button @click="activeBubble.visualMode = 'video'" :class="activeBubble.visualMode==='video'?'bg-white shadow-sm text-line-green':'text-gray-400'" class="flex-1 py-1.5 text-[10px] font-bold rounded">VIDEO</button>
                                </div>
                                <input type="text" v-model="activeBubble.imageUrl" class="w-full border rounded p-2 text-xs" placeholder="ä¸»åœ–æˆ–å½±ç‰‡å°é¢ç¶²å€">
                                <input v-if="activeBubble.visualMode==='video'" type="text" v-model="activeBubble.videoUrl" class="w-full border rounded p-2 text-xs" placeholder="å½±ç‰‡ .mp4 é€£çµ">
                            </div>
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border shadow-sm">
                                <h4 class="text-sm font-bold text-gray-700 mb-4">4 ç¶²æ ¼åŠŸèƒ½é…ç½®</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div v-for="(grid, idx) in activeBubble.gridButtons" :key="idx" class="p-3 bg-white border rounded-xl space-y-2 shadow-sm">
                                        <div class="flex gap-2 mb-1"><input type="text" v-model="grid.emoji" class="w-8 border rounded text-xs text-center"><input type="text" v-model="grid.label" class="flex-1 border rounded p-1 text-xs"></div>
                                        <input type="text" v-model="grid.uri" class="w-full border rounded p-1 text-[10px]" placeholder="https://line.me">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ç·¨è¼¯ï¼šé›»å•†å‹ -->
                        <div v-if="activeBubble.type === 'ecommerce'" class="space-y-6">
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border shadow-sm space-y-4">
                                <h4 class="text-sm font-bold flex justify-between items-center"><span>å•†å“é…ç½® (å¹³å‡ç¶²æ ¼)</span><button @click.stop="activeBubble.items.push({title:'æ–°å•†å“',img:'https://lihi.cc/mwMvo',url:'https://line.me'})" class="text-xs text-line-green font-bold">+ æ–°å¢å•†å“</button></h4>
                                <div class="grid grid-cols-2 gap-3 mb-4">
                                    <div><label class="input-label">æ¬„ä½æ•¸é‡</label><select v-model="activeBubble.columns" class="w-full border rounded p-1.5 text-sm shadow-sm"><option :value="3">3 æ¬„ä½</option><option :value="4">4 æ¬„ä½</option></select></div>
                                    <div><label class="input-label">èƒŒæ™¯åº•è‰²</label><input type="color" v-model="activeBubble.bgColor" class="w-full"></div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div v-for="(item, idx) in activeBubble.items" :key="idx" class="p-3 bg-white border rounded-xl flex items-center gap-3 relative shadow-sm">
                                        <img :src="item.img" class="w-10 h-10 rounded border object-cover">
                                        <div class="flex-1"><input v-model="item.title" class="w-full text-xs font-bold border-b mb-1"><input v-model="item.url" class="w-full text-[9px] text-gray-400"></div>
                                        <button @click.stop="activeBubble.items.splice(idx,1)" class="text-red-400 absolute top-1 right-1"><i class="fas fa-times-circle"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- åº•éƒ¨è¡Œç‚ºæŒ‰éˆ• (å›ºå®šé«˜åº¦ Sm) -->
                        <div class="bg-[#f8fafc] p-6 rounded-2xl border shadow-sm">
                            <h4 class="text-sm font-bold text-gray-700 mb-4 flex justify-between items-center"><span>åˆ†é åº•éƒ¨æŒ‰éˆ•</span><button @click.stop="activeBubble.buttons.push({label:'äº†è§£æ›´å¤š',uri:'https://line.me',color:'#00B900'})" class="text-xs text-line-green font-bold">+ æ–°å¢æŒ‰éˆ•</button></h4>
                            <div class="space-y-4">
                                <div v-for="(btn, idx) in activeBubble.buttons" :key="idx" class="flex gap-3 items-center bg-white p-4 rounded-xl border shadow-sm">
                                    <input type="color" v-model="btn.color">
                                    <input type="text" v-model="btn.label" class="w-32 border rounded p-1.5 text-sm font-bold shadow-sm">
                                    <input type="text" v-model="btn.uri" class="flex-1 border rounded p-1.5 text-sm shadow-sm">
                                    <button @click.stop="activeBubble.buttons.splice(idx,1)" class="text-gray-300 hover:text-red-500 transition-colors"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šé–‹æ”¾é è¦½å€ -->
            <div class="w-[380px] shrink-0 bg-slate-100 relative flex flex-col shadow-inner">
                <div class="chat-room-bg no-scrollbar">
                    <div class="carousel-preview-container no-scrollbar">
                        <div v-for="bubble in carousel.bubbles" :key="bubble.id" class="preview-bubble">
                            <template v-if="bubble.type === 'article'"><div class="relative"><img :src="bubble.imageUrl" class="w-full aspect-[20/13] object-cover"><div v-if="bubble.showBadge" class="flex-badge" :style="{ backgroundColor: bubble.badgeColor }">{{ bubble.badgeText }}</div></div><div class="p-[5px] text-center font-bold text-sm truncate">{{ bubble.title }}</div><div class="p-[5px] text-[9px] text-gray-500 h-12 overflow-hidden leading-tight">{{ bubble.subtitle }}</div></template>
                            <template v-else-if="bubble.type === 'card'">
                                <div class="header-box" :style="{ backgroundColor: bubble.headerBgColor }"><img :src="bubble.headerImg" class="w-8 h-8 rounded-full object-cover shadow-sm"><div class="flex flex-col overflow-hidden"><span class="text-[10px] font-bold truncate" :style="{ color: bubble.headerTextColor }">{{ bubble.headerName }}</span><span class="text-[7px] leading-tight truncate" :style="{ color: bubble.headerTextColor, opacity: 0.8 }">{{ bubble.headerDescription }}</span></div></div>
                                <div class="w-full aspect-[16/9] bg-black relative"><img :src="bubble.imageUrl" class="w-full h-full object-cover opacity-70"><i v-if="bubble.visualMode==='video'" class="fas fa-play-circle text-white text-3xl absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></i></div>
                                <div class="grid-box" :style="{ backgroundColor: bubble.bodyBgColor }"><div v-for="grid in bubble.gridButtons" class="grid-item text-[8px] text-gray-300 shadow-sm" :style="{ backgroundColor: bubble.gridBgColor }">{{grid.emoji}} {{grid.label}}</div></div>
                            </template>
                            <template v-else-if="bubble.type === 'ecommerce'"><img :src="bubble.imageUrl" class="w-full aspect-[16/9] object-cover shrink-0"><div class="p-2 flex-grow" :style="{ backgroundColor: bubble.bgColor }"><div :class="bubble.columns === 3 ? 'grid-cols-3' : 'grid-cols-4'" class="grid gap-1"><div v-for="item in bubble.items.slice(0,8)" class="bg-white rounded p-1 border shadow-sm text-center text-[5px] font-bold">{{item.title}}</div></div></div></template>
                            <div class="p-3 border-t bg-white space-y-1.5 mt-auto"><button v-for="btn in bubble.buttons" :style="{ backgroundColor: btn.color }" class="w-full py-1.5 text-white text-[9px] font-bold rounded shadow-sm transition-all active:scale-95">{{ btn.label }}</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- æ¨¡çµ„é¸æ“‡å½ˆçª— -->
    <div v-if="showAddModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] backdrop-blur-sm animate-in fade-in duration-300">
        <div class="bg-white rounded-[32px] p-8 max-w-sm w-full shadow-2xl">
            <h3 class="text-xl font-bold mb-6 text-center">æ–°å¢åˆ†é æ¨¡çµ„</h3>
            <div class="grid grid-cols-1 gap-4">
                <button v-for="t in ['article','card','ecommerce']" @click="addNewBubble(t)" class="p-4 border-2 rounded-2xl hover:border-line-green hover:bg-green-50 text-left transition-all flex items-center gap-4 group">
                    <i :class="getTypeIcon(t)" class="text-2xl text-gray-400 group-hover:text-line-green transition-colors"></i>
                    <div class="font-bold text-gray-700 uppercase">{{ t }}</div>
                </button>
            </div>
            <button @click="showAddModal = false" class="w-full mt-6 py-2 text-gray-400 font-bold hover:text-gray-600 transition-colors uppercase text-[10px] tracking-widest">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

const forceHttps = (u) => { 
    if (!u || u.trim() === "" || u === "#") return "https://line.me"; 
    let url = u.trim(); 
    if (url.startsWith("http://")) return url.replace("http://", "https://"); 
    return url.startsWith("https://") || url.startsWith("line://") ? url : "https://" + url; 
};

const cleanJson = (obj) => JSON.parse(JSON.stringify(obj));

createApp({
    setup() {
        const activeIndex = ref(0);
        const showAddModal = ref(false); // ä¿®æ­£ï¼šå¿…é ˆåœ¨ return ä¸­å›å‚³
        const carousel = ref({ 
            altText: 'ç²¾é¸å¤šé è¨Šæ¯', 
            bubbles: [{ 
                id: Date.now(), type: 'article', 
                imageUrl: 'https://aiwe.cc/wp-content/uploads/2026/01/a635f6d04823512343614d4ddc692545.jpg', 
                aspectRatio: '20:13', title: 'é¦–é ç²¾é¸', subtitle: 'å…§å®¹æè¿°...', 
                showBadge: true, badgeText: 'Hot', badgeColor: '#FF0000', badgeUri: 'https://line.me',
                buttons: [{ label: 'äº†è§£æ›´å¤š', uri: 'https://line.me', color: '#00B900' }] 
            }] 
        });

        const activeBubble = computed(() => carousel.value.bubbles[activeIndex.value] || null);
        
        const addNewBubble = (type) => {
            const b = { id: Date.now(), type, imageUrl: 'https://aiwe.cc/wp-content/uploads/2026/01/a635f6d04823512343614d4ddc692545.jpg', buttons: [{ label: 'äº†è§£æ›´å¤š', uri: 'https://line.me', color: '#00B900' }] };
            if (type==='article') { b.title='åˆ†é æ¨™é¡Œ'; b.subtitle='å…§å®¹...'; b.aspectRatio='20:13'; b.showBadge=true; b.badgeText='HOT'; b.badgeColor='#FF0000'; b.badgeUri='https://line.me'; }
            else if (type==='card') { b.visualMode='image'; b.videoUrl='https://voom-obs.line-scdn.net/ho1sEMNWDLB8UUD8RLAYrZjJoJzAxV3cPGT8MeBQ_J2YzD3JIGgELJDl3bm4xeSUUJy9_IhBjCiYfajYJIBEMORdaCXUceRQXDigUOQpZHg/mp4'; b.headerName='å§“å'; b.headerDescription='è·ç¨±æ•˜è¿°'; b.headerImg='https://aiwe.cc/wp-content/uploads/2025/04/f9ebd0672d3b0ac370272909a493d4db.png'; b.headerBgColor='#1A1B1E'; b.headerTextColor='#D4AF37'; b.bodyBgColor='#0F0F10'; b.gridBgColor='#2A2C31'; b.gridButtons=[{emoji:'ğŸ¤–',label:'AI',uri:'https://line.me'},{emoji:'ğŸ¥',label:'å½±',uri:'https://line.me'},{emoji:'ğŸ§¾',label:'å–®',uri:'https://line.me'},{emoji:'ğŸ“',label:'åœ–',uri:'https://line.me'}]; }
            else if (type==='ecommerce') { b.items=[{title:'å•†å“1',img:'https://lihi.cc/mwMvo',url:'https://line.me'},{title:'å•†å“2',img:'https://lihi.cc/2Nu8G',url:'https://line.me'}]; b.columns=3; b.bgColor='#F8F8F8'; b.tagBgColor='#000000'; b.tagTextColor='#FFFFFF'; }
            carousel.value.bubbles.push(b);
            activeIndex.value = carousel.value.bubbles.length - 1;
            showAddModal.value = false;
        };

        const removeBubble = (idx) => { if (carousel.value.bubbles.length > 1) { carousel.value.bubbles.splice(idx, 1); if (activeIndex.value >= carousel.value.bubbles.length) activeIndex.value = carousel.value.bubbles.length - 1; } };
        const moveLeft = (idx) => { if (idx > 0) { const target = carousel.value.bubbles[idx]; carousel.value.bubbles.splice(idx, 1); carousel.value.bubbles.splice(idx - 1, 0, target); activeIndex.value = idx - 1; } };
        const moveRight = (idx) => { if (idx < carousel.value.bubbles.length - 1) { const target = carousel.value.bubbles[idx]; carousel.value.bubbles.splice(idx, 1); carousel.value.bubbles.splice(idx + 1, 0, target); activeIndex.value = idx + 1; } };
        
        const fullFlexJson = computed(() => {
            const contents = carousel.value.bubbles.map(b => {
                const bubble = { type: "bubble", size: "mega" };
                if (b.type==='article') {
                    const bodyBox = [{type:"image",url:forceHttps(b.imageUrl),size:"full",aspectRatio:b.aspectRatio||"20:13",aspectMode:"cover"},{type:"box",layout:"vertical",paddingAll:"5px",contents:[{type:"text",text:b.title||"æ¨™é¡Œ",weight:"bold",size:"xl",wrap:true,align:"center"},{type:"text",text:b.subtitle||"æè¿°",size:"sm",margin:"sm",color:"#666666",wrap:true}]}];
                    if (b.showBadge) bodyBox.push({type:"box",layout:"vertical",position:"absolute",backgroundColor:b.badgeColor,cornerRadius:"xl",paddingTop:"5px",paddingBottom:"2px",paddingStart:"20px",paddingEnd:"20px",offsetTop:"10px",offsetEnd:"10px",action:{type:"uri",label:"badge",uri:"https://line.me"},contents:[{type:"text",text:b.badgeText||"åˆ†äº«",color:"#ffffff",size:"10px",weight:"bold"}]});
                    bubble.body={type:"box",layout:"vertical",paddingAll:"0px",contents:bodyBox};
                }
                else if (b.type==='card') {
                    bubble.header={type:"box",layout:"horizontal",paddingAll:"8px",backgroundColor:b.headerBgColor,contents:[{type:"image",url:forceHttps(b.headerImg),size:"xs",aspectRatio:"1:1",aspectMode:"cover",gravity:"center"},{type:"box",layout:"vertical",flex:3,margin:"md",contents:[{type:"text",text:b.headerName||"å§“å",weight:"bold",color:b.headerTextColor,size:"lg"},{type:"text",text:b.headerDescription||"æ•˜è¿°",size:"xs",color:b.headerTextColor,wrap:true}]}]};
                    if (b.visualMode === 'video') {
                        bubble.hero = { type: "video", url: forceHttps(b.videoUrl), previewUrl: forceHttps(b.imageUrl), aspectRatio: "16:9", altContent: { type: "image", url: forceHttps(b.imageUrl), size: "full", aspectMode: "cover" } };
                    } else {
                        bubble.hero = { type: "image", url: forceHttps(b.imageUrl), size: "full", aspectRatio: "16:9", aspectMode: "cover", action: { type: "uri", label: "hero", uri: "https://line.me" } };
                    }
                    bubble.body={type:"box",layout:"vertical",backgroundColor:b.bodyBgColor,paddingAll:"8px",contents:[
                        {type:"box",layout:"horizontal",spacing:"sm",contents: b.gridButtons.slice(0,2).map(g=>({type:"box",layout:"vertical",paddingAll:"10px",backgroundColor:b.gridBgColor,cornerRadius:"12px",action:{type:"uri",label:g.label||"grid",uri:forceHttps(g.uri)},contents:[{type:"text",text:g.emoji||"ğŸ”˜",align:"center",size:"xl"},{type:"text",text:g.label||"é¸å–®",size:"sm",align:"center",color:"#E6E6E6"}]}))},
                        {type:"box",layout:"horizontal",spacing:"sm",margin:"sm",contents: b.gridButtons.slice(2,4).map(g=>({type:"box",layout:"vertical",paddingAll:"10px",backgroundColor:b.gridBgColor,cornerRadius:"12px",action:{type:"uri",label:g.label||"grid",uri:forceHttps(g.uri)},contents:[{type:"text",text:g.emoji||"ğŸ”˜",align:"center",size:"xl"},{type:"text",text:g.label||"é¸å–®",size:"sm",align:"center",color:"#E6E6E6"}]}))}
                    ]};
                }
                else if (b.type==='ecommerce') {
                    const rows = []; const cols = b.columns;
                    for (let i = 0; i < (b.items||[]).length; i += cols) {
                        const chunk = b.items.slice(i, i + cols);
                        const rowBox = { type: "box", layout: "horizontal", spacing: "sm", margin: i === 0 ? "none" : "sm", contents: [] };
                        chunk.forEach(item => {
                            rowBox.contents.push({
                                type: "box", layout: "vertical", flex: 1, 
                                contents: [
                                    { type: "image", url: forceHttps(item.img), aspectRatio: "1:1", aspectMode: "cover", size: "full" },
                                    { type: "box", layout: "vertical", backgroundColor: "#000000", paddingAll: "xs", contents: [{ type: "text", text: item.title || "å•†å“", color: "#FFFFFF", size: "xxs", align: "center", weight: "bold", wrap: true }] }
                                ],
                                action: { type: "uri", label: "item", uri: forceHttps(item.url) }
                            });
                        });
                        while (rowBox.contents.length < cols) { rowBox.contents.push({ type: "box", layout: "vertical", flex: 1, contents: [] }); }
                        rows.push(rowBox);
                    }
                    bubble.body={type:"box",layout:"vertical",paddingAll:"5px",backgroundColor:b.bgColor||"#f8f8f8",contents:rows};
                }
                bubble.footer={type:"box",layout:"vertical",spacing:"sm",paddingAll: "15px",contents: b.buttons.map(btn=>({type:"button",style:"primary",height:"sm",color:btn.color,action:{type:"uri",label:btn.label||"æŒ‰éˆ•",uri:forceHttps(btn.uri)}}))};
                return bubble;
            });
            return { type: "carousel", contents: contents };
        });

        const copyJson = () => { const raw = JSON.stringify(fullFlexJson.value, null, 2); const el = document.createElement('textarea'); el.value = raw; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); alert('Carousel JSON å·²è¤‡è£½ï¼'); };

        const pushMix = () => { if (!liff.isLoggedIn()) { liff.login(); return; } liff.shareTargetPicker([{ type: "flex", altText: carousel.value.altText, contents: cleanJson(fullFlexJson.value) }]).then(res => { if (res) alert("å¤šé æ¨æ’­æˆåŠŸï¼"); }); };

        onMounted(async () => { try { await liff.init({ liffId: "2008541971-Wgvz6gD8" }); } catch (e) {} });

        return { carousel, activeIndex, activeBubble, showAddModal, addNewBubble, removeBubble, moveLeft, moveRight, pushMix, copyJson, getTypeName: (t) => ({'article':'æ–‡ç« å‹','card':'å½±ç‰‡åç‰‡','ecommerce':'é›»å•†å•†åŸ'}[t]), getTypeIcon: (t) => ({'article':'fa-file-alt','card':'fa-id-card','ecommerce':'fa-shopping-cart'}[t]) };
    }
}).mount('#app');
</script>
</body>
</html>
