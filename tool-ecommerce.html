<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人電商版 LINE Flex Message Editor (v2.1.6)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; color: #000000; font-weight: 700; }
        .chat-room-bg { background-color: #7988a0; width: 100%; height: 100%; overflow-y: auto; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .flex-bubble-container { width: 100%; max-width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #000000; border-radius: 10px; }
        .aspect-16-9 { aspect-ratio: 16 / 9; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div class="flex-1 flex overflow-hidden">
        <!-- 左側編輯區 -->
        <aside class="w-full md:w-[500px] bg-white border-r-2 border-slate-300 overflow-y-auto p-6 space-y-6 custom-scrollbar z-10 flex-shrink-0">
            
            <div class="flex items-center justify-between">
                <h2 class="font-black text-xl text-slate-900 uppercase">電商版完整編輯器</h2>
                <button onclick="undo()" id="btn-undo" class="px-3 py-1 text-xs font-black border-2 border-slate-300 rounded-lg hover:bg-slate-100 disabled:opacity-30 flex items-center gap-1">
                    <i data-lucide="rotate-ccw" class="w-3 h-3"></i> 復原
                </button>
            </div>

            <!-- 1. Hero 視覺 -->
            <div class="border-2 border-black rounded-xl bg-white overflow-hidden shadow-sm">
                <div class="p-3 bg-slate-100 border-b-2 border-black flex items-center gap-2 font-black"><i data-lucide="video"></i> 頂部影片設定</div>
                <div class="p-4 space-y-3">
                    <input type="text" id="input-hero-url" oninput="updateConfig('heroUrl', this.value)" class="w-full text-sm p-2 border-2 border-slate-200 rounded font-bold outline-none" placeholder="封面圖連結">
                    <input type="text" id="input-video-url" oninput="updateConfig('videoUrl', this.value)" class="w-full text-sm p-2 border-2 border-slate-200 rounded font-bold outline-none" placeholder="影片 MP4 連結">
                </div>
            </div>

            <!-- 2. 背景設定 -->
            <div class="border-2 border-black rounded-xl bg-white overflow-hidden shadow-sm">
                <div class="p-3 bg-slate-100 border-b-2 border-black flex items-center gap-2 font-black"><i data-lucide="palette"></i> Body 背景圖片</div>
                <div class="p-4">
                    <input type="text" id="input-body-bg" oninput="updateConfig('bodyBg', this.value)" class="w-full text-sm p-2 border-2 border-slate-200 rounded font-bold outline-none" placeholder="Body 背景圖連結">
                </div>
            </div>

            <!-- 3. 商品清單 -->
            <div class="border-2 border-black rounded-xl bg-white overflow-hidden shadow-sm">
                <div class="p-3 bg-slate-100 border-b-2 border-black font-black flex items-center justify-between">
                    <span><i data-lucide="shopping-cart"></i> 商品管理</span>
                    <span id="item-count-badge" class="bg-black text-white px-2 rounded text-xs">0</span>
                </div>
                <div id="items-container" class="p-4 space-y-3"></div>
                <button onclick="addItem()" class="w-full py-3 bg-slate-50 border-t-2 border-black font-black hover:bg-slate-100 transition">+ 新增商品</button>
            </div>

            <!-- 4. 動作按鈕 -->
            <div class="border-2 border-black rounded-xl bg-white overflow-hidden shadow-sm mb-10">
                <div class="p-3 bg-slate-100 border-b-2 border-black font-black flex items-center gap-2"><i data-lucide="external-link"></i> 底部按鈕連結</div>
                <div class="p-4 space-y-4">
                    <div class="p-3 bg-slate-50 border rounded-lg space-y-2">
                        <div class="text-[10px] font-black">按鈕 1</div>
                        <input type="text" id="input-f1-label" oninput="updateConfig('f1L', this.value)" class="w-full text-sm p-1 border rounded" placeholder="名稱">
                        <input type="text" id="input-f1-uri" oninput="updateConfig('f1U', this.value)" class="w-full text-[10px] p-1 border rounded font-mono" placeholder="連結 URL">
                    </div>
                    <div class="p-3 bg-slate-50 border rounded-lg space-y-2">
                        <div class="text-[10px] font-black">按鈕 2</div>
                        <input type="text" id="input-f2-label" oninput="updateConfig('f2L', this.value)" class="w-full text-sm p-1 border rounded" placeholder="名稱">
                        <input type="text" id="input-f2-uri" oninput="updateConfig('f2U', this.value)" class="w-full text-[10px] p-1 border rounded font-mono" placeholder="連結 URL">
                    </div>
                </div>
            </div>
        </aside>

        <!-- 右側預覽區 -->
        <main class="flex-1 bg-slate-200 chat-room-bg custom-scrollbar relative">
            <div class="flex items-start gap-2 mb-8 w-full justify-center">
                <div class="bg-white rounded-xl overflow-hidden flex-bubble-container flex flex-col">
                    <!-- Hero 預覽 -->
                    <div id="view-hero-container" class="relative w-full aspect-16-9 bg-black overflow-hidden shrink-0">
                        <img id="view-video-poster" src="" class="absolute inset-0 w-full h-full object-cover opacity-60">
                        <div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play" class="w-12 h-12 text-white fill-white"></i></div>
                    </div>
                    <!-- Body 預覽 -->
                    <div class="relative w-full p-4" id="view-body-container">
                        <img id="view-body-bg" src="" class="absolute inset-0 w-full h-full object-cover z-0">
                        <div id="view-grid" class="relative z-10 grid grid-cols-3 gap-2"></div>
                    </div>
                    <!-- Footer 預覽 -->
                    <div class="p-3 border-t border-slate-100 flex gap-2" id="view-footer">
                        <div id="view-btn-1" class="flex-1 py-2 rounded text-[10px] font-black text-white text-center bg-black"></div>
                        <div id="view-btn-2" class="flex-1 py-2 rounded text-[10px] font-black text-white text-center bg-black"></div>
                    </div>
                </div>
            </div>
            <div class="h-20 w-full shrink-0"></div>
        </main>
    </div>

    <script>
        lucide.createIcons();

        let state = {
            hero: { url: "", videoUrl: "" },
            body: { bg: "", items: [] },
            footer: { btn1: { label: "", uri: "" }, btn2: { label: "", uri: "" } }
        };

        let history = [];

        // --- 與母系統通訊 ---
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'LOAD_FLEX_DATA') {
                try {
                    const flexJson = JSON.parse(event.data.json);
                    reverseMapFlexToState(flexJson);
                    syncUI();
                    render();
                } catch(e) { console.error("解析失敗", e); }
            }
        });

        window.onload = () => {
            window.parent.postMessage({ type: 'CHILD_READY' }, '*');
        };

        function syncToParent() {
            const flexJson = generateFlexJSON();
            window.parent.postMessage({ type: 'SYNC_FLEX_DATA', json: JSON.stringify(flexJson) }, '*');
        }

        // --- 逆向解析：核心功能 ---
        function reverseMapFlexToState(flex) {
            // 1. Hero
            state.hero.url = flex.hero?.previewUrl || "";
            state.hero.videoUrl = flex.hero?.url || "";

            // 2. Body Background & Items
            const bodyBox = flex.body?.contents?.[0]; // 外部容器
            // 尋找背景圖
            state.body.bg = bodyBox?.contents?.[0]?.url || "";
            
            // 尋找商品列表 (通常在第二個垂直 Box)
            const contentBox = bodyBox?.contents?.[1];
            const rows = contentBox?.contents || [];
            let allItems = [];
            rows.forEach(row => {
                if (row.contents) {
                    row.contents.forEach(item => {
                        allItems.push({
                            title: item.contents?.[1]?.contents?.[0]?.text || "未命名",
                            img: item.contents?.[0]?.url || "",
                            url: item.action?.uri || ""
                        });
                    });
                }
            });
            state.body.items = allItems;

            // 3. Footer Buttons
            const btns = flex.footer?.contents || [];
            if (btns[0]) {
                state.footer.btn1.label = btns[0].action?.label || "";
                state.footer.btn1.uri = btns[0].action?.uri || "";
            }
            if (btns[1]) {
                state.footer.btn2.label = btns[1].action?.label || "";
                state.footer.btn2.uri = btns[1].action?.uri || "";
            }
        }

        function saveState() {
            if (history.length > 20) history.shift();
            history.push(JSON.parse(JSON.stringify(state)));
            document.getElementById('btn-undo').disabled = false;
        }

        function undo() {
            if (history.length > 0) {
                state = history.pop();
                if (history.length === 0) document.getElementById('btn-undo').disabled = true;
                syncUI(); render(); syncToParent();
            }
        }

        function updateConfig(path, value) {
            saveState();
            if(path === 'heroUrl') state.hero.url = value;
            if(path === 'videoUrl') state.hero.videoUrl = value;
            if(path === 'bodyBg') state.body.bg = value;
            if(path === 'f1L') state.footer.btn1.label = value;
            if(path === 'f1U') state.footer.btn1.uri = value;
            if(path === 'f2L') state.footer.btn2.label = value;
            if(path === 'f2U') state.footer.btn2.uri = value;
            render(); syncToParent();
        }

        function addItem() {
            saveState();
            state.body.items.push({ title: "新商品", img: "https://lihi.cc/mwMvo", url: "https://line.me" });
            syncUI(); render(); syncToParent();
        }

        function syncUI() {
            document.getElementById('input-hero-url').value = state.hero.url;
            document.getElementById('input-video-url').value = state.hero.videoUrl;
            document.getElementById('input-body-bg').value = state.body.bg;
            document.getElementById('input-f1-label').value = state.footer.btn1.label;
            document.getElementById('input-f1-uri').value = state.footer.btn1.uri;
            document.getElementById('input-f2-label').value = state.footer.btn2.label;
            document.getElementById('input-f2-uri').value = state.footer.btn2.uri;
            document.getElementById('item-count-badge').innerText = state.body.items.length;

            const container = document.getElementById('items-container');
            container.innerHTML = '';
            state.body.items.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = "p-3 bg-white border-2 border-slate-200 rounded-lg space-y-2 relative shadow-sm";
                div.innerHTML = `
                    <button onclick="state.body.items.splice(${i},1);syncUI();render();syncToParent()" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    <div class="flex items-center gap-3">
                        <img src="${item.img}" class="w-10 h-10 rounded object-cover border">
                        <input type="text" value="${item.title}" oninput="state.body.items[${i}].title=this.value;render();syncToParent()" class="flex-1 text-sm border-b font-black outline-none" placeholder="品名">
                    </div>
                    <input type="text" value="${item.img}" oninput="state.body.items[${i}].img=this.value;render();syncToParent()" class="w-full text-[9px] border rounded p-1 font-mono" placeholder="圖片連結">
                    <input type="text" value="${item.url}" oninput="state.body.items[${i}].url=this.value;render();syncToParent()" class="w-full text-[9px] border rounded p-1 font-mono" placeholder="點擊跳轉連結">
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function render() {
            document.getElementById('view-video-poster').src = state.hero.url;
            document.getElementById('view-body-bg').src = state.body.bg;
            const grid = document.getElementById('view-grid');
            grid.innerHTML = '';
            state.body.items.forEach(item => {
                const el = document.createElement('div');
                el.className = "bg-white rounded p-1 shadow-sm flex flex-col";
                el.innerHTML = `
                    <div class="relative w-full aspect-square bg-slate-100 rounded-sm overflow-hidden mb-1"><img src="${item.img}" class="w-full h-full object-cover"></div>
                    <div style="background-color: #0D0D0D; color: #FFFFFF;" class="text-[8px] font-black text-center py-0.5 rounded-sm truncate">${item.title}</div>
                `;
                grid.appendChild(el);
            });
            document.getElementById('view-btn-1').innerText = state.footer.btn1.label || "按鈕 1";
            document.getElementById('view-btn-2').innerText = state.footer.btn2.label || "按鈕 2";
        }

        function generateFlexJSON() {
            const chunk = (arr, size) => Array.from({ length: Math.ceil(arr.length / size) }, (v, i) => arr.slice(i * size, i * size + size));
            return {
                "type": "bubble", "size": "mega",
                "hero": { "type": "video", "url": state.hero.videoUrl, "previewUrl": state.hero.url, "aspectRatio": "16:9", "altContent": { "type": "image", "size": "full", "aspectRatio": "16:9", "aspectMode": "cover", "url": state.hero.url } },
                "body": {
                    "type": "box", "layout": "vertical", "backgroundColor": "#F8F8F8", "paddingAll": "none",
                    "contents": [{ "type": "box", "layout": "vertical", "contents": [
                        { "type": "image", "url": state.body.bg, "position": "absolute", "size": "full", "aspectMode": "cover" },
                        { "type": "box", "layout": "vertical", "paddingAll": "md", "contents": chunk(state.body.items, 3).map(row => ({
                            "type": "box", "layout": "horizontal", "contents": row.map(item => ({
                                "type": "box", "layout": "vertical", "width": "32%", "action": { "type": "uri", "uri": item.url },
                                "contents": [
                                    { "type": "image", "url": item.img, "aspectRatio": "1:1", "size": "full", "aspectMode": "cover" },
                                    { "type": "box", "layout": "vertical", "backgroundColor": "#0D0D0D", "cornerRadius": "sm", "paddingAll": "xs", "margin": "sm", "contents": [{ "type": "text", "text": item.title, "size": "xxs", "color": "#FFFFFF", "align": "center", "weight": "bold", "wrap": true }] }
                                ]
                            }))
                        }))}
                    ]}]
                },
                "footer": { "type": "box", "layout": "horizontal", "spacing": "md", "backgroundColor": "#ffffff", "paddingTop": "md", "contents": [
                    { "type": "button", "style": "primary", "height": "sm", "color": "#000000", "action": { "type": "uri", "label": state.footer.btn1.label, "uri": state.footer.btn1.uri } },
                    { "type": "button", "style": "primary", "height": "sm", "color": "#000000", "action": { "type": "uri", "label": state.footer.btn2.label, "uri": state.footer.btn2.uri } }
                ]}
            };
        }
    </script>
</body>
</html>
