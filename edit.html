<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·¨è¼¯æˆ‘çš„å°ˆå±¬åç‰‡</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #1A1B1E; color: white; overflow-x: hidden; }
        
        [v-cloak] { display: none !important; }

        .card-container { max-width: 450px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
        
        .edit-highlight { border: 2px dashed rgba(0, 185, 0, 0.5); cursor: pointer; transition: all 0.2s; position: relative; border-radius: 8px; }
        .edit-highlight:hover { background-color: rgba(0, 185, 0, 0.15); border-color: #00B900; }
        
        .edit-icon { position: absolute; top: -10px; right: -10px; background: #00B900; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.5); pointer-events: none; }
        
        .edit-highlight-circle { border-radius: 50%; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(5px); }
        .modal-content { background: white; color: #333; padding: 24px; border-radius: 24px; width: 90%; max-width: 340px; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .flex-bubble { background: #1A1B1E; border-radius: 16px; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.6); border: 1px solid #333; }
        .header-box { padding: 20px; display: flex; align-items: center; gap: 15px; }
        .hero-img { width: 100%; aspect-ratio: 20/13; object-fit: cover; }
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
        .grid-item { background-color: #2A2C31; padding: 15px; text-align: center; }
        .footer-box { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .action-btn { width: 100%; padding: 12px; font-weight: bold; text-align: center; font-size: 14px; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    <div v-if="loading" class="fixed inset-0 bg-[#1A1B1E] z-[200] flex flex-col items-center justify-center text-green-500">
        <i class="fas fa-circle-notch fa-spin text-5xl mb-6"></i>
        <p class="text-sm font-bold tracking-widest uppercase">æ­£åœ¨è®€å–æ‚¨çš„å°ˆå±¬åç‰‡...</p>
    </div>

    <div class="sticky top-0 bg-[#1A1B1E]/95 backdrop-blur-md border-b border-gray-800 p-4 flex justify-between items-center z-50 shadow-md">
        <h1 class="font-bold text-lg text-white flex items-center"><i class="fas fa-magic text-green-500 mr-2"></i>åç‰‡ç·¨è¼¯å™¨</h1>
        <button @click="saveCard" :disabled="saving" class="bg-green-600 hover:bg-green-500 text-white px-5 py-2 rounded-full text-sm font-bold transition-all disabled:opacity-50 shadow-lg shadow-green-900/50 flex items-center gap-2">
            <i v-if="saving" class="fas fa-spinner fa-spin"></i>
            <span v-else><i class="fas fa-save mr-1"></i> å„²å­˜æ›´æ–°</span>
        </button>
    </div>

    <div class="card-container">
        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-3 mb-6 text-center shadow-inner">
            <p class="text-yellow-400 text-xs font-bold tracking-wider">ğŸ‘† é»æ“Šä¸‹æ–¹<span class="border-b border-dashed border-yellow-400 mx-1">è™›ç·šæ¡†å€åŸŸ</span>å³å¯ç›´æ¥ä¿®æ”¹å…§å®¹</p>
        </div>

        <div class="flex-bubble">
            <div class="header-box">
                <div class="relative group cursor-pointer edit-highlight edit-highlight-circle p-1" @click="openEdit('image', 'headImg', 'æ›´æ›å€‹äººé ­åƒ')">
                    <img :src="card.headImg" class="w-14 h-14 rounded-full object-cover border border-gray-600" onerror="this.src='https://placehold.co/150'">
                    <div class="edit-icon"><i class="fas fa-camera"></i></div>
                </div>
                <div class="flex-1 flex flex-col gap-2 overflow-hidden">
                    <div class="relative w-fit max-w-full edit-highlight p-1" @click="openEdit('text', 'name', 'ä¿®æ”¹å§“å/æš±ç¨±')">
                        <span class="text-[#D4AF37] font-bold text-xl block truncate">{{ card.name }}</span>
                        <div class="edit-icon"><i class="fas fa-pen"></i></div>
                    </div>
                    <div class="relative w-full edit-highlight p-1" @click="openEdit('text', 'desc', 'ä¿®æ”¹å€‹äººç°¡ä»‹')">
                        <span class="text-[#D4AF37] text-xs block leading-relaxed whitespace-pre-wrap opacity-90">{{ card.desc }}</span>
                        <div class="edit-icon"><i class="fas fa-pen"></i></div>
                    </div>
                </div>
            </div>

            <div class="relative group edit-highlight m-3 mt-0" @click="openEdit('image', 'heroImg', 'æ›´æ›åç‰‡ä¸»è¦–è¦ºåœ–ç‰‡')">
                <img :src="card.heroImg" class="hero-img rounded-lg" onerror="this.src='https://placehold.co/800x520'">
                <div class="edit-icon" style="top: 10px; right: 10px; width: 32px; height: 32px; font-size: 14px;"><i class="fas fa-image"></i></div>
            </div>

            <div class="grid-box">
                <div v-for="(btn, idx) in card.grids" :key="idx" class="grid-item relative edit-highlight flex flex-col items-center justify-center" @click="openEdit('grid', idx, `è¨­å®šç¶²æ ¼æŒ‰éˆ• ${idx+1}`)">
                    <div class="text-3xl mb-2">{{ btn.emoji }}</div>
                    <div class="text-gray-300 text-xs font-bold w-full truncate">{{ btn.label }}</div>
                    <div class="edit-icon"><i class="fas fa-cog"></i></div>
                </div>
            </div>

            <div class="footer-box">
                <div v-for="(btn, idx) in card.footerBtns" :key="idx" class="relative edit-highlight p-1" @click="openEdit('button', idx, `è¨­å®šä¸»æŒ‰éˆ• ${idx+1}`)">
                    <div class="action-btn text-white rounded-lg shadow-sm" :style="{ backgroundColor: btn.color }">
                        {{ btn.label }}
                    </div>
                    <div class="edit-icon"><i class="fas fa-link"></i></div>
                </div>
            </div>
        </div>
    </div>

    <!-- å½ˆçª— -->
    <div v-if="editing.show" class="modal-overlay" @click.self="editing.show = false">
        <div class="modal-content shadow-2xl">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <h3 class="font-bold text-lg text-gray-800"><i class="fas fa-edit text-line-green mr-2"></i>{{ editing.title }}</h3>
                <button @click="editing.show = false" class="text-gray-400 hover:text-red-500 transition-colors w-8 h-8 flex items-center justify-center rounded-full bg-gray-100"><i class="fas fa-times"></i></button>
            </div>
            
            <div v-if="editing.type === 'text'" class="space-y-2">
                <template v-if="editing.key === 'desc'">
                    <label class="block text-xs font-bold text-gray-500 ml-1">ç°¡ä»‹å…§å®¹ (å»ºè­° 50 å­—å…§)</label>
                    <textarea v-model="tempValue" rows="4" class="w-full border-2 border-gray-200 p-3 rounded-xl outline-none focus:border-green-500 focus:ring-4 focus:ring-green-500/20 text-sm transition-all" placeholder="è«‹è¼¸å…¥æè¿°..."></textarea>
                </template>
                <template v-else>
                    <label class="block text-xs font-bold text-gray-500 ml-1">é¡¯ç¤ºåç¨±</label>
                    <input v-model="tempValue" class="w-full border-2 border-gray-200 p-3 rounded-xl outline-none focus:border-green-500 focus:ring-4 focus:ring-green-500/20 font-bold transition-all" placeholder="è«‹è¼¸å…¥å§“å...">
                </template>
            </div>

            <div v-if="editing.type === 'image'" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">åœ–ç‰‡é€£çµ (å¯ç›´æ¥è²¼ç¶²å€æˆ–ä¸Šå‚³)</label>
                    <div class="flex gap-2">
                        <input v-model="tempValue" class="flex-1 border-2 border-gray-200 p-3 rounded-xl outline-none focus:border-green-500 focus:ring-4 focus:ring-green-500/20 text-xs font-mono transition-all bg-slate-50" placeholder="https://...">
                        
                        <!-- æ–°å¢ï¼šä¸Šå‚³æŒ‰éˆ• -->
                        <label class="bg-blue-50 text-blue-600 px-4 py-3 rounded-xl font-bold text-xs cursor-pointer hover:bg-blue-100 transition-colors flex items-center justify-center border border-blue-200 shrink-0">
                            <i v-if="isUploading" class="fas fa-spinner fa-spin"></i>
                            <span v-else><i class="fas fa-upload mr-1"></i>ä¸Šå‚³åœ–ç‰‡</span>
                            <input type="file" class="hidden" accept="image/*" @change="handleImageUpload" :disabled="isUploading">
                        </label>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1 ml-1 italic">* æª”æ¡ˆé™åˆ¶: 5MB ä»¥ä¸‹ (å°‡è‡ªå‹•å­˜è‡³ Google Drive)</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">åœ–ç‰‡é è¦½</label>
                    <div class="relative w-full h-32 bg-gray-100 rounded-xl overflow-hidden border-2 border-gray-200 shadow-inner">
                        <img :src="tempValue" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/300x200?text=Image+Error'">
                    </div>
                </div>
            </div>

            <div v-if="editing.type === 'grid'" class="space-y-4">
                <div class="grid grid-cols-3 gap-3">
                    <div class="col-span-1">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Emoji</label>
                        <input v-model="tempGrid.emoji" class="w-full border-2 border-gray-200 p-3 rounded-xl text-center text-xl outline-none focus:border-green-500 transition-all">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">æŒ‰éˆ•åç¨±</label>
                        <input v-model="tempGrid.label" class="w-full border-2 border-gray-200 p-3 rounded-xl outline-none focus:border-green-500 font-bold transition-all" placeholder="åç¨±">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">è·³è½‰é€£çµ (URL)</label>
                    <input v-model="tempGrid.uri" class="w-full border-2 border-gray-200 p-3 rounded-xl outline-none focus:border-green-500 text-xs font-mono transition-all" placeholder="https://...">
                </div>
            </div>

            <div v-if="editing.type === 'button'" class="space-y-4">
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">æŒ‰éˆ•æ–‡å­—</label>
                        <input v-model="tempBtn.label" class="w-full border-2 border-gray-200 p-3 rounded-xl outline-none focus:border-green-500 font-bold transition-all">
                    </div>
                    <div class="w-20">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">é¡è‰²</label>
                        <div class="border-2 border-gray-200 rounded-xl overflow-hidden h-[52px] flex items-center justify-center p-1 focus-within:border-green-500 transition-all">
                            <input type="color" v-model="tempBtn.color" class="w-full h-full cursor-pointer bg-transparent border-0 outline-none p-0 m-0">
                        </div>
                    </div>
                </div>
                <div v-if="editing.key !== 1"> 
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">è·³è½‰é€£çµ (URL)</label>
                    <input v-model="tempBtn.uri" class="w-full border-2 border-gray-200 p-3 rounded-xl outline-none focus:border-green-500 text-xs font-mono transition-all" placeholder="https://...">
                </div>
                <div v-else class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                    <p class="text-[10px] text-blue-600 font-bold"><i class="fas fa-info-circle mr-1"></i> æ­¤ç‚ºã€æ¨è–¦åˆ†äº«ã€‘æŒ‰éˆ•ï¼Œç³»çµ±å°‡è‡ªå‹•å¥—ç”¨æ‚¨çš„å°ˆå±¬åˆ†äº«é€£çµï¼Œç„¡éœ€è¨­å®šç¶²å€ã€‚</p>
                </div>
            </div>

            <div class="flex gap-3 mt-6 pt-2">
                <button @click="editing.show = false" class="flex-1 py-3.5 text-gray-500 font-bold bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors">å–æ¶ˆ</button>
                <button @click="confirmEdit" class="flex-[2] py-3.5 text-white font-bold bg-green-600 rounded-xl hover:bg-green-500 transition-colors shadow-lg shadow-green-200 flex justify-center items-center gap-2">
                    <i class="fas fa-check"></i> ç¢ºå®šä¿®æ”¹
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, onMounted } = Vue;
const workerUrl = "https://lineoa.fangwl591021.workers.dev"; 

createApp({
    setup() {
        const loading = ref(true);
        const saving = ref(false);
        const isUploading = ref(false);
        const userId = ref('');
        
        const card = ref({
            name: 'è¼‰å…¥ä¸­...',
            desc: '...',
            headImg: 'https://placehold.co/150',
            heroImg: 'https://aiwe.cc/wp-content/uploads/2026/02/57490900246d39710f4e3dda991c0d60.png',
            grids: [
                { emoji: 'ğŸ¤–', label: 'AI è«®è©¢', uri: 'https://line.me' },
                { emoji: 'ğŸ¥', label: 'å¯¦ç¸¾æ¡ˆä¾‹', uri: 'https://line.me' },
                { emoji: 'ğŸ§¾', label: 'æœå‹™é …ç›®', uri: 'https://line.me' },
                { emoji: 'ğŸ“', label: 'é ç´„é¢è«‡', uri: 'https://line.me' }
            ],
            footerBtns: [
                { label: 'ğŸš€ ç«‹å³å•Ÿå‹• AI åˆä½œ', color: '#C9A24D', uri: 'https://line.me' },
                { label: 'ğŸ“¤ æ¨è–¦çµ¦å¥½å‹', color: '#2A2C31', uri: 'https://line.me' } 
            ]
        });

        const editing = ref({ show: false, type: '', key: '', title: '' });
        const tempValue = ref('');
        const tempGrid = ref({});
        const tempBtn = ref({});

        const initLiff = async () => {
            try {
                await liff.init({ liffId: "2008924519-1qRqocsa" });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                userId.value = profile.userId;
                fetchUserData(profile.userId);
            } catch (e) {
                console.error("LIFF Init Error:", e);
                alert("LIFF è¼‰å…¥å¤±æ•—: " + e.message);
                loading.value = false;
            }
        };

        const fetchUserData = async (uid) => {
            try {
                const res = await fetch(workerUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getUserData', userId: uid })
                });
                const result = await res.json();
                
                if (result.status === 'success' && result.data) {
                    const d = result.data;
                    if (d.cardJson && d.cardJson.length > 10) {
                        try {
                            const saved = JSON.parse(d.cardJson);
                            if (saved.name && saved.grids) {
                                card.value = saved;
                            } else {
                                useDefaultData(d); 
                            }
                        } catch(e) {
                            useDefaultData(d);
                        }
                    } else {
                        useDefaultData(d); 
                    }
                } else {
                    liff.getProfile().then(p => {
                        useDefaultData({ displayName: p.displayName, statusMessage: p.statusMessage, pictureUrl: p.pictureUrl });
                    }).catch(() => {
                        useDefaultData({ displayName: 'è¨ªå®¢', statusMessage: 'æ­¡è¿è¯ç¹«', pictureUrl: 'https://placehold.co/150' });
                    });
                }
            } catch (e) {
                console.error("Fetch Error:", e);
                alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
            } finally {
                loading.value = false;
            }
        };

        const useDefaultData = (d) => {
            card.value.name = d.displayName || 'ä½¿ç”¨è€…';
            card.value.desc = d.statusMessage || 'æ­¡è¿è¯ç¹«';
            card.value.headImg = d.pictureUrl || 'https://placehold.co/150';
        };

        const openEdit = (type, key, title) => {
            editing.value = { show: true, type, key, title };
            if (type === 'text' || type === 'image') {
                tempValue.value = card.value[key] || '';
            } else if (type === 'grid') {
                tempGrid.value = { ...card.value.grids[key] };
            } else if (type === 'button') {
                tempBtn.value = { ...card.value.footerBtns[key] };
            }
        };

        // --- æ–°å¢ï¼šè™•ç†åœ–ç‰‡ä¸Šå‚³ ---
        const handleImageUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                alert('åœ–ç‰‡æª”æ¡ˆéå¤§ï¼Œè«‹ä¸Šå‚³å°æ–¼ 5MB çš„åœ–ç‰‡ã€‚');
                return;
            }

            isUploading.value = true;
            
            try {
                // å°‡åœ–ç‰‡è½‰ç‚º Base64
                const base64Data = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]); 
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });

                const payload = {
                    action: 'uploadImage',
                    filename: `${Date.now()}_${file.name}`,
                    mimeType: file.type,
                    base64Data: base64Data
                };

                const res = await fetch(workerUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await res.json();
                
                if (result.status === 'success') {
                    // è‡ªå‹•å¡«å…¥å›å‚³çš„ç›´é€£ç¶²å€
                    tempValue.value = result.url;
                } else {
                    alert('ä¸Šå‚³å¤±æ•—: ' + result.message);
                }
            } catch (error) {
                console.error('Upload Error:', error);
                alert('åœ–ç‰‡è™•ç†ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚');
            } finally {
                isUploading.value = false;
                event.target.value = ''; // æ¸…é™¤ input é¸æ“‡
            }
        };

        const confirmEdit = () => {
            const { type, key } = editing.value;
            if (type === 'text' || type === 'image') {
                let val = tempValue.value.trim();
                if (type === 'image' && val && !val.startsWith('http')) val = 'https://' + val;
                card.value[key] = val;
            } else if (type === 'grid') {
                let uri = tempGrid.value.uri.trim();
                if (uri && !uri.startsWith('http')) uri = 'https://' + uri;
                card.value.grids[key] = { ...tempGrid.value, uri };
            } else if (type === 'button') {
                let uri = tempBtn.value.uri.trim();
                if (uri && !uri.startsWith('http')) uri = 'https://' + uri;
                card.value.footerBtns[key] = { ...tempBtn.value, uri };
            }
            editing.value.show = false;
        };

        const saveCard = async () => {
            saving.value = true;
            try {
                const payload = {
                    action: 'saveUserCard',
                    userId: userId.value,
                    cardJson: JSON.stringify(card.value),
                    displayName: card.value.name,       
                    statusMessage: card.value.desc,     
                    pictureUrl: card.value.headImg      
                };
                
                const res = await fetch(workerUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) 
                });
                
                const result = await res.json();
                if (result.status === 'success') {
                    alert("âœ… åç‰‡è¨­å®šå·²æˆåŠŸæ›´æ–°ï¼\nè«‹å›åˆ°èŠå¤©å®¤é‡æ–°è¼¸å…¥ã€Œé¡¯ç¤ºåç‰‡ã€æŸ¥çœ‹çµæœã€‚");
                    if(liff.isInClient()) liff.closeWindow(); 
                } else {
                    alert("å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                }
            } catch (e) {
                console.error("Save Error:", e);
                alert("å„²å­˜é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
            } finally {
                saving.value = false;
            }
        };

        onMounted(() => {
            initLiff();
        });

        return { 
            loading, saving, isUploading, card, editing, 
            tempValue, tempGrid, tempBtn, 
            openEdit, handleImageUpload, confirmEdit, saveCard
        };
    }
}).mount('#app');
</script>
</body>
</html>
