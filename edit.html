<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·¨è¼¯æˆ‘çš„åç‰‡</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #1A1B1E; color: white; overflow-x: hidden; }
        
        /* è¼‰å…¥å‹•ç•« */
        #app { opacity: 0; transition: opacity 0.3s; }
        #app.loaded { opacity: 1; }

        .card-container { max-width: 400px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
        
        /* ç·¨è¼¯æ¡†ç·šæ•ˆæœ */
        .edit-highlight { border: 2px dashed #00B900; cursor: pointer; transition: all 0.2s; position: relative; }
        .edit-highlight:hover { background-color: rgba(0, 185, 0, 0.1); border-color: #fff; }
        .edit-icon { position: absolute; top: -10px; right: -10px; background: #00B900; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(5px); }
        .modal-content { background: white; color: #333; padding: 24px; border-radius: 20px; width: 90%; max-width: 320px; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* æ¨¡æ“¬ Flex Message */
        .flex-bubble { background: #1A1B1E; border-radius: 14px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333; }
        .header-box { padding: 20px; display: flex; align-items: center; gap: 15px; }
        .hero-img { width: 100%; aspect-ratio: 20/13; object-fit: cover; }
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 12px; }
        .grid-item { background-color: #2A2C31; border-radius: 12px; padding: 12px; text-align: center; }
        .footer-box { padding: 12px; display: flex; flex-direction: column; gap: 8px; }
        .action-btn { width: 100%; padding: 10px; border-radius: 8px; font-weight: bold; text-align: center; font-size: 14px; }
    </style>
</head>
<body>

<div id="app" :class="{ 'loaded': isLoaded }">
    <!-- Loading -->
    <div v-if="loading" class="fixed inset-0 bg-black z-[200] flex flex-col items-center justify-center text-green-500">
        <i class="fas fa-circle-notch fa-spin text-4xl mb-4"></i>
        <p class="text-xs font-bold tracking-widest uppercase">è®€å–æ‚¨çš„åç‰‡è³‡æ–™...</p>
    </div>

    <!-- é ‚éƒ¨å°è¦½ -->
    <div class="sticky top-0 bg-[#1A1B1E]/95 backdrop-blur border-b border-gray-800 p-4 flex justify-between items-center z-50">
        <h1 class="font-bold text-lg text-white flex items-center"><i class="fas fa-edit text-green-500 mr-2"></i>ç·¨è¼¯æ¨¡å¼</h1>
        <button @click="saveCard" :disabled="saving" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-full text-sm font-bold transition-all disabled:opacity-50 shadow-lg flex items-center gap-2">
            <i v-if="saving" class="fas fa-spinner fa-spin"></i>
            <span v-else>å„²å­˜ä¸¦æ›´æ–°</span>
        </button>
    </div>

    <!-- ç·¨è¼¯å€åŸŸ -->
    <div class="card-container">
        <div class="bg-yellow-100/10 border border-yellow-500/30 rounded-lg p-3 mb-6 text-center">
            <p class="text-yellow-400 text-xs font-bold">ğŸ‘† é»æ“Šä¸‹æ–¹è™›ç·šæ¡†å³å¯ä¿®æ”¹å…§å®¹</p>
        </div>

        <div class="flex-bubble">
            <!-- Header -->
            <div class="header-box">
                <div class="relative group cursor-pointer" @click="openEdit('image', 'headImg', 'æ›´æ›é ­åƒ')">
                    <img :src="card.headImg" class="w-16 h-16 rounded-full object-cover border-2 border-gray-700 edit-highlight">
                    <div class="edit-icon"><i class="fas fa-camera"></i></div>
                </div>
                <div class="flex-1 flex flex-col gap-2">
                    <div class="relative w-fit" @click="openEdit('text', 'name', 'ä¿®æ”¹å§“å')">
                        <span class="text-[#D4AF37] font-bold text-xl edit-highlight px-2 rounded block">{{ card.name }}</span>
                        <div class="edit-icon"><i class="fas fa-pen"></i></div>
                    </div>
                    <div class="relative w-full" @click="openEdit('text', 'desc', 'ä¿®æ”¹æè¿°')">
                        <span class="text-[#D4AF37] text-xs edit-highlight px-2 py-1 rounded block leading-relaxed whitespace-pre-wrap">{{ card.desc }}</span>
                        <div class="edit-icon"><i class="fas fa-pen"></i></div>
                    </div>
                </div>
            </div>

            <!-- Hero -->
            <div class="relative group" @click="openEdit('image', 'heroImg', 'æ›´æ›å°é¢åœ–ç‰‡')">
                <img :src="card.heroImg" class="hero-img edit-highlight">
                <div class="edit-icon" style="top: 15px; right: 15px; width: 30px; height: 30px;"><i class="fas fa-image"></i></div>
                <div class="absolute bottom-2 right-2 bg-black/50 text-[10px] px-2 rounded">20:13</div>
            </div>

            <!-- Body (Grid) -->
            <div class="grid-box">
                <div v-for="(btn, idx) in card.grids" :key="idx" class="grid-item relative edit-highlight group" @click="openEdit('grid', idx, `ç·¨è¼¯æŒ‰éˆ• ${idx+1}`)">
                    <div class="text-3xl mb-2">{{ btn.emoji }}</div>
                    <div class="text-gray-300 text-xs font-bold">{{ btn.label }}</div>
                    <div class="edit-icon group-hover:scale-110 transition-transform"><i class="fas fa-cog"></i></div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer-box">
                <div v-for="(btn, idx) in card.footerBtns" :key="idx" class="relative edit-highlight group" @click="openEdit('button', idx, `ç·¨è¼¯åº•éƒ¨æŒ‰éˆ• ${idx+1}`)">
                    <div class="action-btn text-white" :style="{ backgroundColor: btn.color }">
                        {{ btn.label }}
                    </div>
                    <div class="edit-icon group-hover:scale-110 transition-transform"><i class="fas fa-pen"></i></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯å½ˆçª— -->
    <div v-if="editing.show" class="modal-overlay" @click.self="editing.show = false">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-gray-800">{{ editing.title }}</h3>
                <button @click="editing.show = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- æ–‡å­—ç·¨è¼¯ -->
            <div v-if="editing.type === 'text'">
                <template v-if="editing.key === 'desc'">
                    <textarea v-model="tempValue" rows="5" class="w-full border p-3 rounded-xl outline-none focus:ring-2 focus:ring-green-500 mb-4 bg-slate-50 text-sm" placeholder="è«‹è¼¸å…¥æè¿°..."></textarea>
                </template>
                <template v-else>
                    <input v-model="tempValue" class="w-full border p-3 rounded-xl outline-none focus:ring-2 focus:ring-green-500 mb-4 bg-slate-50" placeholder="è«‹è¼¸å…¥å…§å®¹...">
                </template>
            </div>

            <!-- åœ–ç‰‡ç·¨è¼¯ -->
            <div v-if="editing.type === 'image'">
                <label class="block text-xs font-bold text-gray-500 mb-1">åœ–ç‰‡ç¶²å€ (HTTPS)</label>
                <input v-model="tempValue" class="w-full border p-3 rounded-xl outline-none focus:ring-2 focus:ring-green-500 mb-4 text-xs bg-slate-50">
                <div class="relative w-full h-32 bg-gray-100 rounded-xl overflow-hidden border">
                    <img :src="tempValue" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/300x200?text=Invalid+Image'">
                </div>
            </div>

            <!-- ç¶²æ ¼æŒ‰éˆ•ç·¨è¼¯ -->
            <div v-if="editing.type === 'grid'">
                <div class="mb-3">
                    <label class="block text-xs font-bold text-gray-500 mb-1">åœ–ç¤º (Emoji)</label>
                    <input v-model="tempGrid.emoji" class="w-full border p-2 rounded-lg text-center text-2xl bg-slate-50">
                </div>
                <div class="mb-3">
                    <label class="block text-xs font-bold text-gray-500 mb-1">æŒ‰éˆ•åç¨±</label>
                    <input v-model="tempGrid.label" class="w-full border p-2 rounded-lg bg-slate-50">
                </div>
                <div class="mb-3">
                    <label class="block text-xs font-bold text-gray-500 mb-1">é€£çµ (URL)</label>
                    <input v-model="tempGrid.uri" class="w-full border p-2 rounded-lg text-xs bg-slate-50">
                </div>
            </div>

            <!-- åº•éƒ¨æŒ‰éˆ•ç·¨è¼¯ -->
            <div v-if="editing.type === 'button'">
                <div class="mb-3">
                    <label class="block text-xs font-bold text-gray-500 mb-1">æŒ‰éˆ•æ–‡å­—</label>
                    <input v-model="tempBtn.label" class="w-full border p-2 rounded-lg bg-slate-50">
                </div>
                <div class="mb-3">
                    <label class="block text-xs font-bold text-gray-500 mb-1">æŒ‰éˆ•é¡è‰²</label>
                    <div class="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border">
                        <input type="color" v-model="tempBtn.color" class="h-8 w-12 cursor-pointer">
                        <span class="text-xs text-gray-500 font-mono">{{ tempBtn.color }}</span>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="block text-xs font-bold text-gray-500 mb-1">é€£çµ (URL)</label>
                    <input v-model="tempBtn.uri" class="w-full border p-2 rounded-lg text-xs bg-slate-50">
                </div>
            </div>

            <div class="flex gap-2 pt-2">
                <button @click="editing.show = false" class="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors">å–æ¶ˆ</button>
                <button @click="confirmEdit" class="flex-1 py-3 text-white font-bold bg-green-600 rounded-xl hover:bg-green-700 transition-colors shadow-lg shadow-green-200">ç¢ºå®šä¿®æ”¹</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, onMounted } = Vue;
const workerUrl = "https://lineoa.fangwl591021.workers.dev";

createApp({
    setup() {
        const loading = ref(true);
        const saving = ref(false);
        const userId = ref('');
        const isLoaded = ref(false);
        
        // é è¨­è³‡æ–™ (èˆ‡ backend.gs ä¸€è‡´)
        const card = ref({
            name: 'è¼‰å…¥ä¸­...',
            desc: '...',
            headImg: 'https://via.placeholder.com/100',
            heroImg: 'https://aiwe.cc/wp-content/uploads/2026/02/57490900246d39710f4e3dda991c0d60.png',
            grids: [
                { emoji: 'ğŸ¤–', label: 'AI è«®è©¢', uri: 'https://line.me' },
                { emoji: 'ğŸ¥', label: 'å¯¦ç¸¾æ¡ˆä¾‹', uri: 'https://line.me' },
                { emoji: 'ğŸ§¾', label: 'æœå‹™é …ç›®', uri: 'https://line.me' },
                { emoji: 'ğŸ“', label: 'é ç´„é¢è«‡', uri: 'https://line.me' }
            ],
            footerBtns: [
                { label: 'ğŸš€ ç«‹å³å•Ÿå‹• AI åˆä½œ', color: '#C9A24D', uri: 'https://line.me' },
                { label: 'ğŸ“¤ æ¨è–¦çµ¦å¥½å‹', color: '#2A2C31', uri: 'https://line.me' } 
            ]
        });

        const editing = ref({ show: false, type: '', key: '', title: '' });
        const tempValue = ref('');
        const tempGrid = ref({});
        const tempBtn = ref({});

        const initLiff = async () => {
            try {
                await liff.init({ liffId: "2008924519-1qRqocsa" });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                userId.value = profile.userId;
                fetchUserData(profile.userId);
            } catch (e) {
                console.error(e);
                // æ¸¬è©¦ç’°å¢ƒ fallback
                // fetchUserData('TEST_USER'); 
                loading.value = false;
                isLoaded.value = true;
            }
        };

        const fetchUserData = async (uid) => {
            try {
                const res = await fetch(workerUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getUserData', userId: uid })
                });
                const result = await res.json();
                
                if (result.status === 'success' && result.data) {
                    const d = result.data;
                    // å„ªå…ˆä½¿ç”¨ cardJson è£¡çš„å®Œæ•´è¨­å®š
                    if (d.cardJson && d.cardJson.length > 10) {
                        try {
                            const saved = JSON.parse(d.cardJson);
                            if (saved.name) {
                                card.value = saved;
                            } else {
                                useDefaultData(d);
                            }
                        } catch(e) {
                            useDefaultData(d);
                        }
                    } else {
                        useDefaultData(d);
                    }
                } else {
                    // å…¨æ–°ç”¨æˆ¶ï¼Œä½¿ç”¨ Profile é è¨­å€¼
                    liff.getProfile().then(p => {
                        useDefaultData({ displayName: p.displayName, statusMessage: p.statusMessage, pictureUrl: p.pictureUrl });
                    }).catch(() => {
                        useDefaultData({ displayName: 'è¨ªå®¢', statusMessage: 'æ­¡è¿è¯ç¹«', pictureUrl: 'https://via.placeholder.com/150' });
                    });
                }
            } catch (e) {
                console.error("Fetch Error:", e);
                alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
            } finally {
                loading.value = false;
                isLoaded.value = true;
            }
        };

        const useDefaultData = (d) => {
            card.value.name = d.displayName || 'ä½¿ç”¨è€…';
            card.value.desc = d.statusMessage || 'æ­¡è¿è¯ç¹«';
            card.value.headImg = d.pictureUrl || 'https://via.placeholder.com/150';
            // Hero åœ–ç‰‡ä¿æŒé è¨­
        };

        const openEdit = (type, key, title) => {
            editing.value = { show: true, type, key, title };
            if (type === 'text' || type === 'image') {
                tempValue.value = card.value[key];
            } else if (type === 'grid') {
                tempGrid.value = { ...card.value.grids[key] };
            } else if (type === 'button') {
                tempBtn.value = { ...card.value.footerBtns[key] };
            }
        };

        const confirmEdit = () => {
            const { type, key } = editing.value;
            if (type === 'text' || type === 'image') {
                card.value[key] = tempValue.value;
            } else if (type === 'grid') {
                card.value.grids[key] = { ...tempGrid.value };
            } else if (type === 'button') {
                card.value.footerBtns[key] = { ...tempBtn.value };
            }
            editing.value.show = false;
        };

        const saveCard = async () => {
            saving.value = true;
            try {
                const payload = {
                    action: 'saveUserCard',
                    userId: userId.value,
                    cardJson: JSON.stringify(card.value),
                    displayName: card.value.name,       
                    statusMessage: card.value.desc,     
                    pictureUrl: card.value.headImg      
                };
                const res = await fetch(workerUrl, { method: 'POST', body: JSON.stringify(payload) });
                const result = await res.json();
                if (result.status === 'success') {
                    alert("âœ… åç‰‡è¨­å®šå·²æ›´æ–°ï¼\nè«‹é‡æ–°è¼¸å…¥ã€Œé¡¯ç¤ºåç‰‡ã€æŸ¥çœ‹çµæœã€‚");
                    liff.closeWindow();
                } else {
                    alert("å„²å­˜å¤±æ•—");
                }
            } catch (e) {
                alert("é€£ç·šéŒ¯èª¤");
            } finally {
                saving.value = false;
            }
        };

        onMounted(() => {
            initLiff();
        });

        return { loading, saving, card, editing, tempValue, tempGrid, tempBtn, openEdit, confirmEdit, saveCard, isLoaded };
    }
}).mount('#app');
</script>
</body>
</html>
