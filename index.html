<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLEX Hub Pro - 專業管理平台 (v1.6.3)</title>
    <!-- 
      PRODUCTION NOTE: 
      目前使用瀏覽器端 Babel 轉換器僅供開發/快速部署使用。
      若為正式大規模環境，建議使用 Babel CLI 進行預編譯以優化效能。
    -->
    <!-- 核心庫載入 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f5f7; margin: 0; overflow: hidden; color: #000000; }
        
        .sidebar-item-active {
            background-color: #ffffff !important;
            color: #06C755 !important;
            font-weight: 900;
            border-right: 6px solid #06C755;
        }

        .line-sidebar {
            background-color: #F4F5F7;
            border-right: 2px solid #E5E7EB;
        }

        .iframe-container {
            width: 100%;
            height: 100%;
            border: none;
            background: #fff;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #06C755;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #000000; border-radius: 10px; }

        .drawer-transition { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .overlay-loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); display: flex; align-items: center;
            justify-content: center; z-index: 9999; backdrop-filter: blur(4px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // 版本號
        const APP_VERSION = "v1.6.3";

        // 部署網址 - 已更正為完整網址
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxunc0QG56K7n878tFFpZRksNQNwKo0wjwgpj1FYykY52kyu6jXIMcsoU0nAGp5KsMy/exec"; 

        // --- 圖示系統 ---
        const Icon = ({ name, className = "w-4 h-4" }) => {
            const icons = {
                user: <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />,
                plus: <React.Fragment><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></React.Fragment>,
                save: <React.Fragment><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></React.Fragment>,
                code: <React.Fragment><polyline points="16 18 22 12 16 6" /><polyline points="8 6 2 12 8 18" /></React.Fragment>,
                left: <polyline points="15 18 9 12 15 6" />,
                chevronDown: <polyline points="6 9 12 15 18 9" />,
                chevronRight: <polyline points="9 18 15 12 9 6" />,
                tool: <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />,
                clock: <React.Fragment><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></React.Fragment>,
                shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
                search: <React.Fragment><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></React.Fragment>,
                copy: <React.Fragment><rect x="9" y="9" width="13" height="13" rx="2" ry="2" /><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" /></React.Fragment>,
                check: <polyline points="20 6 9 17 4 12" />,
                film: <React.Fragment><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18" /><line x1="7" y1="2" x2="7" y2="22" /><line x1="17" y1="2" x2="17" y2="22" /><line x1="2" y1="12" x2="22" y2="12" /><line x1="2" y1="7" x2="7" y2="7" /><line x1="2" y1="17" x2="7" y2="17" /><line x1="17" y1="17" x2="22" y2="17" /><line x1="17" y1="7" x2="22" y2="7" /></React.Fragment>,
                image: <React.Fragment><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><circle cx="8.5" cy="8.5" r="1.5" /><polyline points="21 15 16 10 5 21" /></React.Fragment>,
                alert: <React.Fragment><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></React.Fragment>,
                trash: <React.Fragment><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></React.Fragment>,
                download: <React.Fragment><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></React.Fragment>
            };
            const pathData = icons[name] || null;
            return <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{pathData}</svg>;
        };

        const CopyButton = ({ text, label }) => {
            const [copied, setCopied] = useState(false);
            const handleCopy = () => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus(); textArea.select();
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                if (successful) {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                }
            };
            return (
                <button onClick={handleCopy} className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-black border-2 transition-all shadow-sm ${copied ? 'bg-green-100 border-green-600 text-green-700' : 'bg-white border-black text-black hover:bg-slate-100'}`}>
                    <Icon name={copied ? "check" : "copy"} className="w-4 h-4" />
                    <span>{copied ? "已完成複製" : label}</span>
                </button>
            );
        };

        const RegisterView = ({ userId, onRegister, lineName }) => {
            const [formData, setFormData] = useState({ name: lineName || "", phone: "", company: "" });
            const [loading, setLoading] = useState(false);
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50 p-6 text-black font-black">
                    <div className="bg-white p-12 rounded-[3rem] shadow-2xl max-w-md w-full border-4 border-black">
                        <div className="text-center mb-10">
                            <h2 className="text-3xl font-black uppercase tracking-tighter">Account Setup</h2>
                            <p className="text-black text-base mt-2">請完成註冊並聯繫管理員開通權限</p>
                        </div>
                        <div className="space-y-6">
                            <div className="space-y-1"><label className="text-xs uppercase text-black font-black tracking-widest">UserID</label><div className="bg-slate-100 p-4 rounded-2xl border-2 border-slate-200 text-[10px] font-mono truncate text-black select-all italic">{userId}</div></div>
                            <input type="text" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} className="w-full p-5 border-2 border-black rounded-2xl outline-none focus:ring-4 focus:ring-green-100 text-black text-lg font-black" placeholder="您的姓名" />
                            <input type="tel" value={formData.phone} onChange={e=>setFormData({...formData, phone: e.target.value})} className="w-full p-5 border-2 border-black rounded-2xl outline-none focus:ring-4 focus:ring-green-100 text-black text-lg font-black" placeholder="電話號碼" />
                            <input type="text" value={formData.company} onChange={e=>setFormData({...formData, company: e.target.value})} className="w-full p-5 border-2 border-black rounded-2xl outline-none focus:ring-4 focus:ring-green-100 text-black text-lg font-black" placeholder="公司或單位名稱" />
                            <button onClick={()=>{setLoading(true); onRegister(formData);}} disabled={loading} className="w-full bg-[#06C755] text-white py-5 rounded-2xl font-black text-xl shadow-xl active:scale-95 transition-all">提交開發申請</button>
                        </div>
                    </div>
                </div>
            );
        };

        const DirectoryView = ({ projectName, files, onAdd, onEdit, onDelete, isAdmin }) => (
            <div className="p-10 h-full overflow-y-auto custom-scrollbar animate-in fade-in duration-300 text-black">
                <div className="flex justify-between items-end border-b-4 border-black pb-8 mb-10">
                    <div>
                        <h2 className="text-3xl font-black flex items-center gap-3 text-black">
                            {projectName} 
                            {isAdmin && <span className="text-xs bg-black text-white px-3 py-1 rounded-full font-black uppercase tracking-tighter">System Admin</span>}
                        </h2>
                        <p className="text-black text-base mt-2 font-black italic">雲端試算表數據中心 (18wWVBER...)</p>
                    </div>
                    <button onClick={onAdd} className="bg-[#06C755] text-white px-8 py-4 rounded-xl font-black text-lg flex items-center gap-3 active:scale-95 transition-all shadow-xl hover:bg-[#05b34c] border-2 border-black"><Icon name="plus" className="w-6 h-6" /> 建立新設計專案</button>
                </div>
                <div className="bg-white border-4 border-black rounded-[2rem] overflow-hidden shadow-2xl">
                    <table className="w-full text-left text-black font-black">
                        <thead className="bg-slate-100 border-b-4 border-black text-black font-black uppercase text-base">
                            <tr><th className="p-6">專案設計名稱</th>{isAdmin && <th className="p-6 text-center">擁有者 UID</th>}<th className="p-6 text-center">內容狀態</th><th className="p-6 text-right">管理操作</th></tr>
                        </thead>
                        <tbody className="divide-y-2 divide-slate-200">
                            {files.length === 0 ? <tr><td colSpan="4" className="p-20 text-center text-black italic font-black text-xl opacity-20">目前試算表中尚無任何活動存檔</td></tr> : files.map(f => (
                                <tr key={f.id} className="hover:bg-slate-50 transition-colors">
                                    <td className="p-6 font-black text-2xl text-black">{f.name}</td>
                                    {isAdmin && <td className="p-6 text-center text-[10px] font-mono text-black truncate max-w-[120px] italic">{f.userId}</td>}
                                    <td className="p-6 text-center"><span className={`px-4 py-2 rounded-full text-xs font-black border-2 ${f.content ? 'bg-green-100 text-green-800 border-green-600' : 'bg-slate-200 text-black border-black'}`}>{f.content ? '✓ 代碼已同步' : '○ 空白存檔'}</span></td>
                                    <td className="p-6 text-right space-x-8">
                                        <button onClick={()=>onEdit(f)} className="text-blue-700 font-black hover:underline text-xl">編輯內容</button>
                                        <button onClick={()=>onDelete(f.id)} className="text-red-600 hover:text-red-800 transition-all active:scale-75" title="永久刪除此存檔"><Icon name="trash" className="w-8 h-8" /></button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        );

        const VoomScraperView = () => {
            const [url, setUrl] = useState('');
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const handleAnalyze = async () => {
                if(!url) return; setLoading(true); setResult(null);
                try {
                    const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                    const data = await res.json();
                    const html = data.contents;
                    const vMatch = html.match(/<meta property="og:video" content="([^"]+)"/);
                    const iMatch = html.match(/<meta property="og:image" content="([^"]+)"/);
                    if (vMatch) {
                        const vUrl = vMatch[1].replace(/&amp;/g, '&');
                        const iUrl = iMatch ? iMatch[1].replace(/&amp;/g, '&') : '';
                        setResult({ videoUrl: vUrl, imageUrl: iUrl });
                    }
                } catch(e) {} finally { setLoading(false); }
            };
            return (
                <div className="p-12 max-w-2xl mx-auto animate-in fade-in duration-300 font-black text-black">
                    <header className="mb-10 text-center font-black"><h1 className="text-4xl uppercase tracking-tighter border-b-4 border-black inline-block pb-2">VOOM Parser Engine</h1></header>
                    <div className="bg-white rounded-[2.5rem] shadow-2xl p-10 border-4 border-black space-y-8">
                        <input value={url} onChange={e=>setUrl(e.target.value)} type="text" placeholder="貼上 LINE VOOM 連結..." className="w-full p-5 border-4 border-black rounded-2xl outline-none focus:ring-8 focus:ring-green-50 font-black text-black text-lg" />
                        <button onClick={handleAnalyze} className="w-full py-5 bg-[#06C755] text-white rounded-2xl font-black text-xl active:scale-95 transition-all shadow-xl border-2 border-black">啟動深度解析</button>
                        {result && (
                            <div className="space-y-6 pt-8 border-t-4 border-slate-100">
                                <div className="flex justify-between items-center p-6 bg-slate-50 rounded-2xl border-2 border-black text-black">
                                    <span className="text-base font-black uppercase tracking-widest">Video Stream</span>
                                    <CopyButton text={result.videoUrl} label="複製影片連結" />
                                </div>
                                <div className="flex justify-between items-center p-6 bg-slate-50 rounded-2xl border-2 border-black text-black">
                                    <span className="text-base font-black uppercase tracking-widest">Cover Asset</span>
                                    <CopyButton text={result.imageUrl} label="複製圖片連結" />
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const EditorView = ({ file, onSave, onCancel, projectUrl }) => {
            const [localName, setLocalName] = useState("");
            const [localJson, setLocalJson] = useState("");
            const [showJson, setShowJson] = useState(false);
            const [syncStatus, setSyncStatus] = useState("idle");

            useEffect(() => {
                if (file) {
                    setLocalName(file.name || "新設計專案");
                    setLocalJson(file.content || "");
                    if (!file.content) setShowJson(true);
                }
            }, [file.id, file.content, file.name]);

            const handleSyncLocal = () => {
                setSyncStatus("synced");
                setTimeout(() => setSyncStatus("idle"), 2500);
            };

            return (
                <div className="h-full flex flex-col bg-white overflow-hidden relative animate-in fade-in duration-300 font-black text-black">
                    <div className="h-20 border-b-4 border-black px-8 flex items-center justify-between shrink-0 bg-white z-20 shadow-md font-black text-black">
                        <div className="flex items-center gap-6 flex-1">
                            <button onClick={onCancel} className="text-black hover:text-red-600 transition-all active:scale-75" title="返回列表"><Icon name="left" className="w-8 h-8" /></button>
                            <div className="flex flex-col">
                                <span className="text-[10px] uppercase tracking-[0.2em] text-slate-500 font-black leading-none mb-1">Project Identifier</span>
                                <input type="text" value={localName} onChange={e=>setLocalName(e.target.value)} className="bg-transparent border-none p-0 text-black font-black outline-none focus:text-[#06C755] text-2xl w-full max-w-sm transition-all" placeholder="請輸入專案名稱..." />
                            </div>
                        </div>
                        <div className="flex items-center gap-6 font-black">
                            <button onClick={()=>setShowJson(!showJson)} className={`p-3 rounded-xl border-4 transition-all shadow-lg ${showJson ? 'bg-blue-600 border-black text-white' : 'text-black border-black bg-white hover:bg-slate-50'}`} title="打開 JSON 代碼同步區">
                                <Icon name="code" className="w-6 h-6" />
                            </button>
                            <button onClick={()=>onSave(file.id, localName, localJson)} className="bg-[#06C755] text-white px-8 py-4 rounded-xl font-black text-lg flex items-center gap-3 active:scale-95 transition-all shadow-xl border-2 border-black">
                                <Icon name="save" className="w-6 h-6" /> 儲存至試算表
                            </button>
                        </div>
                    </div>
                    <div className="flex-1 flex relative overflow-hidden text-black">
                        <div className={`absolute right-0 top-0 bottom-0 w-[30rem] bg-slate-900 border-l-4 border-black z-30 shadow-2xl p-8 flex flex-col gap-6 drawer-transition ${showJson ? 'translate-x-0' : 'translate-x-full'}`}>
                            <div className="flex justify-between items-center text-white font-black text-lg uppercase tracking-tighter">
                                <span className="flex items-center gap-3 text-green-400 font-black uppercase"><Icon name="code" className="w-6 h-6"/>Sync Buffer</span>
                                <button onClick={()=>setShowJson(false)} className="text-white hover:text-red-500 transition-colors"><Icon name="x" className="w-6 h-6" /></button>
                            </div>
                            <p className="text-sm text-slate-400 font-bold leading-relaxed border-l-4 border-blue-500 pl-4">1. 左側完成設計 → 2. 複製工具 JSON → 3. 貼入下方 → 4. 點擊同步更新。</p>
                            <textarea 
                                value={localJson} 
                                onChange={e=>setLocalJson(e.target.value)} 
                                className="flex-1 w-full bg-slate-950 border-2 border-slate-700 rounded-2xl p-6 font-mono text-[12px] text-green-400 outline-none custom-scrollbar leading-relaxed shadow-inner" 
                                placeholder='請在此貼入您的設計 JSON 代碼...'
                            />
                            <button 
                                onClick={handleSyncLocal}
                                className={`w-full py-5 rounded-2xl text-base font-black uppercase shadow-2xl border-2 border-black transition-all ${syncStatus === 'synced' ? 'bg-green-600 text-white' : 'bg-blue-600 text-white hover:bg-blue-500'}`}
                            >
                                {syncStatus === 'synced' ? '✓ 代碼同步成功 (請點右上儲存)' : '確認同步代碼更新'}
                            </button>
                        </div>
                        <iframe src={projectUrl} className="iframe-container" allow="clipboard-read; clipboard-write"></iframe>
                    </div>
                </div>
            );
        };

        const App = () => {
            const PROJECTS = {
                ECOMMERCE: { id: 'ECOMMERCE', name: "電商商品版", url: "https://fangwl591021.github.io/line-flex-images/", parent: 'MSG' },
                PERSONAL: { id: 'PERSONAL', name: "個人名片版", url: "https://fangwl591021.github.io/name/", parent: 'MSG' },
                VOOM: { id: 'VOOM', name: "VOOM 解析器", parent: 'TOOL' }
            };

            const [viewState, setViewState] = useState('LOADING'); 
            const [isGlobalLoading, setIsGlobalLoading] = useState(false);
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [activeLevel2, setActiveLevel2] = useState('ECOMMERCE');
            const [activeFile, setActiveFile] = useState(null);
            const [userFiles, setUserFiles] = useState([]);
            const [expandedCategories, setExpandedCategories] = useState({ MSG: true, TOOL: true });
            const [isCopying, setIsCopying] = useState(false);

            const refreshFiles = async (uid, role) => {
                try {
                    const isAdmin = role === '系統管理員';
                    const res = await fetch(`${GAS_URL}?userId=${uid}&action=getFiles&role=${isAdmin ? 'ADMIN' : 'USER'}`);
                    const data = await res.json();
                    setUserFiles(data || []);
                } catch(e) {}
            };

            useEffect(() => {
                const init = async () => {
                    try {
                        await liff.init({ liffId: "2008541971-XPIDtaaj" });
                        if (!liff.isLoggedIn()) { setViewState('LOGIN'); return; }
                        const lp = await liff.getProfile();
                        setUser({ uid: lp.userId, displayName: lp.displayName });

                        const response = await fetch(`${GAS_URL}?userId=${lp.userId}&action=checkStatus`);
                        const gasData = await response.json();

                        if (gasData.status === 'NOT_FOUND') { setViewState('REGISTER'); }
                        else if (!gasData.endDate) { setViewState('PENDING'); setProfile(gasData); }
                        else if (new Date() > new Date(gasData.endDate)) { setProfile(gasData); setViewState('EXPIRED'); }
                        else {
                            setProfile(gasData);
                            await refreshFiles(lp.userId, gasData.role);
                            setViewState('MAIN');
                        }
                    } catch (e) { setViewState('LOGIN'); }
                };
                init();
            }, []);

            const handleRegister = async (data) => {
                await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ ...data, userId: user.uid, action: 'register' }) });
                setViewState('PENDING');
            };

            const handleSave = async (id, name, content) => {
                setIsGlobalLoading(true);
                try {
                    const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'saveFile', userId: user.uid, id, name, content }) });
                    const result = await res.json();
                    if(result.success) {
                        await refreshFiles(user.uid, profile.role);
                        setActiveFile(null);
                    }
                } catch (e) { alert("試算表寫入失敗，請檢查權限"); }
                finally { setIsGlobalLoading(false); }
            };

            const handleDelete = async (id) => {
                if(!confirm("警告：確定要永久刪除此存檔？此動作無法復原。")) return;
                setIsGlobalLoading(true);
                try {
                    const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteFile', userId: user.uid, id }) });
                    const result = await res.json();
                    if(result.success) {
                        await refreshFiles(user.uid, profile.role);
                    }
                } catch (e) {}
                finally { setIsGlobalLoading(false); }
            };

            const copyAppSourceCode = () => {
                const source = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
                const textArea = document.createElement("textarea");
                textArea.value = source;
                textArea.style.position = "fixed"; textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus(); textArea.select();
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                if (successful) {
                    setIsCopying(true);
                    setTimeout(() => setIsCopying(false), 3000);
                }
            };

            if (viewState === 'LOADING') return <div className="h-screen w-screen flex items-center justify-center bg-white text-black font-black text-xl"><div className="loader mr-6"></div>系統安全連線中...</div>;
            if (viewState === 'LOGIN') return <div className="h-screen w-screen flex items-center justify-center bg-slate-50 font-black"><button onClick={()=>liff.login()} className="bg-[#06C755] text-white px-16 py-6 rounded-2xl font-black text-2xl shadow-2xl active:scale-95 transition-all border-4 border-black">LINE 登入並啟用開發權限</button></div>;
            if (viewState === 'REGISTER') return <RegisterView userId={user?.uid} lineName={user?.displayName} onRegister={handleRegister} />;
            if (viewState === 'PENDING') return <div className="h-screen w-screen flex flex-col items-center justify-center bg-white p-12 text-center font-black animate-in zoom-in duration-500 text-black border-8 border-black"><Icon name="clock" className="w-24 h-24 mb-10 text-blue-600 animate-pulse" /><h1 className="text-4xl font-black mb-4">帳戶權限審核中</h1><p className="text-xl font-black mb-10">資料已傳送至試算表，請聯繫管理員開通。</p><div className="bg-slate-100 p-6 rounded-3xl border-4 border-black font-mono text-xs select-all">UID: {user?.uid}</div></div>;
            if (viewState === 'EXPIRED') return <div className="h-screen w-screen flex flex-col items-center justify-center bg-slate-900 text-white text-center p-12 font-black border-[1rem] border-red-600"><Icon name="lock" className="w-24 h-24 mb-10 text-red-600" /><h1 className="text-5xl font-black uppercase tracking-widest mb-6">Service Expired</h1><p className="text-2xl font-black opacity-80">授權已於 {new Date(profile?.endDate).toLocaleDateString()} 截止。</p></div>;

            const currentProject = PROJECTS[activeLevel2];

            return (
                <div className="flex h-screen w-screen overflow-hidden text-black bg-[#f4f5f7] font-black">
                    {isGlobalLoading && <div className="overlay-loading font-black flex flex-col gap-6 text-black italic text-2xl"><div className="loader w-16 h-16"></div>正在同步雲端資料庫...</div>}
                    <aside className="w-72 line-sidebar flex flex-col shrink-0 border-r-4 border-black">
                        <div className="h-20 flex flex-col justify-center px-8 border-b-4 border-black bg-white shadow-md z-10">
                            <span className="font-black text-[#06C755] text-2xl uppercase italic tracking-tighter leading-none mb-1">Flex Hub OA</span>
                            <span className="text-[10px] text-black font-black tracking-[0.3em] opacity-40 leading-none">{APP_VERSION}</span>
                        </div>
                        <nav className="flex-1 overflow-y-auto custom-scrollbar pt-6 text-black font-black">
                            <div className="mb-6">
                                <button onClick={()=>setExpandedCategories(p=>({...p, MSG: !p.MSG}))} className="w-full flex items-center justify-between px-8 py-5 text-xs font-black text-black uppercase tracking-[0.2em] hover:bg-white transition-colors border-l-8 border-transparent">
                                    <span>專案項目管理</span><Icon name={expandedCategories.MSG ? "chevronDown" : "chevronRight"} className="w-5 h-5 text-black" />
                                </button>
                                {expandedCategories.MSG && (
                                    <div className="animate-in fade-in duration-200">
                                        {['ECOMMERCE', 'PERSONAL'].map(key => (
                                            <button key={key} onClick={()=>{setActiveLevel2(key); setActiveFile(null);}} className={`w-full text-left px-12 py-5 text-base transition-all border-r-8 ${activeLevel2 === key && !activeFile ? 'sidebar-item-active' : 'hover:bg-white border-transparent text-black font-black opacity-60 hover:opacity-100'}`}>{PROJECTS[key].name}</button>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <div className="mt-4 border-t-2 border-slate-200 pt-4 text-black font-black">
                                <button onClick={()=>setExpandedCategories(p=>({...p, TOOL: !p.TOOL}))} className="w-full flex items-center justify-between px-8 py-5 text-xs font-black text-black uppercase tracking-[0.2em] hover:bg-white transition-colors border-l-8 border-transparent">
                                    <span>自動化工具模組</span><Icon name={expandedCategories.TOOL ? "chevronDown" : "chevronRight"} className="w-5 h-5 text-black" />
                                </button>
                                {expandedCategories.TOOL && (
                                    <button key="VOOM" onClick={()=>{setActiveLevel2('VOOM'); setActiveFile(null);}} className={`w-full text-left px-12 py-5 text-base transition-all border-r-8 ${activeLevel2 === 'VOOM' && !activeFile ? 'sidebar-item-active' : 'hover:bg-white border-transparent text-black font-black opacity-60 hover:opacity-100'}`}>VOOM 解析核心</button>
                                )}
                            </div>
                        </nav>

                        <div className="px-6 py-6 border-t-4 border-black bg-white">
                            <button 
                                onClick={copyAppSourceCode}
                                className={`w-full flex items-center justify-center gap-3 py-4 rounded-2xl border-4 transition-all active:scale-95 shadow-lg ${isCopying ? 'bg-green-600 border-black text-white' : 'bg-black border-black text-white hover:bg-slate-800'}`}
                            >
                                <Icon name={isCopying ? "check" : "download"} className="w-5 h-5" />
                                <span className="text-xs font-black uppercase tracking-widest">{isCopying ? "代碼已複製到剪貼簿" : "複製全系統原始碼"}</span>
                            </button>
                        </div>

                        <div className="p-6 border-t-4 border-black bg-[#06C755] flex items-center gap-4 shadow-inner text-white font-black">
                            <div className="p-2 bg-white rounded-full text-black border-2 border-black shadow-xl"><Icon name={profile?.role === '系統管理員' ? "shield" : "user"} className="w-6 h-6" /></div>
                            <div className="overflow-hidden min-w-0 font-black">
                                <div className="text-sm truncate flex items-center gap-2 font-black uppercase tracking-tight">
                                    {profile?.name} 
                                    {profile?.role === '系統管理員' && <span className="text-[8px] bg-black text-white px-2 py-0.5 rounded border border-white">ADMIN</span>}
                                </div>
                                <div className="text-[10px] font-black tracking-tighter mt-1 italic border-t border-white/30 pt-1">EXP: {profile?.endDate ? new Date(profile.endDate).toLocaleDateString() : '--'}</div>
                            </div>
                        </div>
                    </aside>
                    <main className="flex-1 bg-white relative overflow-hidden flex flex-col shadow-inner">
                        {activeFile ? (
                            <EditorView file={activeFile} onSave={handleSave} onCancel={() => setActiveFile(null)} projectUrl={currentProject.url} />
                        ) : activeLevel2 === 'VOOM' ? (
                            <VoomScraperView key="voom-view-v1" />
                        ) : (
                            <DirectoryView projectName={currentProject.name} files={userFiles} onAdd={()=>setActiveFile({id:Date.now(), name:"新設計專案", content:""})} onEdit={f=>setActiveFile(f)} onDelete={handleDelete} isAdmin={profile?.role === '系統管理員'} />
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
