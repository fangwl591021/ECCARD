<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLEX Hub Pro - 發送修復版 (v2.6.3)</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f5f7; margin: 0; overflow: hidden; color: #000; font-weight: 700; }
        .sidebar-item-active { background-color: #ffffff !important; color: #06C755 !important; border-right: 6px solid #06C755; font-weight: 900; }
        .line-sidebar { background-color: #F4F5F7; border-right: 1px solid #E5E7EB; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; display: flex; flex-direction: column; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #06C755; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { position: fixed; top: 25px; left: 50%; transform: translateX(-50%); background: #000; color: white; padding: 16px 32px; border-radius: 16px; z-index: 10000; font-weight: 900; box-shadow: 0 20px 40px rgba(0,0,0,0.5); border: 2px solid #06C755; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { top: -60px; opacity: 0; } to { top: 25px; opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, Fragment } = React;
        const LIFF_ID = "2008541971-XPIDtaaj";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzIwDiSspAT03CePvj3oGkb05uFjYo2TzhR-zLu1iLA51f9pXsrG_gXyGYilq384SMF/exec"; 

        const PROJECTS = [
            { id: 'CAROUSEL_PRO', name: "專業多頁型卡片", url: "./tool-carousel-pro.html", icon: 'layers' },
            { id: 'PERSONAL', name: "單頁名片版", url: "./tool-personal.html", icon: 'user' }
        ];

        const App = () => {
            const [viewState, setViewState] = useState('LOADING'); 
            const [user, setUser] = useState(null);
            const [activeModuleId, setActiveModuleId] = useState('CAROUSEL_PRO');
            const [activeFile, setActiveFile] = useState(null);
            const [userFiles, setUserFiles] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [toast, setToast] = useState(null);
            const [currentJson, setCurrentJson] = useState("");
            const iframeRef = useRef(null);

            const showMsg = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };
            const refreshFiles = async (uid) => { try { const res = await fetch(`${GAS_URL}?userId=${uid}&action=getFiles`); setUserFiles(await res.json() || []); } catch (e) { setUserFiles([]); } };

            useEffect(() => {
                const init = async () => {
                    try {
                        await liff.init({ liffId: LIFF_ID });
                        if (!liff.isLoggedIn()) { setViewState('LOGIN'); return; }
                        const lp = await liff.getProfile();
                        setUser({ uid: lp.userId, displayName: lp.displayName });
                        await refreshFiles(lp.userId); setViewState('MAIN');
                    } catch (e) { setViewState('LOGIN'); }
                };
                init();
            }, []);

            useEffect(() => {
                const handleMessage = (e) => {
                    if (e.data?.type === 'SYNC_FLEX_DATA') { setCurrentJson(e.data.json); }
                    if (e.data?.type === 'CHILD_READY' && activeFile && iframeRef.current) {
                        iframeRef.current.contentWindow.postMessage({ type: 'LOAD_FLEX_DATA', json: activeFile.content }, '*');
                    }
                };
                window.addEventListener('message', handleMessage);
                return () => window.removeEventListener('message', handleMessage);
            }, [activeFile]);

            const handleSend = async () => {
                if (!currentJson) return;
                try {
                    const data = JSON.parse(currentJson);
                    const altText = data.altText || "數位名片";
                    
                    // 關鍵修正：深拷貝並刪除所有非 LINE 官方欄位
                    const flexPayload = JSON.parse(JSON.stringify(data));
                    delete flexPayload.altText;
                    delete flexPayload._pages; // 刪除多頁原始數據
                    delete flexPayload.pages; 

                    if (!liff.isLoggedIn()) { liff.login(); return; }
                    const res = await liff.shareTargetPicker([{ type: "flex", altText, contents: flexPayload }]);
                    if (res) showMsg("✅ 發送成功！");
                } catch (e) { alert("❌ 發送失敗：" + e.message); }
            };

            const handleSave = async () => {
                if (!activeFile) return;
                setIsLoading(true);
                try {
                    const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'saveFile', userId: user.uid, id: activeFile.id, name: activeFile.name || "未命名", content: currentJson }) });
                    if ((await res.json()).success) { showMsg("✅ 儲存成功！"); await refreshFiles(user.uid); }
                } catch (e) { showMsg("❌ 儲存失敗"); }
                setIsLoading(false);
            };

            if (viewState === 'LOADING') return <div className="h-screen w-screen flex flex-col items-center justify-center bg-white font-black italic animate-pulse">載入中...</div>;
            if (viewState === 'LOGIN') return <div className="h-screen w-screen flex items-center justify-center bg-slate-50 font-black"><button onClick={()=>liff.login()} className="bg-[#06C755] text-white px-12 py-5 rounded-3xl font-black shadow-2xl">進入系統</button></div>;

            const currentProject = PROJECTS.find(i => i.id === activeModuleId);

            return (
                <div className="flex h-screen w-screen overflow-hidden text-black bg-[#f4f5f7] font-black">
                    {isLoading && <div className="fixed inset-0 bg-white/80 z-[10001] flex items-center justify-center font-black">數據處理中...</div>}
                    {toast && <div className="toast">{toast}</div>}
                    <aside className="line-sidebar border-r border-slate-300 w-72">
                        <div className="h-24 flex items-center px-8 border-b border-slate-300 bg-white shrink-0"><span className="font-black text-[#06C755] text-2xl uppercase italic leading-none">FLEX HUB PRO</span></div>
                        <nav className="flex-1 pt-6 px-3">
                            {PROJECTS.map(item => (
                                <button key={item.id} onClick={()=>{setActiveModuleId(item.id); setActiveFile(null);}} className={`w-full flex items-center px-6 py-4 gap-4 rounded-2xl transition-all ${activeModuleId === item.id && !activeFile ? 'sidebar-item-active' : 'hover:bg-white text-slate-500'}`}>
                                    <span className="text-sm font-black">{item.name}</span>
                                </button>
                            ))}
                        </nav>
                    </aside>
                    <main className="flex-1 bg-white relative flex flex-col">
                        {activeFile ? (
                            <div className="h-full flex flex-col">
                                <div className="h-24 border-b flex items-center px-10 justify-between bg-white shadow-md z-10">
                                    <button onClick={()=>setActiveFile(null)} className="font-black text-black text-lg">← 返回</button>
                                    <input type="text" value={activeFile.name} onChange={e=>setActiveFile({...activeFile, name: e.target.value})} className="bg-slate-100 border-2 border-black rounded-2xl px-6 py-3 font-black text-center max-w-xl mx-8 outline-none text-xl" />
                                    <div className="flex gap-4"><button onClick={handleSend} className="bg-[#06C755] text-white px-8 py-3 rounded-xl font-black">發送</button><button onClick={handleSave} className="bg-black text-white px-8 py-3 rounded-xl font-black">儲存</button></div>
                                </div>
                                <iframe ref={iframeRef} src={currentProject.url} className="flex-1 border-none"></iframe>
                            </div>
                        ) : (
                            <div className="p-12 h-full overflow-y-auto font-black"><div className="flex justify-between items-end border-b-4 border-slate-100 pb-8 mb-10"><h2 className="text-4xl font-black uppercase text-slate-800">{currentProject.name}</h2><button onClick={()=>setActiveFile({id: String(Date.now()), name:"", content: null})} className="bg-[#06C755] text-white px-10 py-5 rounded-[25px] font-black text-lg shadow-2xl">＋ 建立新設計</button></div><div className="bg-white border-2 border-slate-100 rounded-[40px] overflow-hidden shadow-2xl"><table className="w-full text-left font-black"><thead className="bg-slate-50 border-b-2 border-slate-100 text-slate-400 uppercase text-xs tracking-widest"><tr><th className="p-8">專案名稱</th><th className="p-8 text-center">操作</th></tr></thead><tbody className="divide-y-2 divide-slate-50">{userFiles.map(f => (<tr key={String(f.id)} className="hover:bg-slate-50/50"><td className="p-8 text-xl font-black">{f.name}</td><td className="p-8 text-center"><button onClick={()=>setActiveFile(f)} className="text-[#06C755] font-black text-lg mr-10 italic">Edit</button><button onClick={async ()=>{if(!confirm("確定刪除？")) return; setIsLoading(true); await fetch(GAS_URL, { method:'POST', body:JSON.stringify({action:'deleteFile', userId:user.uid, id:String(f.id)})}); await refreshFiles(user.uid); setIsLoading(false); }} className="text-red-500 font-black">Delete</button></td></tr>))}</tbody></table></div></div>
                        )}
                    </main>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>
